<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cc12138's blog</title><meta name="author" content="Ccai"><meta name="copyright" content="Ccai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="Cc12138&#39;s blog">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Cc12138&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/WangFei2.jpg">
<meta property="article:author" content="Ccai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/WangFei2.jpg"><link rel="shortcut icon" href="/img/rose.png"><link rel="canonical" href="http://example.com/page/7/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cc12138\'s blog',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2025-02-05 16:44:50'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/WangFei2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">71</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Cc12138's blog"><span class="site-name">Cc12138's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Cc12138's blog</h1><div id="site_social_icons"><a class="social-icon" href="https://github.com/0xcc12138" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/Windows%E5%86%85%E6%A0%B85_%E5%AE%89%E5%85%A8%E9%80%9A%E4%BF%A1/" title="Windows内核（5）——安全通讯">Windows内核（5）——安全通讯</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-14T11:45:00.000Z" title="发表于 2024-07-14 19:45:00">2024-07-14</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-02-05T03:06:01.250Z" title="更新于 2025-02-05 11:06:01">2025-02-05</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Windows%E5%86%85%E6%A0%B8/">Windows内核</a></span></div><div class="content">Windows内核安全通讯乱写Ring3的代码让Ring0崩掉？？？
例如Ring3给Ring0传一个地址，然后Ring0去访问这块内存，内核直接读写用户内存地址，就会造成系统崩溃。
那么如何去预防？
1.禁止内核直接访问用户层的内存地址（这能避免大部分漏洞）
非要用要保证：1.检查三环地址是否有效（ProbeRead&#x2F;ProbeWrite）2.保证进程不产生切换（严格检测）
但是不访问三环地址，很难进行通讯
微软就提供了通讯方式（解决缓冲区安全问题）
1.缓冲区方式
2.直接方式
3.其他方式（直接读写用户层的内存地址 Irp-&gt;UserBuffer就是直接读写用户层地址，这个很危险）
如何设置？
在创建设备完，要设置缓冲区通讯方式，如果不设置，默认用其他方式，也就是直接访问用户层的内存地址：

设置DEVICE_OBJECT结构体里面的Flags，有缓冲区通讯和直接通讯
12345678910status = IoCreateDevice(        DriverObject,                // 驱动程序对象        0,         ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/Windows%E5%86%85%E6%A0%B84(R0,R3%E9%80%9A%E8%AE%AF%EF%BC%8C%E4%BA%A4%E6%8D%A2%E6%95%B0%E6%8D%AE)/" title="Windows内核（4）——R0,R3通讯，交换数据">Windows内核（4）——R0,R3通讯，交换数据</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-13T14:22:00.000Z" title="发表于 2024-07-13 22:22:00">2024-07-13</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-02-03T01:43:44.470Z" title="更新于 2025-02-03 09:43:44">2025-02-03</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Windows%E5%86%85%E6%A0%B8/">Windows内核</a></span></div><div class="content">Windows内核Windows 组件概述调用例如CreateFile这个NTDll的API，这个API会进入0环，在0环里面找到相关的服务，将信息先传给IO Mgr，被打包为IRP，然后传递给驱动，等待驱动完成请求，处理完以后，才将结果返回给Ring3

WriteFile &#x3D;&gt; ntdll.dll &#x3D;&gt; kernel &#x3D;&gt;  I&#x2F;O Manager &#x3D;&gt; AllocIrp &#x3D;&gt; Driver
一些介绍 IoCompleteRequest 是 Windows 内核模式驱动程序开发中的一个关键函数，用于完成 I&#x2F;O 请求并通知 I&#x2F;O 管理器和请求的发起者（通常是用户模式应用程序或其他内核模式组件）操作已经完成。这个函数会更新 IRP（I&#x2F;O 请求包）的状态，并根据请求的优先级和完成状态触发相应的后续操作。 
1234VOID IoCompleteRequest(  _Inout_ PIRP Irp,  _In_    CCHAR PriorityBoost);

使 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/Windows%E5%86%85%E6%A0%B83(%E6%89%8B%E6%90%93%E9%A9%B1%E5%8A%A8%E5%8A%A0%E8%BD%BD%E5%99%A8)/" title="Windows内核（3）——手搓驱动加载器">Windows内核（3）——手搓驱动加载器</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-11T15:08:00.000Z" title="发表于 2024-07-11 23:08:00">2024-07-11</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-11T15:08:00.000Z" title="更新于 2024-07-11 23:08:00">2024-07-11</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Windows%E5%86%85%E6%A0%B8/">Windows内核</a></span></div><div class="content">Windows内核ntoskrnl.exe杂记驱动也是一个PE文件，类似于DLL，DriverEntry类似于DllMain
多了一个INIT节

用IDA打开一个驱动程序：

发现使用到的函数都是来自一个库，叫做ntoskrnl，

发现貌似是一个exe文件，我们用IDA打开看看
ntoskrnl.exe 是 Windows 操作系统的内核映像，简称为 NT Kernel (Windows NT Kernel Image)。它是 Windows 内核的核心部分，负责多种关键任务和系统服务
发现导出函数都在这个EXE的导出表里面

说明，逆向内核就相当于逆向这个exe程序
做一个驱动加载工具目标：尝试做一个驱动加载工具
自行写一个驱动的安装，启动，关闭，卸载

PrintErrorMessage这个函数能够自动根据错误码输出错误内容
12345678910111213141516171819202122void PrintErrorMessage(DWORD errorCode)&#123;	LPVOID lpMsgBuf;	FormatMessage(		FORMAT_MESSAGE ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/Windows%E5%86%85%E6%A0%B82(IRP%E4%BB%8B%E7%BB%8D&amp;%E5%AE%9E%E7%8E%B0Ring0%E4%B8%8ERing3%E4%BA%A4%E4%BA%92)/" title="Windows内核（2）——IRP介绍&amp;实现Ring0与Ring3交互">Windows内核（2）——IRP介绍&amp;实现Ring0与Ring3交互</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-10T15:18:00.000Z" title="发表于 2024-07-10 23:18:00">2024-07-10</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-10T15:18:00.000Z" title="更新于 2024-07-10 23:18:00">2024-07-10</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Windows%E5%86%85%E6%A0%B8/">Windows内核</a></span></div><div class="content">Windows内核2IRP(I&#x2F;O Request Package)IRP是什么从概念上讲IRP类似于windows应用程序的消息。我们知道在windows中应用程序是由消息驱动的。
IRP的全名是I&#x2F;O Request Package，即输入输出请求包，它是Windows内核中的一种非常重要的数据结构。上层应用程序与底层驱动程序通信时，应用程序会发出I&#x2F;O请求，操作系统将相应的I&#x2F;O请求转换成相应的IRP，不同的IRP会根据类型被分派到不同的派遣例程中进行处理。
 与IRP相关的几个常用的事件 



驱动层
功能解释
对应于应用层



IRP_MJ_CREATE
请求一个句柄
CreateFile


IRP_MJ_CLOSE
关闭句柄
CloseHandle


IRP_MJ_READ
从设备得到数据
ReadFile


IRP_MJ_WRITE
传送数据到设备
WriteFile


IRP_MJ_DEVICE_CONTROL
控制操作利用IOCTL宏
DeviceIoControl


 这几个IRP事件放在MajorFunctio ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/Windows%E5%86%85%E6%A0%B81(%E5%86%85%E6%A0%B8%E5%88%9D%E6%8E%A2&amp;%E7%BC%96%E5%86%99%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F)/" title="Windows内核（1）——内核初探&amp;编写第一个驱动程序">Windows内核（1）——内核初探&amp;编写第一个驱动程序</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-10T02:05:00.000Z" title="发表于 2024-07-10 10:05:00">2024-07-10</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-10T02:05:00.000Z" title="更新于 2024-07-10 10:05:00">2024-07-10</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Windows%E5%86%85%E6%A0%B8/">Windows内核</a></span></div><div class="content">Windows内核内核杂记内核（Kernel）
安全角度：Rootkit，漏洞利用，病毒

 Rootkit（也称隐匿软件[1]）是指主要为隐藏其他程序进程的软件，可能是一种或以上软件的组合；广义而言，Rootkit也可视为一项技术。今天，Rootkit一词更多指伪装成驱动程序加载到操作系统内核中的恶意软件，其代码在特权模式运行，能造成意外危险。 

三种模式CPU的三种模式：

实模式（Real Mode）

实模式是x86处理器的初始模式，也是最早期的处理模式。在实模式下，CPU的特性和限制主要包括：

地址空间：只有20位地址总线，因此可以访问的物理内存最多为1MB。
段式内存管理：内存地址通过段寄存器和偏移量组合计算，例如，地址由段寄存器（16位）乘以16再加上偏移量（16位）组成。
无内存保护：没有内存保护机制，任何程序可以访问所有内存区域，包括操作系统和硬件设备的内存。
简单的中断处理：中断向量表固定在内存地址0x0000到0x03FF之间。


保护模式（Protected Mode）

保护模式是x86处理器的一种增强模式，提供了更强大的内存管理和保护功能。保护模式的主 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/cmd%E7%AE%A1%E9%81%93%E9%80%9A%E8%AE%AF%E5%88%86%E6%9E%90/" title="用管道将cmd.exe信息输出到窗口代码分析">用管道将cmd.exe信息输出到窗口代码分析</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-09T09:01:52.000Z" title="发表于 2024-07-09 17:01:52">2024-07-09</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-09T09:01:52.000Z" title="更新于 2024-07-09 17:01:52">2024-07-09</time></span></div><div class="content">用管道将cmd.exe信息输出到窗口12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182void CParentDlg::OnBnClickedButton3()&#123;	//创建管道	SECURITY_ATTRIBUTES sa = &#123;&#125;;	sa.nLength = sizeof(sa);	sa.bInheritHandle = TRUE;	::CreatePipe(&amp;m_hSelfRead, &amp;m_hCmdWrite, &amp;sa, 0);			::CreatePipe(&amp;m_hCmdRead, &amp;m_hSelfWrite, &amp;sa, 0);	//创建子进程	STARTUPINFO si = &#123;&#125;;	si.cb = sizeof(si);	s ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/x64%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%88%86%E6%9E%90(%E6%96%B0%E6%97%A7%E7%89%88%E6%9C%AC)/" title="X64异常分析(新旧版本)">X64异常分析(新旧版本)</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-09T03:17:00.000Z" title="发表于 2024-07-09 11:17:00">2024-07-09</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-09T03:17:00.000Z" title="更新于 2024-07-09 11:17:00">2024-07-09</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/x64%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/">x64异常分析</a></span></div><div class="content">X64逆向异常分析旧版本64位异常处理：
在x64的异常处理中，VS编译器不再采用在函数中注册SEH完成异常处理的方式，而是将异常信息存放在PE文件中的一个.pdata节中

在32位的情况下，想要找Funcinfo可以通过一个函数的开局 有一个   
1offset __ehhandler$_main


双击点进去可以看到CxxFrameHanlder的其中一个参数unk_41B2C4，这个就是FuncInfo

但是在64位，我们在函数开头貌似并没有看到
1offset __ehhandler$_main





ThrowInfo我们只能找到CxxThrowException这个函数，然后找到pThrowInfo，然后找到ThrowInfo这个结构体

我们点进去发现，最后一个参数是一个RVA参数，为什么要用RVA呢？
原因是因为这样可以支持随机基址，拿到正确的地址的话，就可以直接通过随机基地址加上这个RVA即可

但是每次都要自己手动计算RVA转换为正确的地址，难免有些繁琐，所以我们在结构体定义的时候，就可以自己加上ImageBase，变成正确的地址：

可以看到快捷键是C ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/x64%E9%80%86%E5%90%91/" title="X64逆向">X64逆向</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-01T13:24:52.000Z" title="发表于 2024-07-01 21:24:52">2024-07-01</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-01T13:24:52.000Z" title="更新于 2024-07-01 21:24:52">2024-07-01</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/x64%E9%80%86%E5%90%91/">x64逆向</a></span></div><div class="content">X64逆向64位相比于32位的优势：
更大的地址空间：64位系统可以访问的内存地址空间比32位系统大得多。具体来说，32位系统最多可以使用4GB的内存（2^32字节），而64位系统则可以使用高达16EB（2^64字节）的内存。这对于需要大量内存的应用程序，如大型数据库、视频编辑软件和虚拟化应用程序等，尤为重要。
更高的性能：在某些情况下，64位程序可以利用更多的寄存器和更宽的数据路径，从而提高性能。例如，64位处理器可以一次性处理更大的整数和浮点数，这对于科学计算、加密和多媒体处理等任务有显著的性能提升。
增强的安全性：64位系统通常包含更多的安全功能，例如硬件层面的地址空间布局随机化（ASLR）和数据执行保护（DEP）。这些功能可以帮助防范某些类型的攻击，如缓冲区溢出攻击。
兼容性和未来性：随着技术的发展，越来越多的软件和操作系统开始只支持64位版本。使用64位程序可以确保更好的兼容性和未来的支持，因为软件和硬件供应商将逐渐减少对32位系统的支持。
更好的多任务处理能力：64位处理器在处理多任务和多线程应用程序时，表现通常优于32位处理器。这对于需要同时运行多个应用程序或处理大量并发 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/%E5%BD%A9%E8%99%B9%E7%8C%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="彩虹猫病毒分析">彩虹猫病毒分析</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-30T13:47:52.000Z" title="发表于 2024-06-30 21:47:52">2024-06-30</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-30T13:47:52.000Z" title="更新于 2024-06-30 21:47:52">2024-06-30</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/">病毒分析</a></span></div><div class="content">彩虹猫简介

彩虹猫病毒，也称为 Nyancat 病毒，是一种恶意软件，通常被归类为计算机蠕虫或恶搞病毒。其名称和特征灵感来自于流行的互联网迷因“彩虹猫”（Nyancat），这是一只带着彩虹尾巴的动画猫。
彩虹猫病毒属于MBR病毒，从功能上看，它是一款恶作剧病毒。该病毒会修改MBR主引导扇区，以此来破坏电脑的正常启动。在修改MBR后，电脑重启会停留在一个彩虹猫的画面，因此该病毒被称为是彩虹猫病毒。但该病毒没有采取隐藏或者规避查杀等技术。

感染效果：
一旦感染系统，彩虹猫病毒会修改系统文件或注册表，增加自身的启动项以确保重启后继续运行。
典型的恶搞效果是弹出彩虹猫动画，播放背景音乐，使得用户无法正常操作计算机。
病毒访问google网站和程序，使计算机变得难以使用。
确定之后，病毒就会打开很多个网页。链接指向了谷歌搜索，但是由于网络的缘故，我们不知道这个浏览器具体显示的是什么。紧接着，鼠标就会不受指控，不断抖动。还会不断弹出各种窗口铺满屏幕，有些窗口颜色会变成黑色或者褐色。




病毒初探：因为彩虹猫病毒没有采用隐藏或规避查杀技术，并且里面一堆敏感API，所以我们选择在虚拟机中操作， ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/c++%E5%BC%82%E5%B8%B8/" title="X32下的C++异常处理分析与还原">X32下的C++异常处理分析与还原</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-24T08:47:52.000Z" title="发表于 2024-06-24 16:47:52">2024-06-24</time><span class="article-meta-separator">|</span><i class="fas fa-history"></i><span class="article-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-24T08:47:52.000Z" title="更新于 2024-06-24 16:47:52">2024-06-24</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/x86%E4%B8%8B%E7%9A%84c-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">x86下的c++异常处理</a></span></div><div class="content">X32下的c++异常处理12345678910111213141516171819202122#include &lt;iostream&gt;using namespace std;int main(int argc)&#123;	try &#123;		if (argc == 1)			throw 1;	&#125;	catch (int e)	&#123;		cout &lt;&lt; &quot;catch int &quot; &lt;&lt; e &lt;&lt; endl;	&#125;	catch (...)	&#123;		cout &lt;&lt; &quot;catch all&quot; &lt;&lt; endl;	&#125;	return 0;&#125;

一旦try内的语句有抛出（throw）异常，就会去搜索对应的catch块执行语句
值得注意的是，在C++中，当一个异常被抛出时，程序会在找到第一个匹配的catch块之后处理该异常，然后继续执行后续代码。并且，一旦异常被捕获并处理，程序不会再继续搜索其他的catch块来处理同一个异常。
事件查看器介绍下 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/6/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/#content-inner">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/#content-inner">8</a><a class="extend next" rel="next" href="/page/8/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/WangFei2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ccai</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">71</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/0xcc12138" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">ROIS Team Member</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/WDF%E5%AD%A6%E4%B9%A0/" title="WDF框架学习">WDF框架学习</a><time datetime="2025-01-12T15:00:00.000Z" title="发表于 2025-01-12 23:00:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/NDIS,WFP%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4/" title="NDIS/WFP网络过滤">NDIS/WFP网络过滤</a><time datetime="2025-01-12T02:32:00.000Z" title="发表于 2025-01-12 10:32:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="病毒分析">病毒分析</a><time datetime="2025-01-06T14:11:00.000Z" title="发表于 2025-01-06 22:11:00">2025-01-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%BD%91%E7%BB%9C%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AFTDI/" title="TDI网络防火墙技术">TDI网络防火墙技术</a><time datetime="2025-01-06T03:28:00.000Z" title="发表于 2025-01-06 11:28:00">2025-01-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/ByPass_UAC/" title="ByPassUAC方法研究(持续更新)">ByPassUAC方法研究(持续更新)</a><time datetime="2024-12-31T07:00:00.000Z" title="发表于 2024-12-31 15:00:00">2024-12-31</time></div></div></div></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/x64%E9%80%86%E5%90%91/" style="font-size: 1.1em; color: #999">x64逆向</a> <a href="/tags/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" style="font-size: 1.18em; color: #999ca1">病毒分析</a> <a href="/tags/WDF%E6%A1%86%E6%9E%B6/" style="font-size: 1.1em; color: #999">WDF框架</a> <a href="/tags/Windows%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" style="font-size: 1.1em; color: #999">Windows应急响应</a> <a href="/tags/x86-C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" style="font-size: 1.1em; color: #999">x86 C++逆向分析</a> <a href="/tags/windows%E5%86%85%E6%A0%B8%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4/" style="font-size: 1.18em; color: #999ca1">windows内核网络过滤</a> <a href="/tags/%E6%96%87%E4%BB%B6%E8%BF%87%E6%BB%A4/" style="font-size: 1.1em; color: #999">文件过滤</a> <a href="/tags/CE%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 1.1em; color: #999">CE的使用</a> <a href="/tags/ETW/" style="font-size: 1.1em; color: #999">ETW</a> <a href="/tags/x86%E4%B8%8B%E7%9A%84c-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" style="font-size: 1.1em; color: #999">x86下的c++异常处理</a> <a href="/tags/Hook/" style="font-size: 1.1em; color: #999">Hook</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 1.1em; color: #999">网络编程</a> <a href="/tags/Win-x64%E5%86%85%E6%A0%B8/" style="font-size: 1.34em; color: #99a3b0">Win x64内核</a> <a href="/tags/%E6%97%A0%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5Dll%E5%99%A8%E9%A1%B9%E7%9B%AE-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8%E7%BA%BF%E7%A8%8B%E7%89%88/" style="font-size: 1.1em; color: #999">无模块注入Dll器项目(安全启动线程版)</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.1em; color: #999">数据库</a> <a href="/tags/QT/" style="font-size: 1.1em; color: #999">QT</a> <a href="/tags/PE/" style="font-size: 1.1em; color: #999">PE</a> <a href="/tags/Minifilter/" style="font-size: 1.1em; color: #999">Minifilter</a> <a href="/tags/Git%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 1.1em; color: #999">Git的使用</a> <a href="/tags/ByPassUAC/" style="font-size: 1.1em; color: #999">ByPassUAC</a> <a href="/tags/x64%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90/" style="font-size: 1.1em; color: #999">x64异常分析</a> <a href="/tags/%E5%85%8D%E6%9D%80/" style="font-size: 1.42em; color: #99a6b7">免杀</a> <a href="/tags/FPS%E8%BE%85%E5%8A%A9/" style="font-size: 1.26em; color: #999fa8">FPS辅助</a> <a href="/tags/MFC%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" style="font-size: 1.1em; color: #999">MFC逆向分析</a> <a href="/tags/%E8%BF%9C%E6%8E%A7%E5%BC%80%E5%8F%91/" style="font-size: 1.1em; color: #999">远控开发</a> <a href="/tags/c/" style="font-size: 1.1em; color: #999">c++</a> <a href="/tags/ARK%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/" style="font-size: 1.1em; color: #999">ARK工具开发</a> <a href="/tags/PWN/" style="font-size: 1.1em; color: #999">PWN</a> <a href="/tags/Windows%E5%86%85%E6%A0%B8/" style="font-size: 1.5em; color: #99a9bf">Windows内核</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><span class="card-archive-list-count">8</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><span class="card-archive-list-count">16</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><span class="card-archive-list-count">10</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><span class="card-archive-list-count">10</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><span class="card-archive-list-count">15</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><span class="card-archive-list-count">3</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">71</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2025-02-05T08:44:49.512Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Ccai</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>