<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WDF框架学习 | Cc12138's blog</title><meta name="author" content="Ccai"><meta name="copyright" content="Ccai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="WDF框架学习WDF是什么？Windows Driver Framework (WDF) 是微软提供的一套用于开发Windows设备驱动程序的框架。WDF分为两个子框架： KMDF (Kernel-Mode Driver Framework)：用于开发内核模式的驱动程序。UMDF (User-Mode Driver Framework)：用于开发用户模式的驱动程序。WDF框架简化了驱动程序开发的复">
<meta property="og:type" content="article">
<meta property="og:title" content="WDF框架学习">
<meta property="og:url" content="http://example.com/WDF%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Cc12138&#39;s blog">
<meta property="og:description" content="WDF框架学习WDF是什么？Windows Driver Framework (WDF) 是微软提供的一套用于开发Windows设备驱动程序的框架。WDF分为两个子框架： KMDF (Kernel-Mode Driver Framework)：用于开发内核模式的驱动程序。UMDF (User-Mode Driver Framework)：用于开发用户模式的驱动程序。WDF框架简化了驱动程序开发的复">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/WangFei2.jpg">
<meta property="article:published_time" content="2025-01-12T15:00:00.000Z">
<meta property="article:modified_time" content="2025-01-15T07:58:43.300Z">
<meta property="article:author" content="Ccai">
<meta property="article:tag" content="WDF框架">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/WangFei2.jpg"><link rel="shortcut icon" href="/img/rose.png"><link rel="canonical" href="http://example.com/WDF%E5%AD%A6%E4%B9%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WDF框架学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-15 15:58:43'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/WangFei2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">72</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Cc12138's blog"><span class="site-name">Cc12138's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WDF框架学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-12T15:00:00.000Z" title="发表于 2025-01-12 23:00:00">2025-01-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-15T07:58:43.300Z" title="更新于 2025-01-15 15:58:43">2025-01-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WDF框架学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WDF框架学习"><a href="#WDF框架学习" class="headerlink" title="WDF框架学习"></a>WDF框架学习</h1><h2 id="WDF是什么？"><a href="#WDF是什么？" class="headerlink" title="WDF是什么？"></a>WDF是什么？</h2><p>Windows Driver Framework (WDF) 是微软提供的一套用于开发Windows设备驱动程序的框架。WDF分为两个子框架：</p>
<p>KMDF (Kernel-Mode Driver Framework)：用于开发内核模式的驱动程序。<br>UMDF (User-Mode Driver Framework)：用于开发用户模式的驱动程序。<br>WDF框架简化了驱动程序开发的复杂性，提供了丰富的API和工具，使得开发者能够更专注于业务逻辑的实现，而不是底层驱动的细节。</p>
<p><strong>总之，将WDF理解为对WDM做了封装，类似于SDK和MFC之间的关系</strong></p>
<h2 id="第一节：第一个WFP驱动程序："><a href="#第一节：第一个WFP驱动程序：" class="headerlink" title="第一节：第一个WFP驱动程序："></a>第一节：第一个WFP驱动程序：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyDriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WDFDRIVER Driver</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Driver;</span><br><span class="line">    <span class="comment">// 释放驱动程序占用的自定义资源</span></span><br><span class="line">    <span class="comment">// 例如，释放全局变量、关闭句柄等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意：WDF 框架会自动释放 WDF 对象（如设备对象、队列对象等）</span></span><br><span class="line">    <span class="comment">// 因此不需要手动释放这些对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印调试信息（可选）</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;MyDriverUnload: Driver is being unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    WDF_DRIVER_CONFIG config;</span><br><span class="line">    WDFDRIVER driver;</span><br><span class="line">    <span class="built_in">KdBreakPoint</span>();</span><br><span class="line">    <span class="comment">// 初始化 WDF 驱动程序配置</span></span><br><span class="line">    <span class="built_in">WDF_DRIVER_CONFIG_INIT</span>(&amp;config, WDF_NO_EVENT_CALLBACK);</span><br><span class="line">    config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</span><br><span class="line">    config.EvtDriverUnload = MyDriverUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 WDF 驱动程序对象</span></span><br><span class="line">    status = <span class="built_in">WdfDriverCreate</span>(</span><br><span class="line">        DriverObject,          <span class="comment">// WDM 驱动对象</span></span><br><span class="line">        RegistryPath,          <span class="comment">// 注册表路径</span></span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES, <span class="comment">// 驱动程序属性（可选）</span></span><br><span class="line">        &amp;config,               <span class="comment">// 驱动程序配置</span></span><br><span class="line">        &amp;driver                <span class="comment">// 返回的 WDFDRIVER 句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化失败!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他初始化操作</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化成功!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="相关函数介绍"><a href="#相关函数介绍" class="headerlink" title="相关函数介绍"></a>相关函数介绍</h3><p><strong>WDF_DRIVER_CONFIG_INIT</strong></p>
<p><code>WDF_DRIVER_CONFIG_INIT</code> 是 Windows Driver Framework (WDF) 中的一个宏，用于初始化 <code>WDF_DRIVER_CONFIG</code> 结构体。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WDF_DRIVER_CONFIG</span> &#123;</span><br><span class="line">  ULONG                     Size;</span><br><span class="line">  PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd;</span><br><span class="line">  PFN_WDF_DRIVER_UNLOAD     EvtDriverUnload;</span><br><span class="line">  ULONG                     DriverInitFlags;</span><br><span class="line">  ULONG                     DriverPoolTag;</span><br><span class="line">&#125; WDF_DRIVER_CONFIG, *PWDF_DRIVER_CONFIG;</span><br></pre></td></tr></table></figure>

<p><code>EvtDriverDeviceAdd</code>作用：指定设备添加回调函数。当设备被添加到驱动程序时，WDF 框架会调用这个函数。</p>
<p><code>EvtDriverUnload</code>：指定驱动程序卸载回调函数。当驱动程序被卸载时，WDF 框架会调用这个函数。如果不需要卸载回调函数，可以设置为 NULL。并WDF 框架会自动释放 WDF 对象（如设备对象、队列对象等,因此不需要手动释放这些对象,只需要释放掉自己用到的其他对象</p>
<p><code>DriverInitFlags</code>：<br><code>WdfDriverInitNonPnpDriver</code>：表示这是一个非 PnP 驱动程序。<br><code>WdfDriverInitNoDispatchOverride</code>：表示驱动程序不会覆盖默认的调度例程。<br><code>WdfDriverInitNoFormatChaining</code>：表示驱动程序不会使用格式链。</p>
<p><code>DriverPoolTag</code>:指定驱动程序使用的内存池标签。内存池标签是一个 4 字符的标识符，用于调试和跟踪内存分配。如果不需要自定义内存池标签，可以设置为 0。</p>
<p><code>WDF_DRIVER_CONFIG</code> 是 Windows Driver Framework (WDF) 中的一个重要结构体，用于配置 WDF 驱动程序的行为和属性。它在 <code>DriverEntry</code> 函数中用于初始化驱动程序，并传递给 <code>WdfDriverCreate</code> 函数。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function">FORCEINLINE</span></span><br><span class="line"><span class="function"><span class="title">WDF_DRIVER_CONFIG_INIT</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PWDF_DRIVER_CONFIG Config,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PFN_WDF_DRIVER_DEVICE_ADD EvtDriverDeviceAdd</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br></pre></td></tr></table></figure>

<p>其中：**<code>EvtDriverDeviceAdd</code>** 如果不需要设备添加回调函数，可以传递 <code>WDF_NO_EVENT_CALLBACK</code>。</p>
<p>调用时机：当该驱动有相关设备被创建，则会调用这个<code>EvtDriverDeviceAdd</code></p>
<p><strong>WdfDriverCreate</strong></p>
<p><code>WdfDriverCreate</code> 并不是创建一个新的驱动对象，而是创建一个 WDF 驱动程序对象，并将其与现有的 <code>DriverObject</code> 关联起来，以便使用 WDF 框架的功能。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">WdfDriverCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            PDRIVER_OBJECT         DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            PCUNICODE_STRING       RegistryPath,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  PWDF_OBJECT_ATTRIBUTES DriverAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            PWDF_DRIVER_CONFIG     DriverConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] WDFDRIVER              *Driver</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>WDF_DRIVER_CONFIG</code> 是 Windows Driver Framework (WDF) 中的一个重要结构体，用于配置 WDF 驱动程序的行为和属性。它在 <code>DriverEntry</code> 函数中用于初始化驱动程序，并传递给 <code>WdfDriverCreate</code> 函数。 </p>
<p>介绍下<code>_WDF_OBJECT_ATTRIBUTES </code>结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WDF_OBJECT_ATTRIBUTES</span> &#123;</span><br><span class="line">  ULONG                          Size;</span><br><span class="line">  PFN_WDF_OBJECT_CONTEXT_CLEANUP EvtCleanupCallback;</span><br><span class="line">  PFN_WDF_OBJECT_CONTEXT_DESTROY EvtDestroyCallback;</span><br><span class="line">  WDF_EXECUTION_LEVEL            ExecutionLevel;</span><br><span class="line">  WDF_SYNCHRONIZATION_SCOPE      SynchronizationScope;</span><br><span class="line">  WDFOBJECT                      ParentObject;</span><br><span class="line">  <span class="type">size_t</span>                         ContextSizeOverride;</span><br><span class="line">  PCWDF_OBJECT_CONTEXT_TYPE_INFO ContextTypeInfo;</span><br><span class="line">&#125; WDF_OBJECT_ATTRIBUTES, *PWDF_OBJECT_ATTRIBUTES;</span><br></pre></td></tr></table></figure>

<p>其中， 如果你定义了 <code>EvtCleanupCallback</code> 和 <code>EvtDestroyCallback</code>，那么你需要在这些回调函数中手动释放与 WDF 对象相关的资源。 否则WDF框架会自动清除掉这些对象的资源</p>
<ul>
<li>**<code>EvtCleanupCallback</code>**：<ul>
<li>当 <strong>WDF 设备对象</strong> 的引用计数降为 0 时，WDF 框架会调用 <code>EvtCleanupCallback</code>。</li>
<li>此时设备对象仍然有效，开发人员可以访问对象的上下文内存和其他属性。</li>
</ul>
</li>
<li>**<code>EvtDestroyCallback</code>**：<ul>
<li>在 <code>EvtCleanupCallback</code> 执行完毕后，WDF 框架会调用 <code>EvtDestroyCallback</code>。</li>
<li>此时设备对象已经无效，开发人员不能访问对象的上下文内存或其他属性。</li>
</ul>
</li>
</ul>
<p><code>WdfObjectDereference</code>用来减少WDF设备的引用计数</p>
<h2 id="第二节：设备对象，文件操作，符号链接"><a href="#第二节：设备对象，文件操作，符号链接" class="headerlink" title="第二节：设备对象，文件操作，符号链接"></a>第二节：设备对象，文件操作，符号链接</h2><p><code>WdfControlDeviceInitAllocate</code> 是 Windows Driver Framework (WDF) 中的一个函数，用于为控制设备分配一个 <strong>WDFDEVICE_INIT</strong> 结构体。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PWDFDEVICE_INIT <span class="title">WdfControlDeviceInitAllocate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] WDFDRIVER            Driver,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">const</span> UNICODE_STRING *SDDLString</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>SDDLString</code>:举个例子<code>SDDL_DEVOBJ_SYS_ALL_ADM_RWX_WORLD_RWX_RES_RWX</code> 定义了以下权限：</p>
<ul>
<li><strong>系统（SY）</strong>：完全访问。</li>
<li><strong>管理员组（BA）</strong>：完全访问。</li>
<li><strong>所有用户（WD）</strong>：完全访问。</li>
<li><strong>受限代码（RC）</strong>：完全访问。</li>
</ul>
<p><code>WdfDeviceInitAssignName</code> 是 Windows 驱动程序框架（WDF）中的一个函数，用于为设备对象分配一个名称。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">WdfDeviceInitAssignName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PWDFDEVICE_INIT  DeviceInit,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PCUNICODE_STRING DeviceName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>





<p><strong>设备对象中的驱动程序框架文件对象（WDFFILEOBJECT）</strong> 可以理解为<strong>内核驱动程序与应用层通信的桥梁</strong>。它在 WDF（Windows 驱动程序框架）中扮演了非常重要的角色，主要用于管理与设备对象相关的用户模式句柄和上下文数据。 </p>
<p><strong>WDF_FILEOBJECT_CONFIG_INIT</strong> 函数初始化驱动程序<code>WDF_FILEOBJECT_CONFIG</code>结构。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WDF_FILEOBJECT_CONFIG_INIT</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]          PWDF_FILEOBJECT_CONFIG     FileEventCallbacks,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PFN_WDF_DEVICE_FILE_CREATE EvtDeviceFileCreate,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PFN_WDF_FILE_CLOSE         EvtFileClose,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PFN_WDF_FILE_CLEANUP       EvtFileCleanup</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>当用户模式应用程序调用 <code>CreateFile</code> 或内核模式组件调用 <code>ZwCreateFile</code> 时， WDF 会触发 <code>EvtDeviceFileCreate</code></p>
<p>用户模式应用程序调用 <code>CloseHandle</code> 或内核模式组件调用 <code>ZwClose</code> 时，WDF 会触发<code>EvtWdfFileCleanup</code>。 </p>
<p>当文件对象完全关闭时，驱动程序的 <code>EvtWdfFileClose</code> 被调用。</p>
<p><strong>WdfDeviceInitSetFileObjectConfig</strong> </p>
<p>该方法注册事件回调函数并设置驱动程序框架文件对象的配置信息。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WdfDeviceInitSetFileObjectConfig</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PWDFDEVICE_INIT        DeviceInit,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PWDF_FILEOBJECT_CONFIG FileObjectConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PWDF_OBJECT_ATTRIBUTES FileObjectAttributes</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>



<p><strong>完整代码：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sddl.h&gt;</span>        <span class="comment">// SDDL 相关定义</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EVT_WDF_DEVICE_FILE_CREATE EvtWdfDeviceFileCreate;</span><br><span class="line">EVT_WDF_FILE_CLOSE EvtWdfFileClose;</span><br><span class="line">EVT_WDF_FILE_CLEANUP EvtWdfFileCleanup;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfDeviceFileCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDEVICE Device,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Device;</span><br><span class="line">    Request;</span><br><span class="line">    FileObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyDriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WDFDRIVER Driver</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Driver;</span><br><span class="line">    <span class="comment">// 释放驱动程序占用的自定义资源</span></span><br><span class="line">    <span class="comment">// 例如，释放全局变量、关闭句柄等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意：WDF 框架会自动释放 WDF 对象（如设备对象、队列对象等）</span></span><br><span class="line">    <span class="comment">// 因此不需要手动释放这些对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印调试信息（可选）</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;MyDriverUnload: Driver is being unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status; <span class="comment">//状态</span></span><br><span class="line">    WDF_DRIVER_CONFIG config;  <span class="comment">//WDF驱动配置</span></span><br><span class="line">    WDFDRIVER driver;  <span class="comment">//WDF驱动对象</span></span><br><span class="line">    WDFDEVICE Device;   <span class="comment">//WDF设备对象</span></span><br><span class="line">    PWDFDEVICE_INIT DeviceInit; <span class="comment">//初始化设备对象的创建过程</span></span><br><span class="line">    UNICODE_STRING DeviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\Device\\HelloWDF&quot;</span>);  <span class="comment">//设备对象的名字</span></span><br><span class="line">    UNICODE_STRING SymbolicLinkName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\??\\HelloWDF&quot;</span>);  <span class="comment">//</span></span><br><span class="line">    WDF_FILEOBJECT_CONFIG FileConfig;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">KdBreakPoint</span>();</span><br><span class="line">    <span class="comment">// 初始化 WDF 驱动程序配置</span></span><br><span class="line">    <span class="built_in">WDF_DRIVER_CONFIG_INIT</span>(&amp;config, WDF_NO_EVENT_CALLBACK);</span><br><span class="line">    config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</span><br><span class="line">    config.EvtDriverUnload = MyDriverUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 WDF 驱动程序对象</span></span><br><span class="line">    status = <span class="built_in">WdfDriverCreate</span>(</span><br><span class="line">        DriverObject,          <span class="comment">// WDM 驱动对象</span></span><br><span class="line">        RegistryPath,          <span class="comment">// 注册表路径</span></span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES, <span class="comment">// 驱动程序属性（可选）</span></span><br><span class="line">        &amp;config,               <span class="comment">// 驱动程序配置</span></span><br><span class="line">        &amp;driver                <span class="comment">// 返回的 WDFDRIVER 句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DeviceInit = <span class="built_in">WdfControlDeviceInitAllocate</span>(driver,&amp;SDDL_DEVOBJ_SYS_ALL_ADM_RWX_WORLD_RWX_RES_RWX);</span><br><span class="line">    <span class="keyword">if</span> (DeviceInit == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status=<span class="built_in">WdfDeviceInitAssignName</span>(DeviceInit, &amp;DeviceName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备分配失败！\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//WDF_FILEOBJECT_CONFIG_INIT 函数初始化驱动程序WDF_FILEOBJECT_CONFIG结构</span></span><br><span class="line">    <span class="built_in">WDF_FILEOBJECT_CONFIG_INIT</span>(&amp;FileConfig, EvtWdfDeviceFileCreate, EvtWdfFileClose, EvtWdfFileCleanup);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//WdfDeviceInitSetFileObjectConfig 方法注册事件回调函数并设置驱动程序框架文件对象的配置信息。</span></span><br><span class="line">    <span class="built_in">WdfDeviceInitSetFileObjectConfig</span>(DeviceInit, &amp;FileConfig, WDF_NO_OBJECT_ATTRIBUTES);</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">WdfDeviceCreate</span>(&amp;DeviceInit,WDF_NO_OBJECT_ATTRIBUTES,&amp;Device);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    status = <span class="built_in">WdfDeviceCreateSymbolicLink</span>(Device, &amp;SymbolicLinkName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;符号链接创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WdfControlFinishInitializing</span>(Device);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他初始化操作</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化成功!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">End:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化失败!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>总结</strong></p>
<ul>
<li>**<code>DriverEntry</code>**：驱动程序的入口函数，负责初始化驱动程序。</li>
<li>**<code>WdfDriverCreate</code>**：创建 WDF 驱动程序对象。</li>
<li>**<code>WdfControlDeviceInitAllocate</code>**：分配设备初始化结构。</li>
<li>**<code>WdfDeviceInitAssignName</code>**：设置设备名称。</li>
<li>**<code>WDF_FILEOBJECT_CONFIG_INIT</code>**：初始化文件对象配置。</li>
<li>**<code>WdfDeviceInitSetFileObjectConfig</code>**：设置文件对象配置。</li>
<li>**<code>WdfDeviceCreate</code>**：创建设备对象。</li>
<li>**<code>WdfDeviceCreateSymbolicLink</code>**：创建符号链接。</li>
<li>**<code>WdfControlFinishInitializing</code>**：完成设备初始化。</li>
</ul>
<h2 id="第三节：编写应用程序访问WDF驱动"><a href="#第三节：编写应用程序访问WDF驱动" class="headerlink" title="第三节：编写应用程序访问WDF驱动"></a>第三节：编写应用程序访问WDF驱动</h2><p>在第二节，我们写了对于文件的三个回调，分别是以下三个</p>
<p>当然要说明： 文件对象的回调函数（如 <code>EvtWdfDeviceFileCreate</code>、<code>EvtWdfFileClose</code> 和 <code>EvtWdfFileCleanup</code>）主要用于管理文件对象的生命周期，而不是直接处理 I&#x2F;O 请求（如 <code>ReadFile</code> 和 <code>WriteFile</code>）。WDF 使用<strong>队列</strong>（Queue）机制来处理 I&#x2F;O 请求，而不是像 WDM 那样直接通过回调函数处理。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfDeviceFileCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDEVICE Device,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中，Create回调里面有一个Request，这个我们必须处理它</p>
<p>处理的方式还是比较多的，例如</p>
<p><strong>1.直接完成请求：</strong>(当然你也可以验证资质)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接完成请求</span></span><br><span class="line"><span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br></pre></td></tr></table></figure>



<p><strong>2.初始化文件对象上下文</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取文件对象的上下文数据</span></span><br><span class="line">PFILE_CONTEXT fileContext = <span class="built_in">FileObjectGetContext</span>(FileObject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化上下文数据</span></span><br><span class="line">fileContext-&gt;Buffer = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="number">1024</span>, <span class="string">&#x27;BufT&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (fileContext-&gt;Buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">   <span class="built_in">WdfRequestComplete</span>(Request,STATUS_INSUFFICIENT_RESOURCES);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 完成请求</span></span><br><span class="line"><span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br></pre></td></tr></table></figure>



<p><strong>3.异步完成请求</strong>： 如果设备对象的打开操作需要较长时间（例如等待某个资源），可以将请求标记为挂起，并在操作完成后异步完成请求。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfDeviceFileCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDEVICE Device,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(Device);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(FileObject);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将请求标记为挂起</span></span><br><span class="line">    <span class="built_in">WdfRequestMarkPending</span>(Request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步完成请求（例如在某个工作线程中）</span></span><br><span class="line">    <span class="built_in">MyAsyncOpenDevice</span>(Request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyAsyncOpenDevice</span><span class="params">(WDFREQUEST Request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟异步操作</span></span><br><span class="line">    <span class="built_in">KeDelayExecutionThread</span>(KernelMode, FALSE, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成请求</span></span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>用<code>winobj</code>可以看到全局的符号链接：</p>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736737321105.png" alt="1736737321105"></p>
<p>直接在应用层去访问这个设备</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\\\.\\HelloWDF&quot;</span>  <span class="comment">// 设备的符号链接名称</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    HANDLE hDevice = INVALID_HANDLE_VALUE;</span><br><span class="line">    BOOL result = FALSE;</span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开设备</span></span><br><span class="line">    hDevice = <span class="built_in">CreateFile</span>(</span><br><span class="line">        DEVICE_NAME,                     <span class="comment">// 设备名称</span></span><br><span class="line">        GENERIC_READ | GENERIC_WRITE,    <span class="comment">// 访问权限</span></span><br><span class="line">        <span class="number">0</span>,                               <span class="comment">// 共享模式（0 表示独占）</span></span><br><span class="line">        <span class="literal">NULL</span>,                            <span class="comment">// 安全属性</span></span><br><span class="line">        OPEN_EXISTING,                   <span class="comment">// 创建选项</span></span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,           <span class="comment">// 文件属性</span></span><br><span class="line">        <span class="literal">NULL</span>                             <span class="comment">// 模板文件句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到成功断下来了</p>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736737692878.png" alt="1736737692878"></p>
<h2 id="第四节：实现WDF的IO队列"><a href="#第四节：实现WDF的IO队列" class="headerlink" title="第四节：实现WDF的IO队列"></a>第四节：实现WDF的IO队列</h2><p>本节将实现对文件设备的控制操作</p>
<p>首先我们先建立一个IO队列的配置</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WDF_IO_QUEUE_CONFIG       ioConfig</span><br></pre></td></tr></table></figure>



<p>然后用<code>WDF_IO_QUEUE_CONFIG_INIT</code>来初始化这个ioConfig</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WDF_IO_QUEUE_CONFIG_INIT</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PWDF_IO_QUEUE_CONFIG       Config,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  WDF_IO_QUEUE_DISPATCH_TYPE DispatchType</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中 DispatchType枚举值是这样的</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>WdfIoQueueDispatchInvalid</code></strong></td>
<td align="left">无效的分发类型（仅用于内部验证）。</td>
</tr>
<tr>
<td align="left"><strong><code>WdfIoQueueDispatchSequential</code></strong></td>
<td align="left">顺序分发：I&#x2F;O 请求按顺序处理，一次只处理一个请求。</td>
</tr>
<tr>
<td align="left"><strong><code>WdfIoQueueDispatchParallel</code></strong></td>
<td align="left">并行分发：I&#x2F;O 请求可以同时处理，适用于高性能场景。</td>
</tr>
<tr>
<td align="left"><strong><code>WdfIoQueueDispatchManual</code></strong></td>
<td align="left">手动分发：驱动程序需要手动从队列中取出请求并处理。</td>
</tr>
<tr>
<td align="left"><strong><code>WdfIoQueueDispatchMax</code></strong></td>
<td align="left">枚举的最大值（仅用于内部验证）。</td>
</tr>
</tbody></table>
<p>在<code>_WDF_IO_QUEUE_CONFIG</code>结构中，我们可以发现很多WDM熟悉的东西，例如READ,WRITE,IO_DEVICE_CONTROL，这就是对应的回调函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_WDF_IO_QUEUE_CONFIG</span> &#123;</span><br><span class="line">  ULONG                                       Size;</span><br><span class="line">  WDF_IO_QUEUE_DISPATCH_TYPE                  DispatchType;</span><br><span class="line">  WDF_TRI_STATE                               PowerManaged;</span><br><span class="line">  BOOLEAN                                     AllowZeroLengthRequests;</span><br><span class="line">  BOOLEAN                                     DefaultQueue;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_DEFAULT                 EvtIoDefault;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_READ                    EvtIoRead;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_WRITE                   EvtIoWrite;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_DEVICE_CONTROL          EvtIoDeviceControl;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_INTERNAL_DEVICE_CONTROL EvtIoInternalDeviceControl;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_STOP                    EvtIoStop;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_RESUME                  EvtIoResume;</span><br><span class="line">  PFN_WDF_IO_QUEUE_IO_CANCELED_ON_QUEUE       EvtIoCanceledOnQueue;</span><br><span class="line">  <span class="keyword">union</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">      ULONG NumberOfPresentedRequests;</span><br><span class="line">    &#125; Parallel;</span><br><span class="line">  &#125; Settings;</span><br><span class="line">  WDFDRIVER                                   Driver;</span><br><span class="line">&#125; WDF_IO_QUEUE_CONFIG, *PWDF_IO_QUEUE_CONFIG;</span><br></pre></td></tr></table></figure>



<p>这里做一个表格帮助理解</p>
<table>
<thead>
<tr>
<th><strong>WDF 回调函数</strong></th>
<th><strong>对应三环 API</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>EvtIoDefault</code></td>
<td>无直接对应</td>
<td>默认处理逻辑，覆盖未分类的请求。</td>
</tr>
<tr>
<td><code>EvtIoRead</code></td>
<td>ReadFile<code>, </code>ReadFileEx</td>
<td>处理读请求。</td>
</tr>
<tr>
<td><code>EvtIoWrite</code></td>
<td><code>WriteFile</code>, <code>WriteFileEx</code></td>
<td>处理写请求。</td>
</tr>
<tr>
<td><code>EvtIoDeviceControl</code></td>
<td><code>DeviceIoControl</code></td>
<td>处理用户模式的 IOCTL 请求。</td>
</tr>
<tr>
<td><code>EvtIoInternalDeviceControl</code></td>
<td>无直接对应</td>
<td>处理内核模式的 IOCTL 请求。</td>
</tr>
<tr>
<td><code>EvtIoStop</code></td>
<td>无直接对应</td>
<td>恢复队列请求</td>
</tr>
<tr>
<td><code>EvtIoResume</code></td>
<td>无直接对应</td>
<td>恢复队列请求</td>
</tr>
<tr>
<td><code>EvtIoCanceledOnQueue</code></td>
<td><code>CancelIo</code>, <code>CancelIoEx</code></td>
<td>用户取消队列中未完成的请求时调用。</td>
</tr>
</tbody></table>
<p><strong>总结一下顺序</strong></p>
<ol>
<li><strong>设备初始化</strong>：<ul>
<li>调用 <code>WdfDeviceInitAllocate</code> 或 <code>WdfControlDeviceInitAllocate</code> 分配并初始化 <code>WDFDEVICE_INIT</code> 结构。</li>
<li>设置设备属性（如设备名称、安全描述符等）。</li>
</ul>
</li>
<li><strong>文件对象配置初始化</strong>：<ul>
<li>使用 <code>WDF_FILEOBJECT_CONFIG_INIT</code> 初始化 <code>WDF_FILEOBJECT_CONFIG</code> 结构。</li>
<li>设置文件对象的回调函数（如 <code>EvtWdfDeviceFileCreate</code>、<code>EvtWdfFileClose</code> 等）。</li>
</ul>
</li>
<li><strong>设置文件对象配置</strong>：<ul>
<li>调用 <code>WdfDeviceInitSetFileObjectConfig</code> 将文件对象配置与设备初始化结构关联。</li>
</ul>
</li>
<li><strong>创建设备对象</strong>：<ul>
<li>调用 <code>WdfDeviceCreate</code> 创建设备对象。</li>
</ul>
</li>
<li><strong>创建 I&#x2F;O 队列</strong>：<ul>
<li>在设备对象创建成功后，调用 <code>WdfIoQueueCreate</code> 创建 I&#x2F;O 队列。</li>
</ul>
</li>
<li><strong>完成设备创建</strong><br><strong>WdfControlFinishInitializing(Device);</strong></li>
</ol>
<p>本节完整驱动程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sddl.h&gt;</span>        <span class="comment">// SDDL 相关定义</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EVT_WDF_DEVICE_FILE_CREATE EvtWdfDeviceFileCreate;</span><br><span class="line">EVT_WDF_FILE_CLOSE EvtWdfFileClose;</span><br><span class="line">EVT_WDF_FILE_CLEANUP EvtWdfFileCleanup;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFQUEUE Queue,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> OutputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG IoControlCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Queue;</span><br><span class="line">    Request;</span><br><span class="line">    OutputBufferLength;</span><br><span class="line">    InputBufferLength;</span><br><span class="line">    IoControlCode;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;IO_DEVICE_CONTROL\n&quot;</span>);</span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;clean_up\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;close\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfDeviceFileCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDEVICE Device,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Device;</span><br><span class="line">    Request;</span><br><span class="line">    FileObject;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;file_create\n&quot;</span>);</span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyDriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WDFDRIVER Driver</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Driver;</span><br><span class="line">    <span class="comment">// 释放驱动程序占用的自定义资源</span></span><br><span class="line">    <span class="comment">// 例如，释放全局变量、关闭句柄等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意：WDF 框架会自动释放 WDF 对象（如设备对象、队列对象等）</span></span><br><span class="line">    <span class="comment">// 因此不需要手动释放这些对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印调试信息（可选）</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;MyDriverUnload: Driver is being unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status; <span class="comment">//状态</span></span><br><span class="line">    WDF_DRIVER_CONFIG config;  <span class="comment">//WDF驱动配置</span></span><br><span class="line">    WDFDRIVER driver;  <span class="comment">//WDF驱动对象</span></span><br><span class="line">    WDFDEVICE Device;   <span class="comment">//WDF设备对象</span></span><br><span class="line">    PWDFDEVICE_INIT DeviceInit; <span class="comment">//初始化设备对象的创建过程</span></span><br><span class="line">    UNICODE_STRING DeviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\Device\\HelloWDF&quot;</span>);  <span class="comment">//设备对象的名字</span></span><br><span class="line">    UNICODE_STRING SymbolicLinkName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\??\\HelloWDF&quot;</span>);  <span class="comment">//</span></span><br><span class="line">    WDF_FILEOBJECT_CONFIG FileConfig;  <span class="comment">//文件对象的配置信息</span></span><br><span class="line">    WDF_IO_QUEUE_CONFIG ioConfig; <span class="comment">//IO队列的配置信息</span></span><br><span class="line">    WDFQUEUE Queue; <span class="comment">//这是IO队列句柄</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">KdBreakPoint</span>();</span><br><span class="line">    <span class="comment">// 初始化 WDF 驱动程序配置</span></span><br><span class="line">    <span class="built_in">WDF_DRIVER_CONFIG_INIT</span>(&amp;config, WDF_NO_EVENT_CALLBACK);</span><br><span class="line">    config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</span><br><span class="line">    config.EvtDriverUnload = MyDriverUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 WDF 驱动程序对象</span></span><br><span class="line">    status = <span class="built_in">WdfDriverCreate</span>(</span><br><span class="line">        DriverObject,          <span class="comment">// WDM 驱动对象</span></span><br><span class="line">        RegistryPath,          <span class="comment">// 注册表路径</span></span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES, <span class="comment">// 驱动程序属性（可选）</span></span><br><span class="line">        &amp;config,               <span class="comment">// 驱动程序配置</span></span><br><span class="line">        &amp;driver                <span class="comment">// 返回的 WDFDRIVER 句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DeviceInit = <span class="built_in">WdfControlDeviceInitAllocate</span>(driver,&amp;SDDL_DEVOBJ_SYS_ALL_ADM_RWX_WORLD_RWX_RES_RWX);</span><br><span class="line">    <span class="keyword">if</span> (DeviceInit == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status=<span class="built_in">WdfDeviceInitAssignName</span>(DeviceInit, &amp;DeviceName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备分配失败！\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//WDF_FILEOBJECT_CONFIG_INIT 函数初始化驱动程序WDF_FILEOBJECT_CONFIG结构</span></span><br><span class="line">    <span class="built_in">WDF_FILEOBJECT_CONFIG_INIT</span>(&amp;FileConfig, EvtWdfDeviceFileCreate, EvtWdfFileClose, EvtWdfFileCleanup);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//WdfDeviceInitSetFileObjectConfig 方法注册事件回调函数并设置驱动程序框架文件对象的配置信息。</span></span><br><span class="line">    <span class="built_in">WdfDeviceInitSetFileObjectConfig</span>(DeviceInit, &amp;FileConfig, WDF_NO_OBJECT_ATTRIBUTES);</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">WdfDeviceCreate</span>(&amp;DeviceInit,WDF_NO_OBJECT_ATTRIBUTES,&amp;Device);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="built_in">WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE</span>(&amp;ioConfig, WdfIoQueueDispatchSequential);</span><br><span class="line"></span><br><span class="line">    ioConfig.EvtIoDeviceControl = m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">WdfIoQueueCreate</span>(Device, &amp;ioConfig, WDF_NO_OBJECT_ATTRIBUTES, &amp;Queue);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备队列创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">WdfDeviceCreateSymbolicLink</span>(Device, &amp;SymbolicLinkName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;符号链接创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">WdfControlFinishInitializing</span>(Device);</span><br><span class="line">    <span class="comment">// 其他初始化操作</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化成功!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">End:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;WFP驱动初始化失败!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>应用层：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\\\.\\HelloWDF&quot;</span>  <span class="comment">// 设备的符号链接名称</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    HANDLE hDevice = INVALID_HANDLE_VALUE;</span><br><span class="line">    BOOL result = FALSE;</span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//char outputBuffer[100] = &#123; 0 &#125;;</span></span><br><span class="line">    <span class="type">char</span> inputBuffer[<span class="number">100</span>] = <span class="string">&quot;Test input data&quot;</span>;  <span class="comment">// 输入缓冲区示例</span></span><br><span class="line">    <span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;            <span class="comment">// 输出缓冲区</span></span><br><span class="line">    <span class="comment">// 打开设备</span></span><br><span class="line">    hDevice = <span class="built_in">CreateFile</span>(</span><br><span class="line">        DEVICE_NAME,                     <span class="comment">// 设备名称</span></span><br><span class="line">        GENERIC_READ | GENERIC_WRITE,    <span class="comment">// 访问权限</span></span><br><span class="line">        <span class="number">0</span>,                               <span class="comment">// 共享模式（0 表示独占）</span></span><br><span class="line">        <span class="literal">NULL</span>,                            <span class="comment">// 安全属性</span></span><br><span class="line">        OPEN_EXISTING,                   <span class="comment">// 创建选项</span></span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,           <span class="comment">// 文件属性</span></span><br><span class="line">        <span class="literal">NULL</span>                             <span class="comment">// 模板文件句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to open device. Error: %d\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 DeviceIoControl</span></span><br><span class="line">    result = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">        hDevice,                        <span class="comment">// 设备句柄</span></span><br><span class="line">        <span class="literal">NULL</span>,                <span class="comment">// 控制代码</span></span><br><span class="line">        inputBuffer,                    <span class="comment">// 输入缓冲区</span></span><br><span class="line">        <span class="built_in">sizeof</span>(inputBuffer),            <span class="comment">// 输入缓冲区大小</span></span><br><span class="line">        outputBuffer,                   <span class="comment">// 输出缓冲区</span></span><br><span class="line">        <span class="built_in">sizeof</span>(outputBuffer),           <span class="comment">// 输出缓冲区大小</span></span><br><span class="line">        &amp;bytesReturned,                 <span class="comment">// 返回的字节数</span></span><br><span class="line">        <span class="literal">NULL</span>                            <span class="comment">// 重叠结构（非异步调用时为 NULL）</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>实现效果：</p>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736741233393.png" alt="1736741233393"></p>
<h2 id="第五节：从0实现支持pnp的WDF驱动"><a href="#第五节：从0实现支持pnp的WDF驱动" class="headerlink" title="第五节：从0实现支持pnp的WDF驱动"></a>第五节：从0实现支持pnp的WDF驱动</h2><h3 id="什么是Pnp，为什么需要Pnp"><a href="#什么是Pnp，为什么需要Pnp" class="headerlink" title="什么是Pnp，为什么需要Pnp"></a>什么是Pnp，为什么需要Pnp</h3><p>我们来讨论下pnp</p>
<p>首先什么是pnp？ PnP（Plug and Play，即插即用）是一种功能，让操作系统能够自动检测和配置新硬件设备，而无需用户干预。PnP 驱动程序会响应硬件的添加、移除、资源分配和电源管理事件。 </p>
<p>我们来看看WDM是如何实现Pnp的</p>
<p>在 Windows 驱动模型 (WDM) 中，支持 PnP 是非常重要的特性。PnP 驱动主要通过响应系统发送的 <strong>IRP_MN_XXX</strong> 类型的 I&#x2F;O 请求包 (IRP) 来实现对设备的动态管理，例如设备启动 (<code>IRP_MN_START_DEVICE</code>)、设备移除 (<code>IRP_MN_REMOVE_DEVICE</code>) 和设备停止 (<code>IRP_MN_STOP_DEVICE</code>)  </p>
<p>通过这些NT驱动没有的IRP，实现了Pnp</p>
<p>那么在WDF中，对Pnp进行了进一步的封装，WDF 使用回调函数（如 <code>EvtDeviceAdd</code> 和 <code>EvtDevicePrepareHardware</code>）来处理 PnP 和电源管理事件，而不是直接处理 IRP。 </p>
<p>为什么我们需要Pnp？为什么不把创建对象，也就是<code>WdfDeviceCreate</code>直接写在<code>DriverEntry</code>？</p>
<p>这里要分控制设备和功能设备</p>
<p><strong>控制设备</strong><br>对于控制设备（如非即插即用设备或虚拟设备），可以在 <code>DriverEntry</code> 或类似的初始化函数中调用 <code>WdfDeviceCreate</code> 创建设备对象，因为这些设备与硬件无关，不依赖 PnP 机制。</p>
<p><strong>功能设备</strong><br>对于功能设备，系统会通过 PnP 机制向驱动程序通知设备的到达事件，驱动程序在 <code>EvtDriverDeviceAdd</code> 中为设备创建相应的 <code>WDFDEVICE</code>，并初始化硬件资源。</p>
<p>我们现在写的都是创建的虚拟设备，实际上并没有硬件插入的</p>
<p>我们可以这样想象一个场景：</p>
<p>假设你正在为一款即插即用的PCI网卡编写一个驱动程序。这张网卡可能有多个型号，且可能有多个实例插入到同一台电脑上（例如插了两块相同型号的网卡）。 如果说是将<code>WdfDeviceCreate</code> 写在DriverEntry，但是驱动已经调用过一遍DriverEntry，不能再调用了，这下就没办法生成一个新的设备对象，但是如果写在<code>EvtDriverDeviceAdd</code>，就可以在系统感知到设备插入自动调用生成一个设备对象，这就是为什么我们需要pnp</p>
<h3 id="实现的示例代码"><a href="#实现的示例代码" class="headerlink" title="实现的示例代码"></a>实现的示例代码</h3><p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736777494168.png" alt="1736777494168"></p>
<p>Device.h，Device.c：这里是实现当有设备插入，自动创建设备对象并设置回调函数的相关实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">m_EVT_WDF_DRIVER_DEVICE_ADD</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDRIVER Driver,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_</span></span></span><br><span class="line"><span class="params"><span class="function">    PWDFDEVICE_INIT DeviceInit</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Device.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Queue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initguid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(DEVICEINTERFACE, <span class="number">0x8C9528E5</span>, <span class="number">0xE99D</span>, <span class="number">0xDBE9</span>, <span class="number">0xA4</span>, <span class="number">0x10</span>, <span class="number">0xF1</span>, <span class="number">0x7C</span>, <span class="number">0xDB</span>, <span class="number">0x96</span>, <span class="number">0x66</span>, <span class="number">0x0B</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;clean_up\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfFileClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileObject;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;close\n&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EvtWdfDeviceFileCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDEVICE Device,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFFILEOBJECT FileObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Device;</span><br><span class="line">    Request;</span><br><span class="line">    FileObject;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;file_create\n&quot;</span>);</span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">m_EVT_WDF_DRIVER_DEVICE_ADD</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFDRIVER Driver,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_</span></span></span><br><span class="line"><span class="params"><span class="function">    PWDFDEVICE_INIT DeviceInit</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Driver;</span><br><span class="line">    DeviceInit;</span><br><span class="line">    NTSTATUS status=STATUS_SUCCESS;</span><br><span class="line">    WDF_FILEOBJECT_CONFIG FileConfig;  <span class="comment">//文件对象的配置信息</span></span><br><span class="line">    WDFDEVICE Device;   <span class="comment">//WDF设备对象</span></span><br><span class="line">    WDF_IO_QUEUE_CONFIG IoQueueConfig;</span><br><span class="line"></span><br><span class="line">    UNICODE_STRING DeviceName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\Device\\HelloWDF&quot;</span>);</span><br><span class="line">    status = <span class="built_in">WdfDeviceInitAssignName</span>(DeviceInit,&amp;DeviceName);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备分配失败！\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//WDF_FILEOBJECT_CONFIG_INIT 函数初始化驱动程序WDF_FILEOBJECT_CONFIG结构</span></span><br><span class="line">    <span class="built_in">WDF_FILEOBJECT_CONFIG_INIT</span>(&amp;FileConfig, EvtWdfDeviceFileCreate, EvtWdfFileClose, EvtWdfFileCleanup);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//WdfDeviceInitSetFileObjectConfig 方法注册事件回调函数并设置驱动程序框架文件对象的配置信息。</span></span><br><span class="line">    <span class="built_in">WdfDeviceInitSetFileObjectConfig</span>(DeviceInit, &amp;FileConfig, WDF_NO_OBJECT_ATTRIBUTES);</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">WdfDeviceCreate</span>(&amp;DeviceInit, WDF_NO_OBJECT_ATTRIBUTES, &amp;Device);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="comment">// 处理错误</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;设备创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置IO队列</span></span><br><span class="line">    <span class="built_in">WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE</span>(&amp;IoQueueConfig, WdfIoQueueDispatchSequential);</span><br><span class="line"></span><br><span class="line">    IoQueueConfig.EvtIoDeviceControl = m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL;  <span class="comment">//添加IO_DEVICE_CONTROL回调</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 I/O 队列</span></span><br><span class="line">    WDFQUEUE IoQueue = <span class="literal">NULL</span>;  <span class="comment">// 定义一个 WDFQUEUE 变量</span></span><br><span class="line">    status = <span class="built_in">WdfIoQueueCreate</span>(Device, &amp;IoQueueConfig, WDF_NO_OBJECT_ATTRIBUTES, &amp;IoQueue);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;Failed to create I/O queue: 0x%X\n&quot;</span>, status);</span><br><span class="line">        <span class="keyword">goto</span> End;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">WdfDeviceCreateDeviceInterface</span>(Device, &amp;DEVICEINTERFACE, <span class="literal">NULL</span>);  <span class="comment">//为设备注册一个设备接口</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">WdfControlFinishInitializing</span>(Device);  <span class="comment">//完成设备的初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;Wdf_Driver_Add\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">End:</span><br><span class="line">    status = STATUS_UNSUCCESSFUL;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以发现这里并没有使用建立符号链接，而是选择了为设备注册一个设备接口，连设备名都不需要了</p>
<p><strong>WdfDeviceCreateDeviceInterface</strong></p>
<p><strong>用途</strong>：为设备注册一个设备接口，供用户模式应用程序通过设备接口 GUID 进行访问。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th><code>WdfDeviceCreateDeviceInterface</code></th>
<th><code>WdfDeviceCreateSymbolicLink</code></th>
</tr>
</thead>
<tbody><tr>
<td><strong>用途</strong></td>
<td>动态设备发现和访问</td>
<td>提供固定路径直接访问设备</td>
</tr>
<tr>
<td><strong>PnP 支持</strong></td>
<td>完全支持</td>
<td>需要开发者手动管理插拔、状态变化</td>
</tr>
<tr>
<td><strong>设备实例管理</strong></td>
<td>可用于多个设备实例，每个实例动态注册接口 GUID</td>
<td>一个符号链接通常绑定一个设备实例</td>
</tr>
<tr>
<td><strong>用户模式访问</strong></td>
<td>用户程序通过接口 GUID 枚举和打开设备</td>
<td>用户程序通过固定符号链接路径打开设备</td>
</tr>
<tr>
<td><strong>API 兼容性</strong></td>
<td>使用 <code>SetupDi</code> 系列 API</td>
<td>使用传统 Win32 API (<code>CreateFile</code>)</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>现代驱动、支持动态枚举</td>
<td>传统驱动、调试用</td>
</tr>
</tbody></table>
<p>Queue.h和Queue.c	这里是实现具体回调函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span>  QUEUE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QUEUE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="function">VOID <span class="title">m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFQUEUE Queue,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> OutputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG IoControlCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ! QUEUE_H</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFQUEUE Queue,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> OutputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG IoControlCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Queue;</span><br><span class="line">    Request;</span><br><span class="line">    OutputBufferLength;</span><br><span class="line">    InputBufferLength;</span><br><span class="line">    IoControlCode;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;IO_DEVICE_CONTROL\n&quot;</span>);</span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, STATUS_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>DriverEntry：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Device.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status; <span class="comment">//状态</span></span><br><span class="line">    WDF_DRIVER_CONFIG config;  <span class="comment">//WDF驱动配置</span></span><br><span class="line">    WDFDRIVER driver;  <span class="comment">//WDF驱动对象</span></span><br><span class="line">    <span class="built_in">KdBreakPoint</span>();</span><br><span class="line">    <span class="comment">// 初始化 WDF 驱动程序配置</span></span><br><span class="line">    <span class="built_in">WDF_DRIVER_CONFIG_INIT</span>(&amp;config, m_EVT_WDF_DRIVER_DEVICE_ADD);</span><br><span class="line">    config.EvtDriverUnload = MyDriverUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 WDF 驱动程序对象</span></span><br><span class="line">    status = <span class="built_in">WdfDriverCreate</span>(</span><br><span class="line">        DriverObject,          <span class="comment">// WDM 驱动对象</span></span><br><span class="line">        RegistryPath,          <span class="comment">// 注册表路径</span></span><br><span class="line">        WDF_NO_OBJECT_ATTRIBUTES, <span class="comment">// 驱动程序属性（可选）</span></span><br><span class="line">        &amp;config,               <span class="comment">// 驱动程序配置</span></span><br><span class="line">        &amp;driver                <span class="comment">// 返回的 WDFDRIVER 句柄</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DebugPrint</span>(<span class="string">&quot;注册驱动的框架对象失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，相比于前几节，如果在<code>WDF_DRIVER_CONFIG_INIT</code>设置了<code>EVT_DRIVER_DEVICE_ADD</code>，那么这里一定不能添加<code>config.DriverInitFlags |= WdfDriverInitNonPnpDriver;</code></p>
<p>另外</p>
<ul>
<li>对于即插即用驱动程序（PnP驱动程序），通常不需要指定 <code>EvtDriverUnload</code> 回调函数，因为即插即用驱动程序的卸载是由设备管理器（Device Manager）和操作系统自动处理的。</li>
<li>即插即用驱动程序的卸载通常是通过删除设备节点或禁用设备来触发的，而不是通过显式的卸载函数。</li>
</ul>
<p><strong>加载和卸载驱动：</strong></p>
<p>平时我们都是用<code>KmdManager</code>直接加载驱动，但是这样会有一个不好的点，就是仅仅添加驱动，但是不会创建设备，所以我们不好直接用它来测试pnp驱动</p>
<p>所以我们用<code>hdwwiz</code></p>
<p>使用 <code>hdwwiz</code> 添加 INF 文件时，Windows 会执行以下操作：</p>
<ol>
<li>解析 INF 文件，获取设备的硬件 ID 和驱动程序信息。</li>
<li>创建设备节点（Device Node）。</li>
<li>将设备节点与已加载的驱动程序关联。</li>
<li>调用驱动程序的 <code>AddDevice</code> 例程来创建设备对象。</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li>如果驱动程序已经加载（例如通过 <code>sc create</code> 或 <code>net start</code>），Windows 不会重新加载驱动程序，因此不会再次调用 <code>DriverEntry</code>。</li>
<li>如果驱动程序未加载，Windows 会先加载驱动程序（调用 <code>DriverEntry</code>），然后再调用 <code>AddDevice</code>。</li>
</ul>
<p>在设备管理器这里可以选择禁用设备和卸载设备</p>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736824974600.png" alt="1736824974600"></p>
<h2 id="第六节：使用Pnp的应用程序"><a href="#第六节：使用Pnp的应用程序" class="headerlink" title="第六节：使用Pnp的应用程序"></a>第六节：使用Pnp的应用程序</h2><p>示例代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setupapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initguid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换为你的GUID</span></span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(DEVICEINTERFACE, <span class="number">0x8C9528E5</span>, <span class="number">0xE99D</span>, <span class="number">0xDBE9</span>, <span class="number">0xA4</span>, <span class="number">0x10</span>, <span class="number">0xF1</span>, <span class="number">0x7C</span>, <span class="number">0xDB</span>, <span class="number">0x96</span>, <span class="number">0x66</span>, <span class="number">0x0B</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GetDeviceInterfacePath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HDEVINFO deviceInfoSet;</span><br><span class="line">    SP_DEVICE_INTERFACE_DATA deviceInterfaceData;</span><br><span class="line">    PSP_DEVICE_INTERFACE_DETAIL_DATA deviceInterfaceDetailData = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD requiredSize = <span class="number">0</span>;</span><br><span class="line">    BOOL success;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取设备信息集合</span></span><br><span class="line">    deviceInfoSet = <span class="built_in">SetupDiGetClassDevs</span>(</span><br><span class="line">        &amp;DEVICEINTERFACE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        DIGCF_PRESENT | DIGCF_DEVICEINTERFACE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">    DIGCF_PRESENT：仅返回当前连接到系统的设备。</span></span><br><span class="line"><span class="comment">    DIGCF_DEVICEINTERFACE：返回设备接口类的设备信息集。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (deviceInfoSet == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiGetClassDevs failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deviceInterfaceData.cbSize = <span class="built_in">sizeof</span>(SP_DEVICE_INTERFACE_DATA);<span class="comment">//设备接口数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 枚举设备接口</span></span><br><span class="line">    success = <span class="built_in">SetupDiEnumDeviceInterfaces</span>(</span><br><span class="line">        deviceInfoSet,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;DEVICEINTERFACE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;deviceInterfaceData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiEnumDeviceInterfaces failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取接口详细信息所需缓冲区大小</span></span><br><span class="line">    <span class="built_in">SetupDiGetDeviceInterfaceDetail</span>(</span><br><span class="line">        deviceInfoSet,</span><br><span class="line">        &amp;deviceInterfaceData,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;requiredSize,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    deviceInterfaceDetailData = (PSP_DEVICE_INTERFACE_DETAIL_DATA)<span class="built_in">malloc</span>(requiredSize);</span><br><span class="line">    deviceInterfaceDetailData-&gt;cbSize = <span class="built_in">sizeof</span>(SP_DEVICE_INTERFACE_DETAIL_DATA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取设备接口详细信息</span></span><br><span class="line">    success = <span class="built_in">SetupDiGetDeviceInterfaceDetail</span>(</span><br><span class="line">        deviceInfoSet,</span><br><span class="line">        &amp;deviceInterfaceData,</span><br><span class="line">        deviceInterfaceDetailData,</span><br><span class="line">        requiredSize,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiGetDeviceInterfaceDetail failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(deviceInterfaceDetailData);</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Device Path: %s\n&quot;</span>, deviceInterfaceDetailData-&gt;DevicePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用设备路径（例如，通过 CreateFile 打开设备）</span></span><br><span class="line">    HANDLE deviceHandle = <span class="built_in">CreateFile</span>(</span><br><span class="line">        deviceInterfaceDetailData-&gt;DevicePath,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deviceHandle == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to open device\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Device opened successfully\n&quot;</span>);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(deviceHandle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(deviceInterfaceDetailData);</span><br><span class="line">    <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">GetDeviceInterfacePath</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>成功触发pnp的回调</p>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736824535036.png" alt="1736824535036"></p>
<h2 id="第七节：WDF中文数字转换驱动"><a href="#第七节：WDF中文数字转换驱动" class="headerlink" title="第七节：WDF中文数字转换驱动"></a>第七节：WDF中文数字转换驱动</h2><p>关于IO控制码的编写：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CTL_CODE(DeviceType, Function, Method, Access) </span></span><br><span class="line">    (((DeviceType) &lt;&lt; <span class="number">16</span>) | ((Access) &lt;&lt; <span class="number">14</span>) | ((Function) &lt;&lt; <span class="number">2</span>) | (Method))</span><br></pre></td></tr></table></figure>



<p>**<code>DeviceType</code>**： 指定设备类型 ，可以是预定义的设备类型（例如 <code>FILE_DEVICE_DISK</code>、<code>FILE_DEVICE_KEYBOARD</code> 等）。如果设备类型未知，可以使用 <code>FILE_DEVICE_UNKNOWN</code>。</p>
<p><strong><code>Function</code></strong>:指定功能代码。通常从 0x800 开始，以避免与系统保留的功能代码冲突。</p>
<p><code>Method</code>：作用：指定数据传输方法。<br>取值：<br>METHOD_BUFFERED：使用缓冲 I&#x2F;O（数据通过系统缓冲区传递）。<br>METHOD_IN_DIRECT：使用直接 I&#x2F;O（输入数据通过直接内存访问传递）。<br>METHOD_OUT_DIRECT：使用直接 I&#x2F;O（输出数据通过直接内存访问传递）。<br>METHOD_NEITHER：不使用系统缓冲区，直接传递用户模式指针。</p>
<p>**<code>Access</code>**：作用：指定访问权限。<br>取值：<br>FILE_ANY_ACCESS：允许任何访问。<br>FILE_READ_ACCESS：允许读访问。<br>FILE_WRITE_ACCESS：允许写访问。<br>FILE_READ_ACCESS | FILE_WRITE_ACCESS：允许读写访问。</p>
<p>例如这样定义一个IOCTL_CODE</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,0X800,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br></pre></td></tr></table></figure>





<p><code>IO_DEVICE_CONTROL</code>处理回调函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFQUEUE Queue,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> OutputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">size_t</span> InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG IoControlCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>





<p>检索 I&#x2F;O 请求的输出缓冲区。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">WdfRequestRetrieveOutputBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            <span class="type">size_t</span>     MinimumRequiredSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PVOID      *Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] <span class="type">size_t</span>     *Length</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中<code>MinimumRequiredSize</code>  参数用于指定驱动程序<strong>需要的最小输出缓冲区大小</strong> ,如果用户层提供的缓冲区大小小于 <code>MinimumRequiredSize</code>，<code>WdfRequestRetrieveOutputBuffer</code> 会返回 <code>STATUS_BUFFER_TOO_SMALL</code>，驱动程序可以拒绝处理请求。 </p>
<p><strong>WdfRequestRetrieveInputBuffer</strong>  也是如此</p>
<p><strong>应用层代码</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setupapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initguid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义设备接口 GUID</span></span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(DEVICEINTERFACE, <span class="number">0x8C9528E5</span>, <span class="number">0xE99D</span>, <span class="number">0xDBE9</span>, <span class="number">0xA4</span>, <span class="number">0x10</span>, <span class="number">0xF1</span>, <span class="number">0x7C</span>, <span class="number">0xDB</span>, <span class="number">0x96</span>, <span class="number">0x66</span>, <span class="number">0x0B</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_TEST CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetDevicePath</span><span class="params">(LPGUID InterfaceGuid, <span class="type">char</span>* DevicePath, <span class="type">size_t</span> DevicePathSize)</span> </span>&#123;</span><br><span class="line">    HDEVINFO deviceInfoSet = <span class="built_in">SetupDiGetClassDevsA</span>(InterfaceGuid, <span class="literal">NULL</span>, <span class="literal">NULL</span>, DIGCF_PRESENT | DIGCF_DEVICEINTERFACE);</span><br><span class="line">    <span class="keyword">if</span> (deviceInfoSet == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiGetClassDevsA failed: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SP_DEVICE_INTERFACE_DATA deviceInterfaceData;</span><br><span class="line">    deviceInterfaceData.cbSize = <span class="built_in">sizeof</span>(SP_DEVICE_INTERFACE_DATA);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">SetupDiEnumDeviceInterfaces</span>(deviceInfoSet, <span class="literal">NULL</span>, InterfaceGuid, <span class="number">0</span>, &amp;deviceInterfaceData)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiEnumDeviceInterfaces failed: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD requiredSize = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">SetupDiGetDeviceInterfaceDetailA</span>(deviceInfoSet, &amp;deviceInterfaceData, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;requiredSize, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetLastError</span>() != ERROR_INSUFFICIENT_BUFFER) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiGetDeviceInterfaceDetailA size query failed: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PSP_DEVICE_INTERFACE_DETAIL_DATA_A deviceInterfaceDetailData = (PSP_DEVICE_INTERFACE_DETAIL_DATA_A)<span class="built_in">malloc</span>(requiredSize);</span><br><span class="line">    <span class="keyword">if</span> (!deviceInterfaceDetailData) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Memory allocation failed.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deviceInterfaceDetailData-&gt;cbSize = <span class="built_in">sizeof</span>(SP_DEVICE_INTERFACE_DETAIL_DATA_A);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">SetupDiGetDeviceInterfaceDetailA</span>(deviceInfoSet, &amp;deviceInterfaceData, deviceInterfaceDetailData, requiredSize, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SetupDiGetDeviceInterfaceDetailA failed: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">free</span>(deviceInterfaceDetailData);</span><br><span class="line">        <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strncpy</span>(DevicePath, deviceInterfaceDetailData-&gt;DevicePath, DevicePathSize - <span class="number">1</span>);</span><br><span class="line">    DevicePath[DevicePathSize - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(deviceInterfaceDetailData);</span><br><span class="line">    <span class="built_in">SetupDiDestroyDeviceInfoList</span>(deviceInfoSet);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="type">char</span> devicePath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取设备路径</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">GetDevicePath</span>((LPGUID)&amp;DEVICEINTERFACE, devicePath, <span class="built_in">sizeof</span>(devicePath))) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to get device path.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Device Path: %s\n&quot;</span>, devicePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开设备</span></span><br><span class="line">    HANDLE hDevice = <span class="built_in">CreateFileA</span>(</span><br><span class="line">        devicePath,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        OPEN_EXISTING,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to open device: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 准备输入和输出缓冲区</span></span><br><span class="line">        <span class="type">char</span> inputBuffer[<span class="number">0x20</span>];</span><br><span class="line">        <span class="type">char</span> outputBuffer[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;; <span class="comment">// 输出汉字结果</span></span><br><span class="line">        DWORD bytesReturned;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, inputBuffer);</span><br><span class="line">        <span class="comment">// 发送 IOCTL 请求</span></span><br><span class="line">        BOOL result = <span class="built_in">DeviceIoControl</span>(</span><br><span class="line">            hDevice,</span><br><span class="line">            IOCTL_TEST,</span><br><span class="line">            inputBuffer,</span><br><span class="line">            <span class="built_in">sizeof</span>(inputBuffer),</span><br><span class="line">            outputBuffer,</span><br><span class="line">            <span class="built_in">sizeof</span>(outputBuffer),</span><br><span class="line">            &amp;bytesReturned,</span><br><span class="line">            <span class="literal">NULL</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Driver response: %s\n&quot;</span>, outputBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;DeviceIoControl failed: %lu\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭设备句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hDevice);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>驱动代码</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_TEST CTL_CODE(FILE_DEVICE_UNKNOWN,0X800,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">m_EVT_WDF_IO_QUEUE_IO_DEVICE_CONTROL</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WDFQUEUE Queue,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WDFREQUEST Request,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ <span class="type">size_t</span> OutputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ <span class="type">size_t</span> InputBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG IoControlCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(Queue);</span><br><span class="line"></span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PVOID inputBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    PVOID outputBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数字到汉字的映射表</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* digitToChinese[] = &#123;</span><br><span class="line">        <span class="string">&quot;零&quot;</span>, <span class="string">&quot;一&quot;</span>, <span class="string">&quot;二&quot;</span>, <span class="string">&quot;三&quot;</span>, <span class="string">&quot;四&quot;</span>, <span class="string">&quot;五&quot;</span>, <span class="string">&quot;六&quot;</span>, <span class="string">&quot;七&quot;</span>, <span class="string">&quot;八&quot;</span>, <span class="string">&quot;九&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> temp[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (IoControlCode) &#123;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_TEST:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取输入缓冲区</span></span><br><span class="line">        status = <span class="built_in">WdfRequestRetrieveInputBuffer</span>(Request, InputBufferLength, &amp;inputBuffer, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to retrieve input buffer: 0x%X\n&quot;</span>, status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取输出缓冲区</span></span><br><span class="line">        status = <span class="built_in">WdfRequestRetrieveOutputBuffer</span>(Request, OutputBufferLength, &amp;outputBuffer, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="built_in">KdPrint</span>((<span class="string">&quot;Failed to retrieve output buffer: 0x%X\n&quot;</span>, status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* input = (<span class="type">const</span> <span class="type">char</span>*)inputBuffer; <span class="comment">// 假设输入为 null 终止字符串</span></span><br><span class="line">        <span class="type">char</span>* output = (<span class="type">char</span>*)outputBuffer;</span><br><span class="line">        <span class="type">size_t</span> outputIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换数字到汉字</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; input[i] != <span class="string">&#x27;\0&#x27;</span>; i++) &#123;</span><br><span class="line">            <span class="type">char</span> digit = input[i];</span><br><span class="line">            <span class="keyword">if</span> (digit &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; digit &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">char</span>* chineseDigit = digitToChinese[digit - <span class="string">&#x27;0&#x27;</span>];</span><br><span class="line">                <span class="type">size_t</span> len = <span class="built_in">strlen</span>(chineseDigit);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查输出缓冲区是否足够</span></span><br><span class="line">                <span class="keyword">if</span> (outputIndex + len &gt;= OutputBufferLength&amp;&amp; outputIndex + len &gt;= <span class="number">0x100</span>) &#123;</span><br><span class="line">                    status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">                    <span class="built_in">KdPrint</span>((<span class="string">&quot;Output buffer too small. Required: %zu, Provided: %zu\n&quot;</span>, outputIndex + len, OutputBufferLength));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将汉字数字复制到输出缓冲区</span></span><br><span class="line">                <span class="built_in">strcpy</span>(&amp;temp[outputIndex], chineseDigit);</span><br><span class="line">                outputIndex += len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果遇到非数字字符，返回错误</span></span><br><span class="line">                status = STATUS_INVALID_PARAMETER;</span><br><span class="line">                <span class="built_in">KdPrint</span>((<span class="string">&quot;Invalid character in input: %c\n&quot;</span>, digit));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="comment">// 添加 null 终止符</span></span><br><span class="line">            <span class="keyword">if</span> (outputIndex &lt; OutputBufferLength) &#123;</span><br><span class="line">                temp[outputIndex] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="built_in">strcpy</span>(output, temp);</span><br><span class="line">                <span class="built_in">WdfRequestSetInformation</span>(Request, outputIndex + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                status = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 不支持的 IOCTL</span></span><br><span class="line">        status = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">        <span class="built_in">KdPrint</span>((<span class="string">&quot;Unsupported IOCTL: 0x%X\n&quot;</span>, IoControlCode));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成请求</span></span><br><span class="line">    <span class="built_in">WdfRequestComplete</span>(Request, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736845247459.png" alt="1736845247459"></p>
<h2 id="第八节：WDF驱动框架对象介绍"><a href="#第八节：WDF驱动框架对象介绍" class="headerlink" title="第八节：WDF驱动框架对象介绍"></a>第八节：WDF驱动框架对象介绍</h2><table>
<thead>
<tr>
<th align="left">WDF 对象</th>
<th align="left">对应的 WDM 对象</th>
</tr>
</thead>
<tbody><tr>
<td align="left">WDFCHILDLIST</td>
<td align="left">DEVICE_RELATIONS for Plug and Play enumerations</td>
</tr>
<tr>
<td align="left">WDFREQUEST</td>
<td align="left">IRP</td>
</tr>
<tr>
<td align="left">WDFCMRESLIST</td>
<td align="left">CM_RESOURCE_LIST</td>
</tr>
<tr>
<td align="left">WDFSPINLOCK</td>
<td align="left">KSPIN_LOCK</td>
</tr>
<tr>
<td align="left">WDFCOLLECTION</td>
<td align="left">None (most closely related to LIST_ENTRY and its related functions)</td>
</tr>
<tr>
<td align="left">WDFSTRING</td>
<td align="left">UNICODE_STRING</td>
</tr>
<tr>
<td align="left">WDFCOMMONBUFFER</td>
<td align="left">PVOID returned by AllocateCommonBuffer</td>
</tr>
<tr>
<td align="left">WDFTIMER</td>
<td align="left">KTIMER</td>
</tr>
<tr>
<td align="left">WDFDEVICE</td>
<td align="left">DEVICE_OBJECT</td>
</tr>
<tr>
<td align="left">WDFUSBDEVICE</td>
<td align="left">Attached DEVICE_OBJECT for a USB-enumerated stack</td>
</tr>
<tr>
<td align="left">WDFDMAENABLER</td>
<td align="left">DMA_ADAPTER</td>
</tr>
<tr>
<td align="left">WDFUSBINTERFACE</td>
<td align="left">USB_INTERFACE_DESCRIPTOR</td>
</tr>
<tr>
<td align="left">WDFDMATRANSACTION</td>
<td align="left">None</td>
</tr>
<tr>
<td align="left">WDFUSBPIPE</td>
<td align="left">USBD_PIPE_HANDLE</td>
</tr>
<tr>
<td align="left">WDFDPC</td>
<td align="left">KDPC</td>
</tr>
<tr>
<td align="left">WDFWAITLOCK</td>
<td align="left">KEVENT, KeEnterCriticalRegion, KeLeaveCriticalRegion</td>
</tr>
<tr>
<td align="left">WDFDRIVER</td>
<td align="left">DRIVER_OBJECT</td>
</tr>
<tr>
<td align="left">WDFWMIPROVIDER</td>
<td align="left">None: accessed through parameters to driver-defined DpWmiXxx callback functions</td>
</tr>
<tr>
<td align="left">WDFFILEOBJECT</td>
<td align="left">FILE_OBJECT</td>
</tr>
<tr>
<td align="left">WDFWMIPROVIDER</td>
<td align="left">None: accessed through parameters to driver-defined DpWmiXxx callback functions</td>
</tr>
<tr>
<td align="left">WDFINTERRUPT</td>
<td align="left">PKINTERRUPT</td>
</tr>
<tr>
<td align="left">WDFWORKITEM</td>
<td align="left">IO_WORKITEM</td>
</tr>
<tr>
<td align="left">WDFIORESLIST</td>
<td align="left">IO_RESOURCE_LIST</td>
</tr>
<tr>
<td align="left">WDFIORESREQLIST</td>
<td align="left">IO_RESOURCE_REQUIREMENTS_LIST</td>
</tr>
<tr>
<td align="left">WDFIOTARGET</td>
<td align="left">DEVICE_OBJECT</td>
</tr>
<tr>
<td align="left">WDFKEY</td>
<td align="left">HANDLE returned by ZwCreateKey or ZwOpenKey</td>
</tr>
<tr>
<td align="left">WDFLOOKASIDE</td>
<td align="left">PAGED_LOOKASIDE_LIST or NPAGED_LOOKASIDE_LIST</td>
</tr>
<tr>
<td align="left">WDFMEMORY</td>
<td align="left">None: accessed through a PVOID returned by memory allocation functions</td>
</tr>
<tr>
<td align="left">WDFOBJECT</td>
<td align="left">None</td>
</tr>
<tr>
<td align="left">WDFQUEUE</td>
<td align="left">IO_CSQ</td>
</tr>
</tbody></table>
<ul>
<li><strong>预定义对象（Predefined）</strong>：由 WDF 框架自动创建和管理的对象。</li>
<li><strong>驱动程序创建的对象（Driver created）</strong>：由驱动程序显式创建和管理的对象。</li>
</ul>
<p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736845850126.png" alt="1736845850126"></p>
<h1 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h1><p><img src="/WDF%E5%AD%A6%E4%B9%A0/1736693479167.png" alt="1736693479167"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Ccai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/WDF%E5%AD%A6%E4%B9%A0/">http://example.com/WDF%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Cc12138's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WDF%E6%A1%86%E6%9E%B6/">WDF框架</a></div><div class="post_share"><div class="social-share" data-image="/img/WangFei2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/%E6%8F%90%E5%8D%87%E8%BF%9B%E7%A8%8B%E8%87%B3PPL%E6%9D%83%E9%99%90/" title="将进程提升至PPL权限"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">将进程提升至PPL权限</div></div></a></div><div class="next-post pull-right"><a href="/NDIS,WFP%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4/" title="NDIS/WFP网络过滤"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">NDIS/WFP网络过滤</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/WangFei2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ccai</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">72</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/0xcc12138" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">ROIS Team Member</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WDF%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">WDF框架学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WDF%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">WDF是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82%EF%BC%9A%E7%AC%AC%E4%B8%80%E4%B8%AAWFP%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">第一节：第一个WFP驱动程序：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">相关函数介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82%EF%BC%9A%E8%AE%BE%E5%A4%87%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5"><span class="toc-number">1.3.</span> <span class="toc-text">第二节：设备对象，文件操作，符号链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82%EF%BC%9A%E7%BC%96%E5%86%99%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%AE%BF%E9%97%AEWDF%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.4.</span> <span class="toc-text">第三节：编写应用程序访问WDF驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82%EF%BC%9A%E5%AE%9E%E7%8E%B0WDF%E7%9A%84IO%E9%98%9F%E5%88%97"><span class="toc-number">1.5.</span> <span class="toc-text">第四节：实现WDF的IO队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%8A%82%EF%BC%9A%E4%BB%8E0%E5%AE%9E%E7%8E%B0%E6%94%AF%E6%8C%81pnp%E7%9A%84WDF%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.6.</span> <span class="toc-text">第五节：从0实现支持pnp的WDF驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPnp%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Pnp"><span class="toc-number">1.6.1.</span> <span class="toc-text">什么是Pnp，为什么需要Pnp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">实现的示例代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E8%8A%82%EF%BC%9A%E4%BD%BF%E7%94%A8Pnp%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.7.</span> <span class="toc-text">第六节：使用Pnp的应用程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E8%8A%82%EF%BC%9AWDF%E4%B8%AD%E6%96%87%E6%95%B0%E5%AD%97%E8%BD%AC%E6%8D%A2%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.8.</span> <span class="toc-text">第七节：WDF中文数字转换驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E8%8A%82%EF%BC%9AWDF%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%AF%B9%E8%B1%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.9.</span> <span class="toc-text">第八节：WDF驱动框架对象介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91"><span class="toc-number">2.</span> <span class="toc-text">遇到的坑</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%8F%90%E5%8D%87%E8%BF%9B%E7%A8%8B%E8%87%B3PPL%E6%9D%83%E9%99%90/" title="将进程提升至PPL权限">将进程提升至PPL权限</a><time datetime="2025-02-05T07:44:00.000Z" title="发表于 2025-02-05 15:44:00">2025-02-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/WDF%E5%AD%A6%E4%B9%A0/" title="WDF框架学习">WDF框架学习</a><time datetime="2025-01-12T15:00:00.000Z" title="发表于 2025-01-12 23:00:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/NDIS,WFP%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4/" title="NDIS/WFP网络过滤">NDIS/WFP网络过滤</a><time datetime="2025-01-12T02:32:00.000Z" title="发表于 2025-01-12 10:32:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="病毒分析">病毒分析</a><time datetime="2025-01-06T14:11:00.000Z" title="发表于 2025-01-06 22:11:00">2025-01-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%BD%91%E7%BB%9C%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AFTDI/" title="TDI网络防火墙技术">TDI网络防火墙技术</a><time datetime="2025-01-06T03:28:00.000Z" title="发表于 2025-01-06 11:28:00">2025-01-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Ccai</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>