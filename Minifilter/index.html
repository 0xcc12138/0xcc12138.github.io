<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Minifilter(nullfilter,scanner,sandbox) | Cc12138's blog</title><meta name="author" content="Ccai"><meta name="copyright" content="Ccai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MinifilterMinifilter简介MiniFilter是微软为我们开发的一个新的驱动,称为过滤管理器.(Filter Manager或者 fltmgr).这个驱动主要作用就是如果有文件操作可以通知我们.  Minifilter与legacy filter的区别： 1.比sfilter加载顺序更易控制，因为Minifilter可以设置Altitude 对于Minifilter来说，Alti">
<meta property="og:type" content="article">
<meta property="og:title" content="Minifilter(nullfilter,scanner,sandbox)">
<meta property="og:url" content="http://example.com/Minifilter/index.html">
<meta property="og:site_name" content="Cc12138&#39;s blog">
<meta property="og:description" content="MinifilterMinifilter简介MiniFilter是微软为我们开发的一个新的驱动,称为过滤管理器.(Filter Manager或者 fltmgr).这个驱动主要作用就是如果有文件操作可以通知我们.  Minifilter与legacy filter的区别： 1.比sfilter加载顺序更易控制，因为Minifilter可以设置Altitude 对于Minifilter来说，Alti">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/WangFei2.jpg">
<meta property="article:published_time" content="2024-11-11T03:52:00.000Z">
<meta property="article:modified_time" content="2025-01-24T07:52:55.153Z">
<meta property="article:author" content="Ccai">
<meta property="article:tag" content="Minifilter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/WangFei2.jpg"><link rel="shortcut icon" href="/img/rose.png"><link rel="canonical" href="http://example.com/Minifilter/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Minifilter(nullfilter,scanner,sandbox)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-24 15:52:55'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/WangFei2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">72</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Cc12138's blog"><span class="site-name">Cc12138's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Minifilter(nullfilter,scanner,sandbox)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-11T03:52:00.000Z" title="发表于 2024-11-11 11:52:00">2024-11-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-24T07:52:55.153Z" title="更新于 2025-01-24 15:52:55">2025-01-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Minifilter(nullfilter,scanner,sandbox)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Minifilter"><a href="#Minifilter" class="headerlink" title="Minifilter"></a>Minifilter</h1><h2 id="Minifilter简介"><a href="#Minifilter简介" class="headerlink" title="Minifilter简介"></a>Minifilter简介</h2><p>MiniFilter是微软为我们开发的一个新的驱动,称为过滤管理器.(Filter Manager或者 fltmgr).这个驱动主要作用就是如果有文件操作可以通知我们. </p>
<p><code>Minifilter</code>与<code>legacy filter</code>的区别：</p>
<p>1.比sfilter加载顺序更易控制，因为Minifilter可以设置<code>Altitude</code></p>
<p>对于<strong>Minifilter</strong>来说，Altitude 是一个非常重要的概念，因为 Minifilter 结构允许多个过滤驱动共存，而 Altitude 数值用于规定每个驱动的层级位置，高度越低的驱动越靠近文件系统核心，优先处理文件操作。</p>
<p>而Sfilter要自己手动Attach，如果多个过滤设备的话，加载顺序难免会较难控制 </p>
<p>2.Minifilter具有可卸载能力<br>而<code>legacy filter</code>卸载可能会蓝屏，原因是可能存在仍在处理的IRP请求</p>
<p>3.CallBack模型，只需要处理必要操作的能力</p>
<p>提供了Pre和Post两个类型的回调</p>
<p>4.兼容性更好</p>
<p>5.名字更好处理：提供了函数一键获取文件路径</p>
<p>6.同样遵循IRQL，锁等内核机制</p>
<h2 id="总体框架"><a href="#总体框架" class="headerlink" title="总体框架"></a>总体框架</h2><p><img src="/Minifilter/1731294907375.png" alt="1731294907375"></p>
<p>以上是用Filter管理器简化后的I&#x2F;O栈和minifilter驱动</p>
<p>流程是这样的</p>
<p>首先由用户模式发送的文件I&#x2F;O发送给 I&#x2F;O 管理器，由I&#x2F;O管理器去将用户层发来的数据和命令封装为IRP</p>
<p>原来的模式是，I&#x2F;O管理器将这个IRP一次发给文件系统驱动，再发给磁盘系统驱动，最后发给硬件</p>
<p>现在多了一个FilterManager，<strong>Filter Manager</strong> 位于 <strong>I&#x2F;O 管理器</strong> 和 <strong>文件系统驱动</strong> 之间的中间层。它是一个内核组件，用于管理文件系统的 Minifilter 驱动。Filter Manager 通过拦截并协调所有 I&#x2F;O 请求，为所有文件系统 I&#x2F;O 操作提供了一个必经之路，以便调用注册的 Minifilter 驱动。 </p>
<p>现在I&#x2F;O管理器发IRP的时候，要先发给Filter Manager，如果注册了Minifilter，这个Filter Manager会把IRP封装为 <code>CALLBACK_DATA</code>这个结构，然后发给Minifilter进行处理</p>
<p>minifilter传递顺序是 A-&gt;B-&gt;C，任何一层都可以决定是否将IRP继续往下发或者到此为止。</p>
<p><img src="/Minifilter/1731296572086.png" alt="1731296572086"></p>
<p>稍微复杂点：</p>
<p>这幅图就告诉我们，可以既安装Legacy Filter，也可以安装Minifilter，两者不冲突，另外， Windows 系统将 Legacy Filter 固定在 Frame 1 和 Frame 0 之间是为了确保系统的兼容性和稳定性。  如果希望在更低的层次拦截请求，建议使用 Minifilter 驱动程序代替 Legacy Filter Driver。Minifilter 驱动通过 Altitude 值进行排序，可以放置在 Frame 0 以达到较低的优先级。 </p>
<h2 id="Altitude值：20000–429999"><a href="#Altitude值：20000–429999" class="headerlink" title="Altitude值：20000–429999"></a>Altitude值：20000–429999</h2><p>每一个minifilter驱动必须有一个叫做altitude的唯一标识符，每一个minifilter驱动的altitude定义了它加载时在I&#x2F;O栈中相对于其他minifilter驱动的位置，值越小，栈中的位置就越低</p>
<p>FSFilter Anti-Virus 320000-329999 此组包括在文件I&#x2F;O期间探测并杀毒的过滤驱动</p>
<p>FSFilter Encryption 140000-149999此组包括在文件I&#x2F;O期间加密和解密数据的过滤驱动</p>
<p><strong>320000-329999</strong> 和 <strong>140000-149999</strong> 之间的范围可能属于其他用途，或者被其他特定类型的驱动（如备份、文件同步、系统监控等）使用。 </p>
<p>它们是由 <strong>微软</strong> 预设的 <strong>常用用途范围</strong>。 </p>
<h2 id="Minifilter架构"><a href="#Minifilter架构" class="headerlink" title="Minifilter架构"></a>Minifilter架构</h2><p><code>FLT_REGISTRATION</code> 结构体 </p>
<p><code>FLT_REGISTRATION</code> 结构体是 <strong>Minifilter 驱动</strong> 注册过程中的关键数据结构，用于定义和管理 Minifilter 驱动的属性和行为。它在 Windows 操作系统中扮演着至关重要的角色，负责告诉操作系统如何加载和配置 Minifilter 驱动。通过 <code>FLT_REGISTRATION</code>，Minifilter 驱动能够注册其处理的文件系统操作、过滤的路径、需要的操作模式等信息。 </p>
<p>结构体定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FLT_REGISTRATION</span> &#123;</span><br><span class="line">  USHORT                                      Size;  <span class="comment">// 结构体大小</span></span><br><span class="line">  USHORT                                      Version;  <span class="comment">// 结构体版本</span></span><br><span class="line">  FLT_REGISTRATION_FLAGS                      Flags;  <span class="comment">// 驱动注册标志</span></span><br><span class="line">  <span class="type">const</span> FLT_CONTEXT_REGISTRATION              *ContextRegistration;  <span class="comment">// 上下文注册</span></span><br><span class="line">  <span class="type">const</span> FLT_OPERATION_REGISTRATION            *OperationRegistration;  <span class="comment">// 操作注册</span></span><br><span class="line">  PFLT_FILTER_UNLOAD_CALLBACK                 FilterUnloadCallback;  <span class="comment">// 卸载回调</span></span><br><span class="line">  PFLT_INSTANCE_SETUP_CALLBACK                InstanceSetupCallback;  <span class="comment">// 实例创建回调</span></span><br><span class="line">  PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK       InstanceQueryTeardownCallback;  <span class="comment">// 实例销毁查询回调</span></span><br><span class="line">  PFLT_INSTANCE_TEARDOWN_CALLBACK             InstanceTeardownStartCallback;  <span class="comment">// 实例销毁开始回调</span></span><br><span class="line">  PFLT_INSTANCE_TEARDOWN_CALLBACK             InstanceTeardownCompleteCallback;  <span class="comment">// 实例销毁完成回调</span></span><br><span class="line">  PFLT_GENERATE_FILE_NAME                     GenerateFileNameCallback;  <span class="comment">// 文件名生成回调</span></span><br><span class="line">  PFLT_NORMALIZE_NAME_COMPONENT               NormalizeNameComponentCallback;  <span class="comment">// 名称规范化回调</span></span><br><span class="line">  PFLT_NORMALIZE_CONTEXT_CLEANUP              NormalizeContextCleanupCallback;  <span class="comment">// 上下文清理回调</span></span><br><span class="line">  PFLT_TRANSACTION_NOTIFICATION_CALLBACK      TransactionNotificationCallback;  <span class="comment">// 事务通知回调</span></span><br><span class="line">  PFLT_NORMALIZE_NAME_COMPONENT_EX            NormalizeNameComponentExCallback;  <span class="comment">// 扩展的名称规范化回调</span></span><br><span class="line">  PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK SectionNotificationCallback;  <span class="comment">// 分区冲突通知回调</span></span><br><span class="line">&#125; FLT_REGISTRATION, *PFLT_REGISTRATION;</span><br></pre></td></tr></table></figure>

<p><strong>字段详细解释</strong></p>
<ol>
<li><p><strong>Size</strong></p>
<ul>
<li>类型：<code>USHORT</code></li>
<li>说明：该字段指定结构体的大小， 微筛选器驱动程序必须将此成员设置为 <strong>sizeof</strong> (FLT_REGISTRATION) 。</li>
</ul>
</li>
<li><p><strong>Version</strong></p>
<ul>
<li>类型：<code>USHORT</code></li>
<li>说明： 微筛选器驱动程序必须将此成员设置为 <code>FLT_REGISTRATION_VERSION </code></li>
</ul>
</li>
<li><p><strong>Flags</strong></p>
<ul>
<li><p>类型：<code>FLT_REGISTRATION_FLAGS</code></p>
</li>
<li><p>微筛选器注册标志的位掩码。 此成员可以是 <strong>NULL</strong> ，也可以是以下各项的组合。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>FLTFL_REGISTRATION_DO_NOT_SUPPORT_SERVICE_STOP</strong></td>
<td align="left">如果设置了此标志，则即使 <strong>FilterUnloadCallback</strong> 成员不是 <strong>NULL</strong>，也不会卸载微筛选器以响应服务停止请求。</td>
</tr>
<tr>
<td align="left"><strong>FLTFL_REGISTRATION_SUPPORT_NPFS_MSFS</strong></td>
<td align="left">如果设置了此标志，则微筛选器将支持筛选命名管道和 mailslot 请求。 此标志是在 Windows 8 中引入的。</td>
</tr>
<tr>
<td align="left"><strong>FLTFL_REGISTRATION_SUPPORT_DAX_VOLUME</strong></td>
<td align="left">如果设置了此标志，则微筛选器将支持附加到直接访问 (DAX) 卷。 这将向筛选器管理器指示微筛选器将筛选 DAX 卷。 此标志是在 Windows 10 版本 1607 中引入的。</td>
</tr>
</tbody></table>
</li>
<li><p><strong>ContextRegistration</strong></p>
<ul>
<li>类型：<code>const FLT_CONTEXT_REGISTRATION*</code></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/fltkernel/ns-fltkernel-_flt_context_registration">FLT_CONTEXT_REGISTRATION</a>结构的可变长度数组，适用于微筛选器使用的每个上下文类型。 数组中的最后一个元素必须是 {FLT_CONTEXT_END}。 此成员是可选的，可以为 <strong>NULL</strong>。</li>
</ul>
</li>
<li><p><strong>OperationRegistration</strong></p>
<ul>
<li><p>类型：<code>const FLT_OPERATION_REGISTRATION*</code></p>
</li>
<li><p>说明： 是 <code>FLT_REGISTRATION</code> 结构体中的一个关键字段，它定义了 Minifilter 驱动支持的所有文件操作及其对应的回调函数。这个字段包含 <code>FLT_OPERATION_REGISTRATION</code> 数组，列出驱动可以处理的所有操作，如文件创建、读取、写入等。 </p>
<p><code>IRP_MJ_CREATE</code>：创建文件</p>
<p><code>IRP_MJ_READ</code>：读取文件</p>
<p><code>IRP_MJ_WRITE</code>：写入文件</p>
<p><code>IRP_MJ_QUERY_INFORMATION</code>：查询文件信息</p>
<p><code>IRP_MJ_SET_INFORMATION</code>：设置文件信息</p>
<p><code>IRP_MJ_CLEANUP</code>：清理文件</p>
<p><code>IRP_MJ_CLOSE</code>：关闭文件</p>
<p><code>IRP_MJ_FLUSH_BUFFERS</code>：刷新文件缓冲区</p>
<p><code>IRP_MJ_QUERY_VOLUME_INFORMATION</code>：查询卷信息</p>
<p><code>IRP_MJ_FILE_SYSTEM_CONTROL</code>：文件系统控制</p>
<p>这样注册：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 操作回调注册数组</span></span><br><span class="line">FLT_OPERATION_REGISTRATION OperationRegistration[] = &#123;</span><br><span class="line">    <span class="comment">// 创建操作：IRP_MJ_CREATE</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_CREATE,                 <span class="comment">// 操作类型：创建文件</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取操作：IRP_MJ_READ</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_READ,                   <span class="comment">// 操作类型：读取文件</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入操作：IRP_MJ_WRITE</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_WRITE,                  <span class="comment">// 操作类型：写入文件</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询文件信息：IRP_MJ_QUERY_INFORMATION</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_QUERY_INFORMATION,      <span class="comment">// 操作类型：查询文件信息</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置文件信息：IRP_MJ_SET_INFORMATION</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_SET_INFORMATION,        <span class="comment">// 操作类型：设置文件信息</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理操作：IRP_MJ_CLEANUP</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_CLEANUP,                <span class="comment">// 操作类型：清理文件</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭文件操作：IRP_MJ_CLOSE</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_CLOSE,                  <span class="comment">// 操作类型：关闭文件</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 刷新缓冲区操作：IRP_MJ_FLUSH_BUFFERS</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_FLUSH_BUFFERS,          <span class="comment">// 操作类型：刷新文件缓冲区</span></span><br><span class="line">        <span class="number">0</span>,                             <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,        <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback       <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询卷信息：IRP_MJ_QUERY_VOLUME_INFORMATION</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_QUERY_VOLUME_INFORMATION, <span class="comment">// 操作类型：查询卷信息</span></span><br><span class="line">        <span class="number">0</span>,                                 <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,            <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback           <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件系统控制操作：IRP_MJ_FILE_SYSTEM_CONTROL</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_FILE_SYSTEM_CONTROL,     <span class="comment">// 操作类型：文件系统控制</span></span><br><span class="line">        <span class="number">0</span>,                               <span class="comment">// 标志：没有特别的标志</span></span><br><span class="line">        MyPreOperationCallback,          <span class="comment">// 前操作回调函数</span></span><br><span class="line">        MyPostOperationCallback         <span class="comment">// 后操作回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作结束标记</span></span><br><span class="line">    &#123; IRP_MJ_OPERATION_END &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>FilterUnloadCallback</strong></p>
<ul>
<li>类型：<code>PFLT_FILTER_UNLOAD_CALLBACK</code></li>
<li>指向类型的例程 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/fltkernel/nc-fltkernel-pflt_filter_unload_callback">的指针，PFLT_FILTER_UNLOAD_CALLBACK</a> 要注册为微筛选器的 <em>FilterUnloadCallback</em> 例程。 此成员是可选的，可以为 <strong>NULL</strong>。 请注意，如果为此例程指定 <strong>NULL</strong> ，则永远无法卸载筛选器</li>
</ul>
</li>
<li><p><strong>InstanceSetupCallback</strong></p>
<ul>
<li><p>类型：<code>PFLT_INSTANCE_SETUP_CALLBACK</code></p>
</li>
<li><p>说明：在加载 Minifilter 驱动时，操作系统会遍历系统中的所有卷设备，并为每个卷设备创建一个实例（实例与卷设备绑定）。每当为卷设备创建一个新实例时，<code>InstanceSetupCallback</code> 就会被调用。此回调函数用于初始化该实例，设置与实例相关的上下文或资源，记录下卷设备的名称，扇区大小等信息.(理解为开始过滤前，进行一波初始化)<br>例如，minifilter的实例只需要附加在指定卷设备，例如d,e,f盘，而不需要在c盘，以下就可以指定</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">FLT_INSTANCE_SETUP_CALLBACK MyInstanceSetupCallback = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MyInstanceSetup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PVOID InstanceContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PVOID* CallbackContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(Data);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(FltObjects);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(InstanceContext);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(CallbackContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取卷设备名称</span></span><br><span class="line">    PDEVICE_OBJECT deviceObject = FltObjects-&gt;Volume-&gt;DeviceObject;</span><br><span class="line">    UNICODE_STRING volumeName;</span><br><span class="line">    <span class="built_in">RtlZeroMemory</span>(&amp;volumeName, <span class="built_in">sizeof</span>(volumeName));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假设你有函数来获取卷的设备路径名称</span></span><br><span class="line">    <span class="comment">// 获取卷路径的方式可能依赖于文件系统</span></span><br><span class="line">    <span class="built_in">GetVolumeName</span>(deviceObject, &amp;volumeName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅在 D:, E:, F: 盘上附加微筛选器</span></span><br><span class="line">    <span class="keyword">if</span> (volumeName.Buffer != <span class="literal">NULL</span> &amp;&amp; </span><br><span class="line">        (<span class="built_in">wcsstr</span>(volumeName.Buffer, <span class="string">L&quot;\\Device\\HarddiskVolumeD&quot;</span>) || </span><br><span class="line">         <span class="built_in">wcsstr</span>(volumeName.Buffer, <span class="string">L&quot;\\Device\\HarddiskVolumeE&quot;</span>) || </span><br><span class="line">         <span class="built_in">wcsstr</span>(volumeName.Buffer, <span class="string">L&quot;\\Device\\HarddiskVolumeF&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;  <span class="comment">// 附加微筛选器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不是 D, E, F 盘，拒绝附加</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>InstanceQueryTeardownCallback</strong></p>
<ul>
<li><p>类型：<code>PFLT_INSTANCE_QUERY_TEARDOWN_CALLBACK</code></p>
</li>
<li><p>说明：指向回调函数的指针，负责在 Minifilter 驱动实例销毁前进行查询操作。该回调允许在销毁实例之前进行清理或状态检查。</p>
<p>筛选器管理器调用此例程以允许微筛选器驱动程序响应手动分离请求。 当用户模式应用程序调用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/fltuser/nf-fltuser-filterdetach">FilterDetach</a> 或内核模式组件调用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltdetachvolume">FltDetachVolume</a> 时，会收到此类请求。</p>
<p>对于自动或强制分离请求，例如，当卸载微筛选器驱动程序或卸载卷时，不会调用此例程。</p>
<p>如果此例程返回错误或警告 <strong>NTSTATUS</strong> 代码（如 <strong>STATUS_FLT_DO_NOT_DETACH</strong>），则微筛选器驱动程序实例不会与卷分离。 否则，将分离实例。</p>
<p>如果微筛选器驱动程序未定义 <em>InstanceQueryTeardownCallback</em> 例程，则无法通过调用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/fltuser/nf-fltuser-filterdetach">FilterDetach</a> 或 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltdetachvolume">FltDetachVolume</a> 手动分离其实例。</p>
<p><strong>（重点：手动卸载才会调用）</strong></p>
</li>
</ul>
</li>
<li><p><strong>InstanceTeardownStartCallback</strong></p>
<ul>
<li><p>类型：<code>PFLT_INSTANCE_TEARDOWN_CALLBACK</code></p>
</li>
<li><p><code>InstanceTeardownStartCallback</code> 是微筛选器驱动程序中一个重要的回调函数，它在微筛选器驱动程序实例拆解（teardown）过程的开始时被调用。这是一个可选的回调函数，你可以在驱动程序中注册它来执行清理工作或其他拆解前的操作。</p>
<p><strong>主要功能：</strong></p>
<ul>
<li><strong>目标</strong>：当微筛选器驱动程序实例准备拆解时，<code>InstanceTeardownStartCallback</code> 允许你处理必须在卸载前完成的任何操作。例如，关闭文件句柄、取消 I&#x2F;O 操作、清理资源等。</li>
<li><strong>拆解顺序</strong>：它的调用发生在 <code>InstanceTeardownCompleteCallback</code> 之前，负责拆解开始时的准备工作</li>
</ul>
</li>
<li><p>需要做的事情：<br>完成挂起的 I&#x2F;O 操作：你需要在此回调中完成微筛选器驱动程序预操作回调中挂起的 I&#x2F;O 操作，或者通过调用 <code>FltCompletePendedPreOperation </code>完成它们。</p>
<p>取消未完成的 I&#x2F;O 操作：如果有挂起的 I&#x2F;O 操作，可能需要通过调用 FltCancelIo 来取消它们，防止它们影响卸载过程。</p>
<p>停止新 I&#x2F;O 操作：此时，微筛选器驱动程序应停止排队新的 I&#x2F;O 操作。</p>
<p>资源清理：例如，关闭打开的文件，确保微筛选器驱动程序的资源准备好被拆解。</p>
</li>
</ul>
</li>
<li><p><strong>InstanceTeardownCompleteCallback</strong></p>
<ul>
<li><p>类型：<code>PFLT_INSTANCE_TEARDOWN_CALLBACK</code></p>
</li>
<li><p>说明：指向回调函数的指针，负责在 Minifilter 驱动实例销毁完成后执行清理工作。此回调会在实例完全销毁后调用。</p>
<p><strong>需要做的</strong></p>
<p>在 <code>InstanceTeardownCompleteCallback</code> 中，驱动程序需要完成以下任务：</p>
<ol>
<li><strong>关闭所有文件句柄</strong>：确保在驱动程序卸载过程中，所有由驱动程序打开的文件被正确关闭。这是必须做的操作。</li>
<li><strong>释放所有资源</strong>：除了关闭文件句柄，还应该释放所有驱动程序使用的其他资源，例如内存、锁等。</li>
<li><strong>清理工作</strong>：执行任何其他必要的清理工作，确保驱动程序实例干净、无残留地卸载。</li>
</ol>
</li>
</ul>
</li>
<li><p><strong>GenerateFileNameCallback</strong></p>
<ul>
<li><p>类型：<code>PFLT_GENERATE_FILE_NAME</code></p>
</li>
<li><p>说明：指向回调函数的指针，负责生成文件路径名。此回调可以用于将文件路径从内部格式转换为外部格式或进行其他路径转换。</p>
<p><code>PFLT_GENERATE_FILE_NAME</code> 回调函数会在预处理（Pre-Operation）和后处理（Post-Operation）回调函数之前被调用，且它主要负责生成或修改文件的路径信息。</p>
</li>
</ul>
</li>
<li><p><strong>NormalizeNameComponentCallback</strong></p>
<ul>
<li>类型：<code>PFLT_NORMALIZE_NAME_COMPONENT</code></li>
<li>说明：指向回调函数的指针，用于处理文件路径组件的规范化。它可以确保文件路径按照标准的格式进行处理。</li>
</ul>
</li>
<li><p><strong>NormalizeContextCleanupCallback</strong></p>
<ul>
<li>类型：<code>PFLT_NORMALIZE_CONTEXT_CLEANUP</code></li>
<li>说明：指向回调函数的指针，负责清理与文件路径规范化过程相关的上下文数据。</li>
</ul>
</li>
<li><p><strong>TransactionNotificationCallback</strong></p>
<ul>
<li>类型：<code>PFLT_TRANSACTION_NOTIFICATION_CALLBACK</code></li>
<li>说明：指向回调函数的指针，用于处理文件 I&#x2F;O 操作中的事务通知。该回调函数可用于在文件操作发生时执行某些事务控制操作。</li>
</ul>
</li>
<li><p><strong>NormalizeNameComponentExCallback</strong></p>
<ul>
<li>类型：<code>PFLT_NORMALIZE_NAME_COMPONENT_EX</code></li>
<li>说明：指向回调函数的指针，扩展的名称组件规范化回调，通常用于处理更复杂的路径和组件规范化操作。</li>
</ul>
</li>
<li><p><strong>SectionNotificationCallback</strong></p>
<ul>
<li>类型：<code>PFLT_SECTION_CONFLICT_NOTIFICATION_CALLBACK</code></li>
<li>说明：指向回调函数的指针，用于处理文件系统中的分区冲突。这种情况通常出现在文件 I&#x2F;O 操作跨越了文件系统或分区的边界时。</li>
</ul>
</li>
</ol>
<p>注册监控回调示例代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> FLT_OPERATION_REGISTRATION fileMonitorCallBacks[]=</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_CREATE,</span><br><span class="line">        FLTFL_OPERATION_REGISTRATION_SKIP_PAGING_IO,</span><br><span class="line">        HOOK_PreNtCreateFile,</span><br><span class="line">        HOOK_PostNtCreateFile,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_CLEANUP,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        HOOK_PreNtCleanup,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        IRP_MJ_WRITE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        HOOK_PreNtWriteFile,</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里要说一下为什么<code>IRP_MJ_CREATE</code>这里，flag要设置为<code>FLTFL_OPERATION_REGISTRATION_SKIP_PAGING_IO</code><br>微软介绍为：</p>
<blockquote>
<p>微筛选器为读取或写入操作设置此标志，以指定不应为分页 I&#x2F;O 操作调用其操作前和操作后回调例程。 此标志仅适用于基于 IRP 的 I&#x2F;O 操作。 对于不基于 IRP 的 I&#x2F;O 操作，将忽略它。 </p>
</blockquote>
<p>首先我们要先介绍下什么是<code>IRP_PAGING_IO</code><br>这是由系统MM发起的</p>
<p><code>IRP_PAGING_IO</code>主要是由系统缓存管理器发起的IO操作，所以对于系统的操作，我们一般不去管</p>
<p>通常IO请求的过程是</p>
<blockquote>
<p><code>IRP_NOCACHE</code> 和 <code>IRP_CACHE</code> 是指 I&#x2F;O 请求是否通过缓存管理器进行数据缓存操作： </p>
</blockquote>
<p>情况1：不开启缓存管理器，App -&gt; IO -&gt; FSD -&gt; DISK</p>
<p>情况2： 开启缓存管理器 ， App（应用程序） -&gt; IO（ I&#x2F;O 管理器） -&gt; FSD（文件系统驱动） -&gt; CC（缓存管理） -&gt; MM（内存管理）（ -&gt; FSD -&gt; DISK（磁盘））</p>
<p>即应用程序发起的读操作会首先经过 I&#x2F;O 管理器，然后由文件系统驱动尝试直接从缓存中读取。缓存未命中时（比如就读写一个字节，那么不会立刻被写入），请求会通过内存管理器加载数据至缓存，最终从磁盘获取数据。 </p>
<p><code>IRP_PAGING_IO</code>：在情况2中，MM会发起一个IRP并标记为 <code>IRP_XXX_PAGING_IO</code>，因为是由MM发起的，是系统干的活，所以我们一般去忽略</p>
<p>minifilter里面没有IRP了，变为<code>PFLT_CALLBACK_DATA</code>，这个就是从IRP来的</p>
<h3 id="Pre回调："><a href="#Pre回调：" class="headerlink" title="Pre回调："></a>Pre回调：</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PFLT_PRE_OPERATION_CALLBACK PfltPreOperationCallback;</span><br><span class="line"></span><br><span class="line"><span class="function">FLT_PREOP_CALLBACK_STATUS <span class="title">PfltPreOperationCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]      PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]     PVOID *CompletionContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>**<code>PFLT_CALLBACK_DATA Data</code>**（输入&#x2F;输出）：</p>
<ul>
<li><code>Data</code> 是指向 <code>FLT_CALLBACK_DATA</code> 结构体的指针，其中包含了关于即将执行的 I&#x2F;O 请求的详细信息，包括操作的类型、缓冲区、目标对象等。</li>
<li>该结构体中的字段可以帮助你获取操作类型（如读取、写入）、请求缓冲区、偏移量等信息。</li>
<li>常用字段：<ul>
<li>**<code>Iopb</code>**：包含请求参数（如偏移量、目标文件、操作缓冲区、长度等）。</li>
<li>**<code>IoStatus</code>**：可以在回调中设置操作的完成状态，比如可以设置为失败状态来阻止操作。</li>
</ul>
</li>
<li>在 <code>PreOperation</code> 回调中，开发者可以使用此结构来修改请求的参数，记录日志，或阻止操作。</li>
</ul>
<p>**<code>PCFLT_RELATED_OBJECTS FltObjects</code>**（输入）：</p>
<ul>
<li><code>FltObjects</code> 是指向 <code>FLT_RELATED_OBJECTS</code> 结构体的指针，包含了与当前 I&#x2F;O 操作有关的对象（例如文件、实例、卷等）。</li>
<li>常用字段包括：<ul>
<li>**<code>Instance</code>**：当前过滤器的实例，可以用来判断在哪个卷上处理该请求。</li>
<li>**<code>FileObject</code>**：与当前操作相关的文件对象，表示目标文件。</li>
<li>**<code>Filter</code>**：当前操作所在的过滤器对象。</li>
</ul>
</li>
<li><code>FltObjects</code> 提供了当前操作的上下文信息，便于判断目标文件、卷或过滤器实例的信息，并对特定的文件或卷执行条件处理。</li>
</ul>
<p>**<code>PVOID \*CompletionContext</code>**（输出）：</p>
<ul>
<li><code>CompletionContext</code> 是一个指向指针的输出参数，用于在 <code>PreOperation</code> 和 <code>PostOperation</code> 之间传递自定义的上下文信息。</li>
<li>你可以在 <code>PreOperation</code> 中分配一个上下文结构，将其地址赋给 <code>CompletionContext</code>，后续会将这个上下文指针传递给 <code>PostOperation</code> 回调，以便在操作完成时执行进一步处理或清理工作。</li>
<li>若不需要传递上下文，设置为 <code>NULL</code> 即可。</li>
</ul>
<p>注意，这里和之前minifilter注册的时候，_FLT_REGISTRATION 有个上下文<code>FLT_CONTEXT_REGISTRATION</code>和Pre回调的上下文是有区别的</p>
<p><strong><code>FLT_CONTEXT_REGISTRATION</code></strong> 是 <strong>全局的、持久的上下文</strong>，通常用于存储长时间的数据或与特定文件对象或筛选器实例相关的数据。它在筛选器生命周期内持续存在，可以在多个回调中使用。</p>
<p><strong><code>CompletionContext</code></strong> 是 <strong>临时的、局部的上下文</strong>，用于在一个操作的预处理和后处理之间传递数据。它是特定操作期间的上下文，不是持久的。</p>
<h4 id="返回值："><a href="#返回值：" class="headerlink" title="返回值："></a><strong>返回值：</strong></h4><p><strong>FLT_PREOP_SUCCESS_WITH_CALLBACK&#96;</strong></p>
<p>表示预操作处理成功，并且希望在该操作完成后调用 <code>PostOperation</code> 回调。</p>
<p>适用于希望在操作结束后执行进一步处理的情况。</p>
<p>会往下传递</p>
<p>在返回 <code>FLT_PREOP_SUCCESS_WITH_CALLBACK</code> 后，操作会<strong>继续往下传递</strong>，传递到文件系统驱动等下层组件后再执行实际的 I&#x2F;O 操作。等到这个操作完成，并且返回到 minifilter 驱动时，才会调用 <code>PostOperation</code> 回调。因此，<code>PostOperation</code> 回调是在 I&#x2F;O 操作传递到下层并执行完成<strong>之后</strong>才会执行的。 </p>
<p><strong>FLT_PREOP_SUCCESS_NO_CALLBACK</strong></p>
<p>表示预操作处理成功，但不需要调用 <code>PostOperation</code> 回调。</p>
<p>适用于不需要进一步处理操作完成情况的场景，返回该值可以减少性能开销。</p>
<p>会往下传递</p>
<p>**FLT_PREOP_PENDING **</p>
<p>表示该操作尚未完成，需要异步处理。</p>
<p>返回此值时，开发者需自行完成 I&#x2F;O 操作，并调用 <code>FltCompletePendedPreOperation</code> 来通知过滤器框架操作已完成。</p>
<p>适用于异步处理或复杂操作场景。</p>
<p><strong>FLT_PREOP_DISALLOW_FASTIO</strong> </p>
<p>表示不允许此操作通过快速 I&#x2F;O (Fast I&#x2F;O) 通道执行，操作将转至标准 I&#x2F;O 路径。</p>
<p>适用于需要绕过快速路径以保证一致性或进行特定处理的场景。</p>
<p><strong>FLT_PREOP_COMPLETE</strong> </p>
<p>表示立即完成此操作，不再传递给下层文件系统。</p>
<p>可用于阻止操作，或自行完成处理（例如返回一个特定错误状态）。</p>
<p><code>IoStatus.Status</code> 和 <code>IoStatus.Information</code> 应在 <code>FLT_CALLBACK_DATA</code> 中设置，以指示操作的结果。</p>
<p>一般我们在Pre做 SandBox,主防，加解密，杀毒引擎等</p>
<p>Pre函数一般通常在 <strong>PASSIVE LEVEL（低级别）</strong> 或 <strong>APC LEVEL</strong> 执行。大部分情况下，它是在 <strong>PASSIVE LEVEL</strong> 下调用的 </p>
<h3 id="Post回调："><a href="#Post回调：" class="headerlink" title="Post回调："></a>Post回调：</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PFLT_POST_OPERATION_CALLBACK PfltPostOperationCallback;</span><br><span class="line"></span><br><span class="line"><span class="function">FLT_POSTOP_CALLBACK_STATUS <span class="title">PfltPostOperationCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]      PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] PVOID CompletionContext,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           FLT_POST_OPERATION_FLAGS Flags</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong></p>
<ol>
<li><p>**<code>PFLT_CALLBACK_DATA Data</code>**（输入&#x2F;输出）：</p>
<ul>
<li><p><code>Data</code> 是指向 <code>FLT_CALLBACK_DATA</code> 结构体的指针，包含了有关正在处理的 I&#x2F;O 操作的详细信息，例如请求的类型、目标对象、缓冲区信息等。</p>
</li>
<li><pre><code class="c++">FLT_CALLBACK_DATA
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">      中常用字段包括：</span><br><span class="line"></span><br><span class="line">     - **`Iopb`**：请求参数块，包含当前操作的详细信息，如操作的文件对象、文件偏移量、缓冲区地址、长度等。</span><br><span class="line">     - **`IoStatus`**：用于表示操作的状态，如成功、失败等。</span><br><span class="line">     - **`RequestorMode`**：指定了请求的模式，用户模式或内核模式。</span><br><span class="line"></span><br><span class="line">   - 通过这个结构体，开发者可以读取、修改 I/O 请求的数据或状态。</span><br><span class="line"></span><br><span class="line">2. **`PCFLT_RELATED_OBJECTS FltObjects`**（输入）：</span><br><span class="line"></span><br><span class="line">   - `FltObjects` 是指向 `FLT_RELATED_OBJECTS` 结构体的指针，该结构体包含了与当前 I/O 操作相关的对象指针。</span><br><span class="line">   - 其中包括：</span><br><span class="line">     - **`Instance`**：当前过滤器的实例，表示当前操作在哪个卷上执行。</span><br><span class="line">     - **`FileObject`**：文件对象指针，代表当前操作的目标文件。</span><br><span class="line">     - **`Filter`**：当前调用的过滤器对象。</span><br><span class="line">     - **`Volume`**：表示此 I/O 操作所在的卷对象。</span><br><span class="line">   - 通过这些对象，开发者可以获取到有关当前操作目标的上下文，从而实现对卷、文件的操作和判断。</span><br><span class="line"></span><br><span class="line">3. **`PVOID CompletionContext`**（可选）：</span><br><span class="line"></span><br><span class="line">   - `CompletionContext` 用于在前后操作回调之间传递自定义的上下文信息。通常由前置回调函数 (`PreOperation`) 提供，用来在后置回调函数中完成某些清理工作或共享信息。</span><br><span class="line">   - 该值的类型是 `PVOID`，因此可以指向任何类型的数据结构，比如某种操作的状态信息、标志位等。</span><br><span class="line"></span><br><span class="line">4. **`FLT_POST_OPERATION_FLAGS Flags`**（输入）：</span><br><span class="line"></span><br><span class="line">   - `Flags` 是 `FLT_POST_OPERATION_FLAGS` 枚举，指示了操作完成时的一些附加信息或标志。</span><br><span class="line">   - 主要标志：</span><br><span class="line">     - **`FLTFL_POST_OPERATION_DRAINING`**：表示驱动栈正在关闭，回调可能在清理过程中被调用。</span><br><span class="line">     - **`FLTFL_POST_OPERATION_SYNCHRONIZE`**：指示后置回调是同步的，即与原始操作同一线程执行。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### **返回值：**</span><br><span class="line"></span><br><span class="line">**FLT_POSTOP_FINISHED_PROCESSING** </span><br><span class="line"></span><br><span class="line">表示后操作处理已完成，不需要进一步处理。</span><br><span class="line"></span><br><span class="line">适用于无需延迟操作或后续异步处理的情况。</span><br><span class="line"></span><br><span class="line"> 微筛选器驱动程序已完成 I/O 操作的处理，并将操作的控制权返回给筛选器管理器。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**FLT_POSTOP_MORE_PROCESSING_REQUIRED** </span><br><span class="line"></span><br><span class="line">表示需要进一步的处理，通常用于异步操作。</span><br><span class="line"></span><br><span class="line">在 `PostOperation` 回调函数中返回 `FLT_POSTOP_MORE_PROCESSING_REQUIRED` 后，Minifilter 框架会等待 minifilter 驱动通过调用特定的 API 来指示何时完成进一步的处理。通常情况下，你需要在另一个上下文中（例如在工作线程或其他延迟执行的环境中）完成进一步的处理，最后通过调用 `FltCompletePendedPostOperation` 来通知框架该操作处理已结束。 </span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line">FLT_POSTOP_CALLBACK_STATUS PostOperationCallback(</span><br><span class="line">    PFLT_CALLBACK_DATA Data,</span><br><span class="line">    PCFLT_RELATED_OBJECTS FltObjects,</span><br><span class="line">    PVOID CompletionContext,</span><br><span class="line">    FLT_POST_OPERATION_FLAGS Flags</span><br><span class="line">) &#123;</span><br><span class="line">    // 判断是否需要延迟处理</span><br><span class="line">    if (需要延迟处理) &#123;</span><br><span class="line">        // 启动异步处理（例如将工作项加入系统队列）</span><br><span class="line">        FltQueueDeferredIoWorkItem(...);</span><br><span class="line">        // 返回 MORE_PROCESSING_REQUIRED，表明稍后会完成操作</span><br><span class="line">        return FLT_POSTOP_MORE_PROCESSING_REQUIRED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 立即完成操作的情况</span><br><span class="line">    return FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 在工作线程中完成延迟处理</span><br><span class="line">VOID DeferredPostOperationWorkItemRoutine(PFLT_CALLBACK_DATA Data) &#123;</span><br><span class="line">    // 进行延迟处理...</span><br><span class="line"></span><br><span class="line">    // 处理完成后调用 FltCompletePendedPostOperation 完成操作</span><br><span class="line">    FltCompletePendedPostOperation(Data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="判断Data是什么操作的宏："><a href="#判断Data是什么操作的宏：" class="headerlink" title="判断Data是什么操作的宏："></a>判断Data是什么操作的宏：</h2><p><code>FLT_IS_IRP_OPERATION</code>:<br>判断操作是否为 I&#x2F;O 请求包（IRP）。<br>IRP 操作涉及标准文件系统操作，例如文件创建、读写、关闭等。</p>
<p><code>FLT_IS_FASTIO_OPERATION</code>:<br>判断操作是否为快速 I&#x2F;O（Fast I&#x2F;O）请求。<br>Fast I&#x2F;O 是一种优化方式，绕过常规 IRP 通道执行文件操作，适用于较简单的读写操作。</p>
<p>&#96;&#96;FLT_IS_FS_FILTER_OPERATION&#96;:<br>判断操作是否为文件系统过滤操作（FS Filter）。<br>FS Filter 操作通常用于文件系统驱动间的特殊通信，处理缓存、加密、压缩等请求。</p>
<h2 id="Minifilter的启动"><a href="#Minifilter的启动" class="headerlink" title="Minifilter的启动"></a>Minifilter的启动</h2><p>简化代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">initFileMonitor</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">FltRegisterFilter</span>(</span><br><span class="line">        DriverObject,</span><br><span class="line">        &amp;fileMonitorRegistration,</span><br><span class="line">        &amp;g_pFilter</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">startFileMonitor</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_pFilter)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">FltStartFiltering</span>(g_pFilter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;<span class="comment">//STATUS_INSUFFICIENT_RESOURCES 是一个 NTSTATUS 错误代码，表示系统资源不足，导致无法完成请求的操作。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">stopFileMonitor</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_pFilter)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">FltUnregisterFilter</span>(g_pFilter);</span><br><span class="line">        g_pFilter = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="Nullfilter安装"><a href="#Nullfilter安装" class="headerlink" title="Nullfilter安装"></a>Nullfilter安装</h2><h3 id="inf文件安装"><a href="#inf文件安装" class="headerlink" title="inf文件安装"></a>inf文件安装</h3><p>首先我们要知道什么叫<code>inf</code>文件</p>
<p>在Windows文件系统的Minifilter驱动程序中，<code>.inf</code>文件是安装信息文件，它用来描述驱动的安装方式，包括注册表设置、文件拷贝、设备驱动安装等。总之就是<code>.inf</code>文件会告诉系统如何安装和配置Minifilter驱动。它可以包含以下信息：</p>
<ol>
<li><strong>服务注册</strong>：定义服务的名称、类型、启动方式等。</li>
<li><strong>拷贝文件</strong>：指定驱动文件（<code>.sys</code>文件）和其他必要的文件应该复制到什么位置。</li>
<li><strong>注册表设置</strong>：配置与驱动相关的注册表键值，如用于Minifilter驱动的实例化和加载的配置信息。</li>
<li><strong>安装顺序</strong>：定义在系统加载时如何初始化和加载Minifilter。</li>
</ol>
<p><code>.inf</code>文件的核心作用就是简化和自动化Minifilter驱动的安装过程，避免手动配置注册表或移动文件。</p>
<p>我们不必自己写，了解下原理拿别人的稍微改改即可</p>
<p>首先我们来分析一下nullfilter的inf文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">;;;</span><br><span class="line">;;; NullFilter</span><br><span class="line">;;;</span><br><span class="line">;;;</span><br><span class="line">;;; Copyright (c) 1999 - 2002, Microsoft Corporation</span><br><span class="line">;;;</span><br><span class="line"></span><br><span class="line">[Version]</span><br><span class="line">Signature   = &quot;$Windows NT$&quot; ;标识安装文件格式适用于 Windows NT。</span><br><span class="line">Class       = &quot;ActivityMonitor&quot;        ;指定驱动的类别名称为 &quot;ActivityMonitor&quot;，用于表示这是一个监控类的文件系统驱动。</span><br><span class="line">ClassGuid   = &#123;b86dff51-a31e-4bac-b3cf-e8cfe75c9fc2&#125;    ;为该类指定唯一的 GUID 标识符。</span><br><span class="line">Provider    = %ProviderString% ;提供商的字符串信息，此处定义为 TODO-Set-Provider。</span><br><span class="line">DriverVer   = 06/16/2007,1.0.0.0;驱动的版本信息，包含日期和版本号。</span><br><span class="line">CatalogFile = nullfilter.cat;安装时需要的 .cat 文件（nullfilter.cat），用于驱动签名和验证。</span><br><span class="line">PnpLockdown = 1;指定即插即用设备的限制级别。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;定义源文件和安装盘的信息，nullfilter.sys 是主驱动文件。</span><br><span class="line">[SourceDisksFiles]</span><br><span class="line">nullfilter.sys = 1,,</span><br><span class="line"></span><br><span class="line">[SourceDisksNames]</span><br><span class="line">1 = %DiskId1%,,,</span><br><span class="line"></span><br><span class="line">[DestinationDirs]	;12 代表 system32\drivers，13 代表驱动程序存储目录。</span><br><span class="line">NullFilterDownlevel.CopyDriverFiles  = 12            ;%windir%\system32\drivers</span><br><span class="line">NullFilterDownlevel.DelDriverFiles   = 12            ;%windir%\system32\drivers</span><br><span class="line">NullFilter.DriverFiles               = 13            ;driver store</span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line">;; Default install sections</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">[DefaultInstall.NTamd64.10.0...25952]</span><br><span class="line">OptionDesc  = %ServiceDescription%</span><br><span class="line">CopyFiles   = NullFilter.DriverFiles </span><br><span class="line"></span><br><span class="line">[DefaultInstall.NTamd64.10.0...25952.Services]</span><br><span class="line">AddService  = %ServiceName%,,NullFilter.Service ;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line">; Support sections</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">[NullFilter.Service]</span><br><span class="line">DisplayName      = %ServiceName%</span><br><span class="line">Description      = %ServiceDescription%</span><br><span class="line">ServiceBinary    = %13%\%DriverName%.sys    ;%windir%\system32\drivers\    指定驱动文件的位置。</span><br><span class="line">Dependencies     = &quot;FltMgr&quot;  ;表示依赖的服务，此处是 &quot;FltMgr&quot;（文件系统过滤管理器）。</span><br><span class="line">ServiceType      = 2                        ;SERVICE_FILE_SYSTEM_DRIVER  表示文件系统驱动。</span><br><span class="line">StartType        = 3                        ;SERVICE_DEMAND_START  表示按需启动（即手动启动）。</span><br><span class="line">ErrorControl     = 1                        ;SERVICE_ERROR_NORMAL  </span><br><span class="line">LoadOrderGroup   = &quot;FSFilter Activity Monitor&quot;  ;设置加载顺序组为 &quot;FSFilter Activity Monitor&quot;。</span><br><span class="line">AddReg           = NullFilter.AddRegistry  ;指定与服务相关的注册表键（由 NullFilter.AddRegistry 定义）</span><br><span class="line"></span><br><span class="line">[NullFilter.AddRegistry]  ;配置该驱动实例的注册表信息。</span><br><span class="line">HKR,&quot;Parameters&quot;,&quot;SupportedFeatures&quot;,0x00010001,0x3  ;设置驱动支持的功能。</span><br><span class="line">HKR,&quot;Parameters\Instances&quot;,&quot;DefaultInstance&quot;,0x00000000,%DefaultInstance%  ;设置默认实例名称。</span><br><span class="line">HKR,&quot;Parameters\Instances\&quot;%Instance1.Name%,&quot;Altitude&quot;,0x00000000,%Instance1.Altitude%  ;配置实例的 &quot;Altitude&quot; 和 &quot;Flags&quot; 属性，用于控制Minifilter驱动的加载顺序和自动附加行为。</span><br><span class="line">HKR,&quot;Parameters\Instances\&quot;%Instance1.Name%,&quot;Flags&quot;,0x00010001,%Instance1.Flags%</span><br><span class="line"></span><br><span class="line">[NullFilter.DriverFiles]</span><br><span class="line">%DriverName%.sys  ;定义复制到目标系统的驱动文件（nullfilter.sys）。</span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line">;; Downlevel default install sections</span><br><span class="line">;;</span><br><span class="line">;下层支持安装部分（Downlevel Sections）</span><br><span class="line">;这些部分用于向旧版 Windows 提供兼容支持，定义了下层系统的驱动文件复制、服务配置等。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[DefaultInstall.NTamd64]</span><br><span class="line">OptionDesc  = %ServiceDescription%</span><br><span class="line">CopyFiles   = NullFilterDownlevel.CopyDriverFiles</span><br><span class="line"></span><br><span class="line">[DefaultInstall.NTamd64.Services]</span><br><span class="line">AddService  = %ServiceName%,,NullFilterDownlevel.Service</span><br><span class="line"></span><br><span class="line">; 下层支持卸载部分</span><br><span class="line"></span><br><span class="line">[DefaultUninstall.NTamd64]</span><br><span class="line">LegacyUninstall = 1</span><br><span class="line">DelFiles        = NullFilterDownlevel.DelDriverFiles</span><br><span class="line"></span><br><span class="line">[DefaultUninstall.NTamd64.Services]</span><br><span class="line">DelService      = %ServiceName%,0x200      ;确保在删除之前停止服务</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line">; Downlevel support sections</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">[NullFilterDownlevel.Service]</span><br><span class="line">DisplayName      = %ServiceName%</span><br><span class="line">Description      = %ServiceDescription%</span><br><span class="line">ServiceBinary    = %12%\%DriverName%.sys    ;%windir%\system32\drivers\</span><br><span class="line">Dependencies     = &quot;FltMgr&quot;</span><br><span class="line">ServiceType      = 2                        ;SERVICE_FILE_SYSTEM_DRIVER</span><br><span class="line">StartType        = 3                        ;SERVICE_DEMAND_START</span><br><span class="line">ErrorControl     = 1                        ;SERVICE_ERROR_NORMAL</span><br><span class="line">LoadOrderGroup   = &quot;FSFilter Activity Monitor&quot;</span><br><span class="line">AddReg           = NullFilterDownlevel.AddRegistry</span><br><span class="line"></span><br><span class="line">[NullFilterDownlevel.AddRegistry]</span><br><span class="line">HKR,,&quot;SupportedFeatures&quot;,0x00010001,0x3</span><br><span class="line">HKR,&quot;Instances&quot;,&quot;DefaultInstance&quot;,0x00000000,%DefaultInstance%</span><br><span class="line">HKR,&quot;Instances\&quot;%Instance1.Name%,&quot;Altitude&quot;,0x00000000,%Instance1.Altitude%</span><br><span class="line">HKR,&quot;Instances\&quot;%Instance1.Name%,&quot;Flags&quot;,0x00010001,%Instance1.Flags%</span><br><span class="line"></span><br><span class="line">[NullFilterDownlevel.CopyDriverFiles]</span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line">[NullFilterDownlevel.DelDriverFiles]</span><br><span class="line">%DriverName%.sys</span><br><span class="line"></span><br><span class="line">;;</span><br><span class="line">;; String Section</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">[Strings]  ;该部分定义了 .inf 文件中使用的字符串变量。</span><br><span class="line">ProviderString          = &quot;TODO-Set-Provider&quot;</span><br><span class="line">ServiceDescription      = &quot;NullFilter mini-filter driver&quot;</span><br><span class="line">ServiceName             = &quot;NullFilter&quot;</span><br><span class="line">DriverName              = &quot;NullFilter&quot;</span><br><span class="line">DiskId1                 = &quot;NullFilter Device Installation Disk&quot;</span><br><span class="line"></span><br><span class="line">;Instances specific information.</span><br><span class="line">DefaultInstance         = &quot;Null Instance&quot;</span><br><span class="line">Instance1.Name          = &quot;Null Instance&quot;</span><br><span class="line">Instance1.Altitude      = &quot;370020&quot;</span><br><span class="line">Instance1.Flags         = 0x1          ; Suppress automatic attachments</span><br></pre></td></tr></table></figure>



<p>以上有一个很坑的点，将所有 NT$ARCH$ 替换为 NTamd64（表示 x64 架构）。从Github脱下来的代码都是ARCH的，这一点要自己手动改改。</p>
<p>[Version]中的<code>class</code>和<code>GUID</code>查看以下链接</p>
<p> <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/install/system-defined-device-setup-classes-available-to-vendors">为供应商提供的系统定义的设备安装程序类 - Windows drivers | Microsoft Learn</a> </p>
<p>如果是自己写的<code>minifilter</code>，直接在<code>[String]</code>这里改一改就好了</p>
<p>必须修改的有</p>
<p>**<code>ServiceName</code>**：  每个 Minifilter 在系统中需要唯一的服务名称，这样才能在服务控制器中分别管理它们。 </p>
<p>**<code>DriverName</code>**不同的 Minifilter 需要有各自唯一的驱动文件名，以防止文件名冲突。 </p>
<p><strong><code>Instance1.Name</code></strong> 和 **<code>DefaultInstance</code>**：  每个 Minifilter 实例在系统中也需要唯一的名称。 </p>
<p>**<code>Instance1.Altitude</code>**：  Minifilter 驱动的 <code>Altitude</code> 值必须是唯一的，以确定它在文件过滤栈中的相对位置。 </p>
<p>然后把编译好的驱动，和Inf文件放在同一个文件夹</p>
<p><img src="/Minifilter/1731458444190.png" alt="1731458444190"></p>
<p>在inf文件右键，即可安装</p>
<p><img src="/Minifilter/1731458517564.png" alt="1731458517564"></p>
<p>具体有没有成功，可以看&#x2F;Windows&#x2F;System32&#x2F;Driver目录里面有没有我们的nullfilter.sys，这里可以看到已经进入目录了</p>
<p><img src="/Minifilter/1731458618230.png" alt="1731458618230"></p>
<p>然后再看看注册表</p>
<p> <code>.inf</code> 文件中没有明确指定 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\</code> 这一完整路径，因为它是安装服务的默认注册表路径。Windows 系统会自动将所有在 <code>[Service]</code> 和 <code>[AddService]</code> 部分指定的服务，注册到 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\</code> 下。 </p>
<p><img src="/Minifilter/1731460139496.png" alt="1731460139496"></p>
<p>都做好之后，就是安装这个nullfilter了</p>
<p>用管理员权限打开cmd,安装的命令是</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> <span class="built_in">start</span> nullfilter</span><br></pre></td></tr></table></figure>



<p>卸载的命令是：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> stop nullfilter</span><br></pre></td></tr></table></figure>

<p><img src="/Minifilter/1731460577174.png" alt="1731460577174"></p>
<h3 id="可执行程序安装"><a href="#可执行程序安装" class="headerlink" title="可执行程序安装"></a>可执行程序安装</h3><p>后续补….</p>
<h2 id="参数数据的获取"><a href="#参数数据的获取" class="headerlink" title="参数数据的获取"></a>参数数据的获取</h2><h3 id="从PFLT-CALLBACK-DATA获取"><a href="#从PFLT-CALLBACK-DATA获取" class="headerlink" title="从PFLT_CALLBACK_DATA获取"></a>从PFLT_CALLBACK_DATA获取</h3><p>从<code>PFLT_CALLBACK_DATA</code>这个结构我们能拿到什么？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltKernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PFLT_CALLBACK_DATA Data;  <span class="comment">// 假设 Data 是从回调函数中传入的参数</span></span><br><span class="line">PEPROCESS processObject = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前进程对象</span></span><br><span class="line"><span class="keyword">if</span> (Data-&gt;Thread)</span><br><span class="line">&#123;</span><br><span class="line">    processObject = <span class="built_in">IoThreadToProcess</span>(Data-&gt;Thread);</span><br><span class="line">&#125; <span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line">    processObject = <span class="built_in">PsGetCurrentProcess</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前进程的 PID</span></span><br><span class="line">ULONG pid = <span class="built_in">HandleToUlong</span>(<span class="built_in">PsGetProcessId</span>(processObject));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 I/O 状态</span></span><br><span class="line">Data-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;<span class="comment">//（给上层调用者或发起 I/O 操作的进程看的 ） </span></span><br><span class="line">Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 FltObjects 中的信息</span></span><br><span class="line">PFLT_VOLUME Volume = FltObjects-&gt;Volume;<span class="comment">//卷设备</span></span><br><span class="line">PFLT_INSTANCE Instance = FltObjects-&gt;Instance;<span class="comment">//实例对象，指向当前过滤器的实例</span></span><br><span class="line">PFILE_OBJECT FileObject = FltObjects-&gt;FileObject;<span class="comment">//文件对象</span></span><br><span class="line">PDEVICE_OBJECT DeviceObject = FileObject-&gt;DeviceObject;<span class="comment">//设备对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取读取操作相关信息</span></span><br><span class="line">PMDL pReadMdl = Data-&gt;Iopb-&gt;Parameters.Read.MdlAddress;<span class="comment">//MDL 地址</span></span><br><span class="line">PVOID pReadBuffer = Data-&gt;Iopb-&gt;Parameters.Read.ReadBuffer;<span class="comment">//读取缓冲区地址</span></span><br><span class="line">ULONG uReadLength = Data-&gt;Iopb-&gt;Parameters.Read.Length;<span class="comment">//读取缓冲区长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取创建操作的安全上下文</span></span><br><span class="line">ACCESS_MASK DesiredAccess = Data-&gt;Iopb-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess;<span class="comment">//访问权限，通过 DesiredAccess 字段可以获取或设置当前创建请求的所需访问权限。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取查询操作相关信息</span></span><br><span class="line">PVOID pQueryBuffer = Data-&gt;Iopb-&gt;Parameters.DirectoryControl.QueryDirectory.DirectoryBuffer;<span class="comment">//查询目录的缓冲区</span></span><br><span class="line">ULONG uQueryBufferSize = Data-&gt;Iopb-&gt;Parameters.DirectoryControl.QueryDirectory.Length;<span class="comment">//查询目录的缓冲区长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回 FLT_PREOP_COMPLETE 表示操作完成，给Minifilter管理器看的</span></span><br><span class="line"><span class="keyword">return</span> FLT_PREOP_COMPLETE;</span><br></pre></td></tr></table></figure>

<p>当前进程信息 ， I&#x2F;O 状态信息 ， 卷、实例、文件对象及设备对象 ， 读取操作相关信息 ， 安全上下文 ， 查询操作相关信息 ， 返回状态</p>
<h3 id="获取操作的文件路径"><a href="#获取操作的文件路径" class="headerlink" title="获取操作的文件路径"></a>获取操作的文件路径</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在postcreate里获取文件路径</span></span><br><span class="line">PFLT_FILE_NAME_INFORMATION pNameInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">ntStatus = <span class="built_in">FltGetFileNameInformation</span>(</span><br><span class="line">    Data,</span><br><span class="line">    FLT_FILE_NAME_NORMALIZED | FLT_FILE_NAME_QUERY_DEFAULT,</span><br><span class="line">    &amp;pNameInfo</span><br><span class="line">);</span><br><span class="line"><span class="built_in">FltParseFileNameInformation</span>(pNameInfo);</span><br><span class="line"></span><br><span class="line">pNameInfo-&gt;Name;<span class="comment">//这里可以提取出信息</span></span><br><span class="line">pNameInfo-&gt;Volume;</span><br><span class="line"></span><br><span class="line"><span class="built_in">FltReleaseFileNameInformation</span>(pNameInfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重命名路径的获取</span></span><br><span class="line">PFILE_RENAME_INFORMATION pFileRenameInformation = (PFILE_RENAME_INFORMATION)Data-&gt;Iopb-&gt;Parameters.SetFileInformation.InfoBuffer;</span><br><span class="line"></span><br><span class="line">FltGetDestinationFileNameInformation <span class="comment">// 重命名路径获取</span></span><br></pre></td></tr></table></figure>

<p><code>FltGetFileNameInformation</code>：此函数通过 <code>Data</code>（即 <code>PFLT_CALLBACK_DATA</code> 类型）来提取文件名信息，并将信息存储在 <code>pNameInfo</code> 指针指向的结构中。参数 <code>FLT_FILE_NAME_NORMALIZED | FLT_FILE_NAME_QUERY_DEFAULT</code> 指示返回标准化的路径。 <code>FltParseFileNameInformation</code>：进一步解析文件名信息，将提取的内容填入 <code>pNameInfo</code> 的 <code>Name</code> 和 <code>Volume</code> 字段。</p>
<p><code>FltReleaseFileNameInformation</code>：在使用完 <code>pNameInfo</code> 后，必须调用此函数来释放分配的内存，避免内存泄漏。</p>
<p><strong>重命名路径的获取</strong>：当文件被重命名时，需要获取新的文件名信息。代码通过 <code>PFILE_RENAME_INFORMATION</code> 类型的指针 <code>pFileRenameInformation</code> 来访问新文件名信息。 </p>
<h2 id="Minifilter上下文"><a href="#Minifilter上下文" class="headerlink" title="Minifilter上下文"></a>Minifilter上下文</h2><h3 id="上下文的介绍和分类"><a href="#上下文的介绍和分类" class="headerlink" title="上下文的介绍和分类"></a>上下文的介绍和分类</h3><p>Context上下文：其实就是附着在某个对象上的一段内存，内存缓存相关数据，这段数据由自己定义</p>
<p>举个例子，对象就是一个人，上下文就是对应这个人的口袋，里面有钱包，手机啥的，这是一个人几乎必须要带在身上的，而不是需要的时候再冲回家拿</p>
<p><strong>Stream Context</strong> :</p>
<p>这是绑定在<code>FILE CONTROL BLOCK</code>的上下文，文件和FCB是一对一的关系，FCB主要用于文件系统内部， 存储文件的物理信息、文件属性、大小、路径等 。用于处理与磁盘存储相关的操作，像文件的读写、位置定位等。 </p>
<p><strong>FCB</strong> 主要与文件系统相关，存储文件的磁盘元数据，关注文件的物理存储和属性，管理文件的全局状态。它与文件系统的底层操作紧密相关。 </p>
<p>从<code>FltGetStreamContext</code>可以拿到</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS FLTAPI <span class="title">FltGetStreamContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PFLT_INSTANCE Instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PFILE_OBJECT  FileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PFLT_CONTEXT  *Context</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>






<p><strong>Stream Handle Context</strong> </p>
<p>绑定在FO（File Object）的上下文，一个文件可以对应多个FO，属于一对多的关系。File Object存储文件的访问信息、当前读写位置、文件句柄、权限等 </p>
<p><strong>FO</strong> 是文件在内存中的表示，关注文件在进程中的使用和访问。每个打开的文件在每个进程中都会有一个 <code>FO</code>，它存储了文件的状态、读写偏移、句柄等。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS FLTAPI <span class="title">FltGetFileContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PFLT_INSTANCE Instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PFILE_OBJECT  FileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PFLT_CONTEXT  *Context</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>









<p><strong>Instance Context</strong> </p>
<p>与 Minifilter 实例相关的上下文，允许您存储有关 Minifilter 驱动程序实例的全局状态信息。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS FLTAPI <span class="title">FltGetInstanceContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  PFLT_INSTANCE Instance,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] PFLT_CONTEXT  *Context</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>



<p><strong>Volume Context</strong> </p>
<p>在一个与磁盘卷相关的过滤操作中，<code>Volume Context</code> 可以用于存储与该卷的 I&#x2F;O 操作、缓存状态、挂载信息等相关的上下文。</p>
<p>用于与磁盘卷相关的上下文，通常在与卷的操作（例如卷的挂载或卸载）相关时使用。 </p>
<p>使用 <code>FltGetVolumeContext()</code> 获取与磁盘卷相关的上下文。</p>
<p>通过 <code>FltObjects-&gt;Volume</code> 可以获取卷对象，再通过该对象获取卷上下文。</p>
<p><code>FltAllocateContext</code> 用于分配一个新的上下文对象。 这是一块内存，存着某个对象的具体信息</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PFLT_CONTEXT streamContext;</span><br><span class="line">NTSTATUS status;</span><br><span class="line">status = <span class="built_in">FltAllocateContext</span>(</span><br><span class="line">    gFilterHandle,            <span class="comment">// minifilter 驱动程序的过滤器句柄</span></span><br><span class="line">    FLT_STREAM_CONTEXT,       <span class="comment">// 上下文类型</span></span><br><span class="line">    <span class="built_in">sizeof</span>(MY_STREAM_CONTEXT), <span class="comment">// 上下文大小</span></span><br><span class="line">    NonPagedPool,             <span class="comment">// 内存池类型</span></span><br><span class="line">    &amp;streamContext            <span class="comment">// 返回的上下文对象指针</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h3 id="注册上下文的过程："><a href="#注册上下文的过程：" class="headerlink" title="注册上下文的过程："></a>注册上下文的过程：</h3><p>1.定义上下文类型：</p>
<p>可以通过 FLT_CONTEXT_REGISTRATION 数组来定义您的上下文类型，并将其传递给 FltRegisterContext。还可以创建上下文回调函数 （可选） </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FLT_CONTEXT_REGISTRATION ContextRegistration[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sizeof</span>(FLT_CONTEXT_REGISTRATION),  <span class="comment">// 结构大小</span></span><br><span class="line">        FLT_STREAM_CONTEXT,               <span class="comment">// 上下文类型</span></span><br><span class="line">        StreamContextCleanup,             <span class="comment">// 可选的清理回调</span></span><br><span class="line">        StreamContextAllocate,            <span class="comment">// 可选的分配回调</span></span><br><span class="line">        <span class="number">0</span>,                                <span class="comment">// 标志</span></span><br><span class="line">        <span class="literal">NULL</span>                              <span class="comment">// 可选的时间戳回调</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="number">0</span>&#125;  <span class="comment">// 终结符，表示注册表结束</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里的Cleanup是用来清理申请到的指针，不是用来清理自己上下文的</p>
<p>2.注册上下文</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS Status;</span><br><span class="line">Status = <span class="built_in">FltRegisterContext</span>(</span><br><span class="line">    Filter,                   <span class="comment">// Minifilter 驱动程序的过滤器实例</span></span><br><span class="line">    &amp;ContextRegistration[<span class="number">0</span>],  <span class="comment">// 上下文注册表</span></span><br><span class="line">    &amp;gStreamContextRegHandle  <span class="comment">// 保存注册句柄</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>分配和释放上下文 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分配上下文</span></span><br><span class="line">PFLT_CONTEXT pContext = <span class="literal">NULL</span>;</span><br><span class="line">Status = <span class="built_in">FltAllocateContext</span>(</span><br><span class="line">    Filter,                 <span class="comment">// Minifilter 驱动程序的过滤器实例</span></span><br><span class="line">    FLT_STREAM_CONTEXT,     <span class="comment">// 上下文类型</span></span><br><span class="line">    &amp;pContext               <span class="comment">// 返回的上下文指针</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">    <span class="comment">// 使用上下文</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放上下文</span></span><br><span class="line"><span class="built_in">FltReleaseContext</span>(pContext);</span><br></pre></td></tr></table></figure>





<h3 id="Context的使用示例"><a href="#Context的使用示例" class="headerlink" title="Context的使用示例"></a>Context的使用示例</h3><p>代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_INSTANCE_CONTEXT</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; INSTANCE_CONTEXT, *PINSTANCE_CONTEXT;</span><br><span class="line"></span><br><span class="line">PINSTANCE_CONTEXT pContext = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分配与设置</span></span><br><span class="line">ntStatus = <span class="built_in">FltGetInstanceContext</span>(FltObjects-&gt;Instance, &amp;pContext);<span class="comment">//首先尝试获取上下文</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(ntStatus) == FALSE) &#123;</span><br><span class="line">    ntStatus = <span class="built_in">FltAllocateContext</span>(g_Filter, FLT_INSTANCE_CONTEXT, </span><br><span class="line">                                  <span class="built_in">sizeof</span>(INSTANCE_CONTEXT), </span><br><span class="line">                                  PagedPool, &amp;pContext);<span class="comment">//如果获取失败，则重新分配</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(Status) == FALSE) &#123;</span><br><span class="line">        <span class="keyword">return</span> ntStatus;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">RtlZeroMemory</span>(pContext, <span class="built_in">sizeof</span>(INSTANCE_CONTEXT));</span><br><span class="line">&#125;</span><br><span class="line">pContext-&gt;m_DeviceType = VolumeDeviceType;<span class="comment">//保存在上下文</span></span><br><span class="line">pContext-&gt;m_FSType = VolumeFilesystemType;</span><br><span class="line"><span class="built_in">FltSetInstanceContext</span>(FltObjects-&gt;Instance, FLT_SET_CONTEXT_REPLACE_IF_EXISTS, </span><br><span class="line">                      pContext, <span class="literal">NULL</span>);<span class="comment">//绑定上去</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pContext) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">FltReleaseContext</span>(pContext); <span class="comment">//释放引用计数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放访问</span></span><br><span class="line">PINSTANCE_CONTEXT pContext2 = <span class="literal">NULL</span>;</span><br><span class="line">Status = <span class="built_in">FltGetInstanceContext</span>(FltObjects-&gt;Instance, &amp;pContext2);<span class="comment">//现在就可以从这个Instance访问到上下文了</span></span><br><span class="line">pContext2-&gt;xxx = xxx;</span><br></pre></td></tr></table></figure>

<p>拿到上下文记得要Release掉</p>
<h2 id="R3和R0的通讯"><a href="#R3和R0的通讯" class="headerlink" title="R3和R0的通讯"></a>R3和R0的通讯</h2><h3 id="R3给R0发信息"><a href="#R3给R0发信息" class="headerlink" title="R3给R0发信息"></a>R3给R0发信息</h3><p>驱动代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltKernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dontuse.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义全局通信端口指针</span></span><br><span class="line">PFLT_PORT g_ServerPort = <span class="literal">NULL</span>;  <span class="comment">// 用于保存服务器端的端口</span></span><br><span class="line">PFLT_PORT g_ClientPort = <span class="literal">NULL</span>;  <span class="comment">// 用于保存客户端连接的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息处理回调函数，接收来自用户模式的消息</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MinifilterMessageCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ConnectionCookie,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID InputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG InputBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID OutputBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG OutputBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    PULONG ReturnOutputBufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ConnectionCookie);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出接收到消息的调试信息</span></span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;Received message from user mode\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查输出缓冲区是否足够大，如果足够则返回消息</span></span><br><span class="line">    <span class="keyword">if</span> (OutputBuffer &amp;&amp; OutputBufferSize &gt;= <span class="built_in">sizeof</span>(<span class="string">&quot;Hello from Kernel&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">RtlCopyMemory</span>(OutputBuffer, <span class="string">&quot;Hello from Kernel&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;Hello from Kernel&quot;</span>));</span><br><span class="line">        *ReturnOutputBufferLength = <span class="built_in">sizeof</span>(<span class="string">&quot;Hello from Kernel&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端连接回调函数，保存客户端的连接端口</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">MinifilterConnectCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ConnectionCookie,</span></span></span><br><span class="line"><span class="params"><span class="function">    PFLT_PORT ClientPort</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ConnectionCookie);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存客户端端口，供后续通信使用</span></span><br><span class="line">    g_ClientPort = ClientPort;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;User mode connected\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端断开连接回调函数，关闭客户端端口</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">MinifilterDisconnectCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ConnectionCookie);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查客户端端口是否存在，如果存在则关闭它</span></span><br><span class="line">    <span class="keyword">if</span> (g_ClientPort) &#123;</span><br><span class="line">        <span class="built_in">FltCloseClientPort</span>(g_FilterHandle, &amp;g_ClientPort);</span><br><span class="line">        g_ClientPort = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;User mode disconnected\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动入口函数，初始化过滤器并创建通信端口</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    UNICODE_STRING portName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\MinifilterPort&quot;</span>);  <span class="comment">// 定义通信端口名称</span></span><br><span class="line">    FLT_REGISTRATION FilterRegistration = &#123; <span class="built_in">sizeof</span>(FLT_REGISTRATION), FLT_REGISTRATION_VERSION &#125;;  <span class="comment">// 定义过滤器注册结构</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册过滤器</span></span><br><span class="line">    NTSTATUS status = <span class="built_in">FltRegisterFilter</span>(DriverObject, &amp;FilterRegistration, &amp;g_FilterHandle);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建通信端口，并指定连接、断开连接和消息处理的回调函数</span></span><br><span class="line">    status = <span class="built_in">FltCreateCommunicationPort</span>(</span><br><span class="line">        g_FilterHandle,</span><br><span class="line">        &amp;g_ServerPort,</span><br><span class="line">        &amp;portName,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        MinifilterConnectCallback,     <span class="comment">// 客户端连接回调</span></span><br><span class="line">        MinifilterDisconnectCallback,  <span class="comment">// 客户端断开回调</span></span><br><span class="line">        MinifilterMessageCallback,     <span class="comment">// 消息处理回调</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果通信端口创建成功，则启动过滤器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">FltStartFiltering</span>(g_FilterHandle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果创建通信端口失败，则注销过滤器</span></span><br><span class="line">        <span class="built_in">FltUnregisterFilter</span>(g_FilterHandle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动卸载函数，清理通信端口和过滤器</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PDRIVER_OBJECT DriverObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 关闭通信端口</span></span><br><span class="line">    <span class="keyword">if</span> (g_ServerPort) &#123;</span><br><span class="line">        <span class="built_in">FltCloseCommunicationPort</span>(g_ServerPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注销过滤器</span></span><br><span class="line">    <span class="built_in">FltUnregisterFilter</span>(g_FilterHandle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>全局变量</strong>：</p>
<ul>
<li><code>g_ServerPort</code>：保存服务器端通信端口的句柄。</li>
<li><code>g_ClientPort</code>：保存客户端连接的端口句柄。</li>
</ul>
<p><strong>MinifilterMessageCallback</strong>：</p>
<ul>
<li>此回调函数处理从用户模式发送的消息。</li>
<li>当用户模式程序发送消息到此端口时，<code>MinifilterMessageCallback</code> 会被调用。</li>
<li>该函数检查输出缓冲区是否足够大，如果足够大，就将 “Hello from Kernel” 这条消息复制到输出缓冲区中返回给用户模式程序。</li>
</ul>
<p><strong>MinifilterConnectCallback</strong>：</p>
<ul>
<li>此回调函数在用户模式程序连接到通信端口时被调用。</li>
<li><code>g_ClientPort</code> 被设置为当前的客户端端口句柄，以便后续通信使用。</li>
<li>打印调试信息表示连接已建立。</li>
</ul>
<p><strong>MinifilterDisconnectCallback</strong>：</p>
<ul>
<li>此回调函数在用户模式程序断开连接时被调用。</li>
<li>如果 <code>g_ClientPort</code> 存在（即有一个连接），则关闭该连接端口并将其指针设置为 NULL。</li>
<li>打印调试信息表示连接已断开。</li>
</ul>
<p><strong>DriverEntry</strong>：</p>
<ul>
<li>驱动的入口函数，初始化 Minifilter 并创建通信端口。</li>
<li>通过调用 <code>FltRegisterFilter</code> 注册过滤器。</li>
<li>使用 <code>FltCreateCommunicationPort</code> 创建通信端口，并提供连接、断开连接和消息处理的回调函数。</li>
<li>如果通信端口创建成功，则调用 <code>FltStartFiltering</code> 启动过滤器。</li>
<li>如果通信端口创建失败，则注销过滤器。</li>
</ul>
<p><strong>三环代码：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltUser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HANDLE hPort = <span class="literal">NULL</span>;  <span class="comment">// 通信端口句柄，用于与内核模式的 Minifilter 驱动通信</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到 Minifilter 驱动程序创建的通信端口</span></span><br><span class="line">    HRESULT hr = <span class="built_in">FilterConnectCommunicationPort</span>(</span><br><span class="line">        <span class="string">L&quot;\\MinifilterPort&quot;</span>, <span class="comment">// 通信端口的名称，需与内核中创建的端口名称一致</span></span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;hPort  <span class="comment">// 返回的通信端口句柄，用于后续的通信</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查连接是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to connect to port. Error: &quot;</span> &lt;&lt; hr &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置输出缓冲区，用于接收来自内核模式的响应     </span></span><br><span class="line">    <span class="type">char</span> outputBuffer[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;  <span class="comment">// 用于存储从内核接收到的消息</span></span><br><span class="line">    DWORD bytesReturned;           <span class="comment">// 返回的字节数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向内核模式发送消息，并接收内核的响应</span></span><br><span class="line">    hr = <span class="built_in">FilterSendMessage</span>(</span><br><span class="line">        hPort,                      <span class="comment">// 通信端口句柄</span></span><br><span class="line">        <span class="string">&quot;Hello from User Mode&quot;</span>,     <span class="comment">// 发送到内核的消息</span></span><br><span class="line">        (DWORD)<span class="built_in">strlen</span>(<span class="string">&quot;Hello from User Mode&quot;</span>) + <span class="number">1</span>, <span class="comment">// 消息长度，包括终止符</span></span><br><span class="line">        outputBuffer,               <span class="comment">// 输出缓冲区，用于存储内核的响应</span></span><br><span class="line">        <span class="built_in">sizeof</span>(outputBuffer),       <span class="comment">// 输出缓冲区大小</span></span><br><span class="line">        &amp;bytesReturned              <span class="comment">// 实际返回的字节数</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查消息是否成功发送并接收到响应</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>(hr)) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Received from kernel: &quot;</span> &lt;&lt; outputBuffer &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to send message. Error: &quot;</span> &lt;&lt; hr &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭通信端口</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hPort);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="R0给R3发信息"><a href="#R0给R3发信息" class="headerlink" title="R0给R3发信息"></a>R0给R3发信息</h3><p><strong>三环代码：</strong></p>
<p>用户模式程序首先需要使用 <code>FilterCreateCommunicationPort</code> 创建一个通信端口，并等待来自内核模式的消息。通过 <code>FilterGetMessage</code> 来获取内核模式发送的消息。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltUser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HRESULT hr;</span><br><span class="line">    HANDLE hPort;</span><br><span class="line">    HANDLE hCompletionPort;</span><br><span class="line">    DWORD bytesReturned;</span><br><span class="line">    ULONG_PTR completionKey;</span><br><span class="line">    LPOVERLAPPED pOvlp;</span><br><span class="line">    <span class="type">char</span> receiveBuffer[BUFFER_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到内核模式创建的通信端口</span></span><br><span class="line">    hr = <span class="built_in">FilterConnectCommunicationPort</span>(</span><br><span class="line">        <span class="string">L&quot;\\MinifilterPort&quot;</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;hPort</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to connect to port. Error: &quot;</span> &lt;&lt; hr &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个I/O完成端口</span></span><br><span class="line">    hCompletionPort = <span class="built_in">CreateIoCompletionPort</span>(hPort, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (hCompletionPort == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create I/O completion port. Error: &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hPort);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待来自内核模式的消息</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Waiting for messages from kernel...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 阻塞等待并接收消息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">GetQueuedCompletionStatus</span>(hCompletionPort, &amp;bytesReturned, &amp;completionKey, &amp;pOvlp, INFINITE)) &#123;</span><br><span class="line">            <span class="comment">// 接收消息成功</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Received message from kernel: &quot;</span> &lt;&lt; receiveBuffer &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理完消息后，继续循环接收</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Failed to receive message. Error: &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭端口句柄和完成端口句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hPort);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hCompletionPort);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>内核代码：</strong></p>
<p>内核模式 Minifilter 代码使用 <code>FltSendMessage</code> 函数向用户模式发送消息。请注意，用户模式程序需要先建立通信端口，内核模式才可以发送消息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltKernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dontuse.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PFLT_PORT g_ServerPort = <span class="literal">NULL</span>;</span><br><span class="line">PFLT_PORT g_ClientPort = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户模式连接回调函数</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">MinifilterConnectCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ConnectionCookie,</span></span></span><br><span class="line"><span class="params"><span class="function">    PFLT_PORT ClientPort</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ConnectionCookie);</span><br><span class="line"></span><br><span class="line">    g_ClientPort = ClientPort;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;User mode connected\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户模式断开连接回调函数</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">MinifilterDisconnectCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ConnectionCookie);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_ClientPort) &#123;</span><br><span class="line">        <span class="built_in">FltCloseClientPort</span>(g_FilterHandle, &amp;g_ClientPort);</span><br><span class="line">        g_ClientPort = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DbgPrint</span>(<span class="string">&quot;User mode disconnected\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向用户模式发送消息的函数</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">SendMessageToUserMode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* message</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_ClientPort) &#123;</span><br><span class="line">        ULONG bytesWritten;</span><br><span class="line">        NTSTATUS status = <span class="built_in">FltSendMessage</span>(</span><br><span class="line">            g_FilterHandle,</span><br><span class="line">            &amp;g_ClientPort,</span><br><span class="line">            (PVOID)message,</span><br><span class="line">            (ULONG)<span class="built_in">strlen</span>(message) + <span class="number">1</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;bytesWritten</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;Message sent to user mode: %s\n&quot;</span>, message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;Failed to send message. Status: 0x%X\n&quot;</span>, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;No user mode client connected.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动入口</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    UNICODE_STRING portName = <span class="built_in">RTL_CONSTANT_STRING</span>(<span class="string">L&quot;\\MinifilterPort&quot;</span>);</span><br><span class="line">    FLT_REGISTRATION FilterRegistration = &#123; <span class="built_in">sizeof</span>(FLT_REGISTRATION), FLT_REGISTRATION_VERSION &#125;;</span><br><span class="line">    </span><br><span class="line">    NTSTATUS status = <span class="built_in">FltRegisterFilter</span>(DriverObject, &amp;FilterRegistration, &amp;g_FilterHandle);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建通信端口</span></span><br><span class="line">    status = <span class="built_in">FltCreateCommunicationPort</span>(</span><br><span class="line">        g_FilterHandle,</span><br><span class="line">        &amp;g_ServerPort,</span><br><span class="line">        &amp;portName,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        MinifilterConnectCallback,</span><br><span class="line">        MinifilterDisconnectCallback,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="built_in">FltStartFiltering</span>(g_FilterHandle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">FltUnregisterFilter</span>(g_FilterHandle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向用户模式发送测试消息</span></span><br><span class="line">    <span class="built_in">SendMessageToUserMode</span>(<span class="string">&quot;Hello from Kernel&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驱动卸载</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DriverUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PDRIVER_OBJECT DriverObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_ServerPort) &#123;</span><br><span class="line">        <span class="built_in">FltCloseCommunicationPort</span>(g_ServerPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">FltUnregisterFilter</span>(g_FilterHandle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>FltSendMessage是一个同步的API</p>
<p>当 <code>FltSendMessage</code> 发送消息给用户模式进程时，用户模式进程需要通过 <code>FilterGetMessage</code> 来接收这个消息并进行处理。如果用户模式进程没有及时接收到消息或没有回复（例如，用户模式进程被挂起、退出、或处理速度较慢），<code>FltSendMessage</code> 就会等待用户模式的响应，直到超时设定的时间到达。 </p>
<p>同步：不拿到数据不返回<br>同步也分阻塞和非阻塞，阻塞就是进入休眠，直到被唤醒，非阻塞就是轮询</p>
<h2 id="scanner分析"><a href="#scanner分析" class="headerlink" title="scanner分析"></a>scanner分析</h2><p>微软的官方示例MInifilter-Scanner 是实现了一个文件扫描器的功能，实时监控文件并检测文件中是否含有预设特征。 </p>
<p>一共三次扫描，具体分别是在 <strong>创建后扫描，写之前扫描，写关闭扫描</strong></p>
<h3 id="驱动代码分析"><a href="#驱动代码分析" class="headerlink" title="驱动代码分析"></a>驱动代码分析</h3><h4 id="函数作用预览"><a href="#函数作用预览" class="headerlink" title="函数作用预览"></a>函数作用预览</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取IoOpenDriverRegistryKey这个API的地址</span></span><br><span class="line"><span class="function">PFN_IoOpenDriverRegistryKey</span></span><br><span class="line"><span class="function"><span class="title">ScannerGetIoOpenDriverRegistryKey</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//功能：打开服务的注册表参数键。</span></span><br><span class="line"><span class="comment">//目的：根据传入的驱动对象和注册表路径打开服务参数子键。首先尝试使用 IoOpenDriverRegistryKey API 打开参数键。如果失败，使用 ZwOpenKey 直接打开指定路径的注册表键。（这里是Scanner把要扫描的后缀填到了注册表里面了）</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerOpenServiceParametersKey</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING ServiceRegistryPath,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PHANDLE ServiceParametersKey</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：从注册表读取文件扩展名并初始化文件扫描扩展名数组。</span></span><br><span class="line"><span class="comment">目的：此函数读取注册表中的 Extensions 键，解析它包含的文件扩展名，并将其存储在 ScannedExtensions 数组中。返回扫描扩展名数组的初始化状态。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerInitializeScannedExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：释放扫描扩展名数组。</span></span><br><span class="line"><span class="comment">目的：清理并释放在 ScannerInitializeScannedExtensions 中分配的内存，确保没有内存泄漏。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ScannerFreeExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：为 UNICODE_STRING 分配内存。</span></span><br><span class="line"><span class="comment">目的：为给定的 UNICODE_STRING 分配内存，并初始化其内容。如果分配失败，则返回错误代码。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerAllocateUnicodeString</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PUNICODE_STRING String</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：释放 UNICODE_STRING 分配的内存。</span></span><br><span class="line"><span class="comment">目的：释放通过 ScannerAllocateUnicodeString 分配的内存，确保没有内存泄漏。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ScannerFreeUnicodeString</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PUNICODE_STRING String</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：处理用户模式连接到服务器端口的请求。</span></span><br><span class="line"><span class="comment">目的：当用户模式应用程序连接到驱动的服务器端口时，记录客户端端口和进程信息。还可以进行一些调试输出。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPortConnect</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFLT_PORT ClientPort,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PVOID ServerPortCookie,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(SizeOfContext) PVOID ConnectionContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG SizeOfContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_result_maybenull_ PVOID *ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">功能：处理用户模式断开连接的请求。</span></span><br><span class="line"><span class="comment">目的：当连接断开时，关闭客户端端口，并重置与用户进程相关的信息。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ScannerPortDisconnect</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PVOID ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ScannerpScanFileInUserMode 函数的主要作用是将文件的内容传输到用户模式并请求用户模式扫描该文件，确定文件是否安全可打开（例如是否包含恶意内容或不当语言）。如果扫描成功且文件安全，它会将 SafeToOpen 设置为 FALSE，表示文件可以安全打开，否则它将保留为 TRUE。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerpScanFileInUserMode</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFLT_INSTANCE Instance,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFILE_OBJECT FileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PBOOLEAN SafeToOpen</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ScannerpCheckExtension 这个函数的作用是检查给定的文件扩展名是否在驱动程序关注的扩展名列表中。如果该扩展名在已配置的列表中，则返回 TRUE，表示这个文件类型是驱动程序感兴趣的文件；否则，返回 FALSE，表示不感兴趣。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">BOOLEAN</span></span><br><span class="line"><span class="function"><span class="title">ScannerpCheckExtension</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING Extension</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br></pre></td></tr></table></figure>







<h4 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h4><p>以下分析的都写在注释上</p>
<p><code>ScannerInitializeScannedExtensions</code>函数</p>
<p>这里的参数<code>_In_ PUNICODE_STRING RegistryPath</code>是来自DriverEntry的<code>RegisterPath</code>，注册表路径一般默认就是<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\xxYourDriver</code></p>
<p>我们可以从inf文件中读取到注册表的内容</p>
<p><img src="/Minifilter/1731572063730.png" alt="1731572063730"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerInitializeScannedExtensions</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    HANDLE driverRegKey = <span class="literal">NULL</span>;</span><br><span class="line">    UNICODE_STRING valueName;</span><br><span class="line">    PKEY_VALUE_PARTIAL_INFORMATION valueBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    ULONG valueLength = <span class="number">0</span>;</span><br><span class="line">    PWCHAR ch;</span><br><span class="line">    SIZE_T length;</span><br><span class="line">    ULONG count;</span><br><span class="line">    PUNICODE_STRING ext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();<span class="comment">//如果 IRQL &gt;APC_LEVEL，PAGED_CODE 宏会导致系统出现 ASSERT。</span></span><br><span class="line"></span><br><span class="line">    ScannedExtensions = <span class="literal">NULL</span>;</span><br><span class="line">    ScannedExtensionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Open service parameters key to query values from.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ScannerOpenServiceParametersKey</span>( DriverObject,</span><br><span class="line">                                              RegistryPath,</span><br><span class="line">                                              &amp;driverRegKey ); <span class="comment">//这里是打开服务的注册表参数键。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        driverRegKey = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>( &amp;valueName, <span class="string">L&quot;Extensions&quot;</span> );</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ZwQueryValueKey</span>( driverRegKey,</span><br><span class="line">                              &amp;valueName,</span><br><span class="line">                              KeyValuePartialInformation,</span><br><span class="line">                              <span class="literal">NULL</span>,</span><br><span class="line">                              <span class="number">0</span>,</span><br><span class="line">                              &amp;valueLength );  <span class="comment">//获取到注册表&quot;Extensions&quot;的长度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status!=STATUS_BUFFER_TOO_SMALL &amp;&amp; status!=STATUS_BUFFER_OVERFLOW) &#123;</span><br><span class="line"></span><br><span class="line">        status = STATUS_INVALID_PARAMETER;</span><br><span class="line">        <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    valueBuffer = <span class="built_in">ExAllocatePoolZero</span>( NonPagedPool,</span><br><span class="line">                                      valueLength,</span><br><span class="line">                                      SCANNER_REG_TAG );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valueBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ZwQueryValueKey</span>( driverRegKey,</span><br><span class="line">                              &amp;valueName,</span><br><span class="line">                              KeyValuePartialInformation,</span><br><span class="line">                              valueBuffer,</span><br><span class="line">                              valueLength,</span><br><span class="line">                              &amp;valueLength );  <span class="comment">//提取出注册表的项</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ch = (PWCHAR)(valueBuffer-&gt;Data);</span><br><span class="line"></span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//计算有多少项</span></span><br><span class="line">    <span class="keyword">while</span> (*ch != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">        ch = ch + <span class="built_in">wcslen</span>( ch ) + <span class="number">1</span>;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ScannedExtensions = <span class="built_in">ExAllocatePoolZero</span>( PagedPool,</span><br><span class="line">                                            count * <span class="built_in">sizeof</span>(UNICODE_STRING),</span><br><span class="line">                                            SCANNER_STRING_TAG );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ScannedExtensions == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ch = (PWCHAR)((PKEY_VALUE_PARTIAL_INFORMATION)valueBuffer-&gt;Data);</span><br><span class="line">    ext = ScannedExtensions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ScannedExtensionCount &lt; count) &#123;   <span class="comment">//将提取出来的项存到数组里，例如.doc,.exe等等后缀</span></span><br><span class="line"></span><br><span class="line">        length = <span class="built_in">wcslen</span>( ch ) * <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line"></span><br><span class="line">        ext-&gt;MaximumLength = (USHORT) length;</span><br><span class="line"></span><br><span class="line">        status = <span class="built_in">ScannerAllocateUnicodeString</span>( ext );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line">            <span class="keyword">goto</span> ScannerInitializeScannedExtensionsCleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ext-&gt;Length = (USHORT)length;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">RtlCopyMemory</span>( ext-&gt;Buffer, ch, length );</span><br><span class="line"></span><br><span class="line">        ch = ch + length/<span class="built_in">sizeof</span>(WCHAR) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        ScannedExtensionCount++;</span><br><span class="line"></span><br><span class="line">        ext++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">ScannerInitializeScannedExtensionsCleanup:</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Note that this function leaks the global buffers.</span></span><br><span class="line">    <span class="comment">//  On failure DriverEntry will clean up the globals</span></span><br><span class="line">    <span class="comment">//  so we don&#x27;t have to do that here.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valueBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ExFreePoolWithTag</span>( valueBuffer, SCANNER_REG_TAG );</span><br><span class="line">        valueBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (driverRegKey != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ZwClose</span>( driverRegKey );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ScannerFreeExtensions</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p><code>DriverEntry</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PUNICODE_STRING RegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OBJECT_ATTRIBUTES oa;</span><br><span class="line">    UNICODE_STRING uniString;</span><br><span class="line">    PSECURITY_DESCRIPTOR sd;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ExInitializeDriverRuntime</span>( DrvRtPoolNxOptIn ); <span class="comment">//动态选择启用默认非分页池分配不可执行（Non-Executable, NX）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册minifilter，拿到minifilter的句柄（ScannerData.Filter）</span></span><br><span class="line">    status = <span class="built_in">FltRegisterFilter</span>( DriverObject,  </span><br><span class="line">                                &amp;FilterRegistration,<span class="comment">//存着回调函数</span></span><br><span class="line">                                &amp;ScannerData.Filter );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">ScannerInitializeScannedExtensions</span>( DriverObject, RegistryPath );<span class="comment">//从注册表中获取要扫描的扩展</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">        ScannedExtensions = &amp;ScannedExtensionDefault;</span><br><span class="line">        ScannedExtensionCount = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化一个端口名</span></span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>( &amp;uniString, ScannerPortName );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">FltBuildDefaultSecurityDescriptor</span>( &amp;sd, FLT_PORT_ALL_ACCESS ); <span class="comment">//创建安全描述符，我们保护端口，因此只有管理员和系统可以对其进行访问。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">InitializeObjectAttributes</span>( &amp;oa,</span><br><span class="line">                                    &amp;uniString,</span><br><span class="line">                                    OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,</span><br><span class="line">                                    <span class="literal">NULL</span>,</span><br><span class="line">                                    sd );</span><br><span class="line"></span><br><span class="line">        status = <span class="built_in">FltCreateCommunicationPort</span>( ScannerData.Filter,</span><br><span class="line">                                             &amp;ScannerData.ServerPort,</span><br><span class="line">                                             &amp;oa,</span><br><span class="line">                                             <span class="literal">NULL</span>,</span><br><span class="line">                                             ScannerPortConnect,<span class="comment">//客户端连接调用的回调</span></span><br><span class="line">                                             ScannerPortDisconnect,<span class="comment">//客户端断开连接的回调</span></span><br><span class="line">                                             <span class="literal">NULL</span>,<span class="comment">//这里是客户端发消息的回调，但是这个例子没注册</span></span><br><span class="line">                                             <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">FltFreeSecurityDescriptor</span>( sd );  <span class="comment">//在所有情况下释放安全描述符。调用 FltCreateCommunicationPort（） 后，就不需要它。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">            status = <span class="built_in">FltStartFiltering</span>( ScannerData.Filter );<span class="comment">//开启minifilter</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">FltCloseCommunicationPort</span>( ScannerData.ServerPort );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ScannerFreeExtensions</span>(); <span class="comment">//释放扫描扩展名数组。</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">FltUnregisterFilter</span>( ScannerData.Filter );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>建立连接回调<code>ScannerPortConnect</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPortConnect</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFLT_PORT ClientPort,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PVOID ServerPortCookie,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_opt_(SizeOfContext) PVOID ConnectionContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG SizeOfContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_result_maybenull_ PVOID *ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( ServerPortCookie );</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( ConnectionContext );</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( SizeOfContext);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( ConnectionCookie = <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//FLT_ASSERT是一个宏，用于在调试过程中检查条件是否为真。如果条件为假（即表达式计算结果为FALSE），则FLT_ASSERT会触发一个断言失败，这通常会导致调试器中断执行</span></span><br><span class="line">    <span class="built_in">FLT_ASSERT</span>( ScannerData.ClientPort == <span class="literal">NULL</span> );</span><br><span class="line">    <span class="built_in">FLT_ASSERT</span>( ScannerData.UserProcess == <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置用户进程和端口。后续校验用</span></span><br><span class="line">    ScannerData.UserProcess = <span class="built_in">PsGetCurrentProcess</span>();</span><br><span class="line">    ScannerData.ClientPort = ClientPort;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys --- connected, port=0x%p\n&quot;</span>, ClientPort );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>断开连接回调<code>ScannerPortDisconnect</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ScannerPortDisconnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">     _In_opt_ PVOID ConnectionCookie</span></span></span><br><span class="line"><span class="params"><span class="function">     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( ConnectionCookie );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys --- disconnected, port=0x%p\n&quot;</span>, ScannerData.ClientPort );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭连接的句柄：注意，由于我们将最大连接数限制为1，所以在我们从断开例程返回之前，不允许进行另一个连接。</span></span><br><span class="line">    <span class="built_in">FltCloseClientPort</span>( ScannerData.Filter, &amp;ScannerData.ClientPort );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ScannerData.UserProcess = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>接下来分析Minifilter里面具体注册的IRP回调</p>
<p><code>IRP_MJ_CREATE</code>的Pre回调:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLT_PREOP_CALLBACK_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPreCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Flt_CompletionContext_Outptr_ PVOID *CompletionContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( FltObjects );</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( CompletionContext = <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IoThreadToProcess</span>( Data-&gt;Thread ) == ScannerData.UserProcess) <span class="comment">//去对比当前发送Create的这个线程是否与我们注册的相关，我们信任与自己取得连接的三环程序</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- allowing create for trusted process \n&quot;</span> );</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//这里也许可以多一些验证，比如md5，数字签名啥的，要保证与minifilter连接的是真正我们自己的程序</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> FLT_PREOP_SUCCESS_NO_CALLBACK;<span class="comment">//表示预操作处理成功，但不需要调用 `PostOperation` 回调，即信任自己的程序</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FLT_PREOP_SUCCESS_WITH_CALLBACK; <span class="comment">//如果不是自己的进程，则启用Post</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><code>IRP_MJ_CREATE</code>的Post回调:</p>
<p>前面提到过了，在<code>IRP_MJ_CREATE</code>的Post回调我们会开始我们的第一次扫描验证，让我们看看怎么个</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLT_POSTOP_CALLBACK_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPostCreate</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PVOID CompletionContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ FLT_POST_OPERATION_FLAGS Flags</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="function">例程说明：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Post create 回调。 在创建文件进入文件系统之前，我们无法扫描文件，否则文件系统将无法准备好为我们读取文件。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">参数：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">数据 - 描述操作参数的结构。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">FltObject - 描述受此操作影响的对象的结构。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">CompletionContext - 从 pre-create 回调传递的操作上下文。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Flags （标志） - 说明我们为何获得此操作后回调的标志。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">返回值：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">FLT_POSTOP_FINISHED_PROCESSING - 确定以打开文件，或者我们希望拒绝对此文件的访问，因此撤消打开的</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSCANNER_STREAM_HANDLE_CONTEXT scannerContext;</span><br><span class="line">    FLT_POSTOP_CALLBACK_STATUS returnStatus = FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line">    PFLT_FILE_NAME_INFORMATION nameInfo;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    BOOLEAN safeToOpen, scanFile;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( CompletionContext );</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( Flags );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  If this create was failing anyway, don&#x27;t bother scanning now.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( Data-&gt;IoStatus.Status ) ||</span><br><span class="line">        (STATUS_REPARSE == Data-&gt;IoStatus.Status)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Check if we are interested in this file.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">FltGetFileNameInformation</span>( Data,</span><br><span class="line">                                        FLT_FILE_NAME_NORMALIZED |</span><br><span class="line">                                            FLT_FILE_NAME_QUERY_DEFAULT,</span><br><span class="line">                                        &amp;nameInfo );<span class="comment">//获取文件名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FltParseFileNameInformation</span>( nameInfo );<span class="comment">//FltParseFileNameInformation 函数在Windows文件系统过滤驱动开发中用于解析文件名信息。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查扩展是否与我们感兴趣的扩展列表匹配</span></span><br><span class="line">    scanFile = <span class="built_in">ScannerpCheckExtension</span>( &amp;nameInfo-&gt;Extension );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//已经不用nameInfo，可以删</span></span><br><span class="line">    <span class="built_in">FltReleaseFileNameInformation</span>( nameInfo );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!scanFile) &#123;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//我们不感兴趣就返回</span></span><br><span class="line">        <span class="keyword">return</span> FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (VOID) <span class="built_in">ScannerpScanFileInUserMode</span>( FltObjects-&gt;Instance,</span><br><span class="line">                                       FltObjects-&gt;FileObject,</span><br><span class="line">                                       &amp;safeToOpen ); <span class="comment">//这个函数是将文件发送至三环进行扫描，结果存放在safeToOpen</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!safeToOpen) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不安全做以下事情：</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- foul language detected in postcreate !!!\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- undoing create \n&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">FltCancelFileOpen</span>( FltObjects-&gt;Instance, FltObjects-&gt;FileObject );<span class="comment">//微筛选器驱动程序可以使用 FltCancelFileOpen 例程关闭新打开或创建的文件。</span></span><br><span class="line"></span><br><span class="line">        Data-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;</span><br><span class="line">        Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        returnStatus = FLT_POSTOP_FINISHED_PROCESSING;</span><br><span class="line"></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (FltObjects-&gt;FileObject-&gt;WriteAccess)  <span class="comment">//如果是写打开，要创建标志，方便在写关闭的时候再次扫描</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是这一步扫描出来是安全的，如果是以Write的权限打开，我们做好标记，在写入的时候我们还会再次扫描检测</span></span><br><span class="line">        status = <span class="built_in">FltAllocateContext</span>( ScannerData.Filter,</span><br><span class="line">                                     FLT_STREAMHANDLE_CONTEXT, <span class="comment">//绑定在文件对象上的上下文</span></span><br><span class="line">                                     <span class="built_in">sizeof</span>(SCANNER_STREAM_HANDLE_CONTEXT),</span><br><span class="line">                                     PagedPool,</span><br><span class="line">                                     &amp;scannerContext );<span class="comment">//引用计数初始化为 1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Set the handle context.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            scannerContext-&gt;RescanRequired = TRUE;  <span class="comment">//设定为需要重新扫描</span></span><br><span class="line"></span><br><span class="line">            (VOID) <span class="built_in">FltSetStreamHandleContext</span>( FltObjects-&gt;Instance,  <span class="comment">//绑定在文件对象上下文</span></span><br><span class="line">                                              FltObjects-&gt;FileObject,</span><br><span class="line">                                              FLT_SET_CONTEXT_REPLACE_IF_EXISTS,</span><br><span class="line">                                              scannerContext,</span><br><span class="line">                                              <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">            <span class="built_in">FltReleaseContext</span>( scannerContext );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>将扫描数据发送给三环的函数分析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerpScanFileInUserMode</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFLT_INSTANCE Instance,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PFILE_OBJECT FileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PBOOLEAN SafeToOpen</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="function">描述：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">该例程用于向用户模式发送请求，扫描指定的文件，并告诉调用者是否可以打开该文件。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">需要注意的是，如果扫描失败，我们将SafeToOpen设置为TRUE。扫描可能失败，可能是因为服务尚未启动，也可能是因为这是针对目录的创建/清理操作，而没有数据可供读取和扫描。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">如果服务未运行时我们尝试创建它，就会出现启动问题——我们该如何加载服务的可执行文件呢？</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">论点：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">实例 - 本卷扫描器的过滤器实例的句柄。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">文件对象 - 待扫描的文件。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">“SafeToOpen”设置为“FALSE”，如果文件扫描成功，并且其中包含粗俗语言。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">返回值：</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">操作的状态，希望是STATUS_SUCCESS。 常见的失败状态可能是STATUS_INSUFFICIENT_RESOURCES。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    PVOID buffer = <span class="literal">NULL</span>;</span><br><span class="line">    ULONG bytesRead;</span><br><span class="line">    PSCANNER_NOTIFICATION notification = <span class="literal">NULL</span>;</span><br><span class="line">    FLT_VOLUME_PROPERTIES volumeProps;</span><br><span class="line">    LARGE_INTEGER offset;</span><br><span class="line">    ULONG replyLength, length;</span><br><span class="line">    PFLT_VOLUME volume = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    *SafeToOpen = TRUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果port是空，说明还没有进行连接</span></span><br><span class="line">    <span class="keyword">if</span> (ScannerData.ClientPort == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        status = <span class="built_in">FltGetVolumeFromInstance</span>( Instance, &amp;volume );  <span class="comment">//获取卷对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">            leave;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//确定扇区大小。非缓存I/O只能在扇区大小偏移量处完成，并且长度是扇区大小的倍数。一种更有效的方法是调用一次，并在实例设置例程中记住扇区大小，并设置一个实例上下文，我们可以缓存它。</span></span><br><span class="line">		<span class="comment">//如果你尝试进行非缓存 I/O 读取，并且文件的读取偏移量或者读取的长度不是扇区大小的倍数，操作系统可能会返回错误或者无法成功执行该操作。</span></span><br><span class="line">        status = <span class="built_in">FltGetVolumeProperties</span>( volume,</span><br><span class="line">                                         &amp;volumeProps,</span><br><span class="line">                                         <span class="built_in">sizeof</span>( volumeProps ),</span><br><span class="line">                                         &amp;length );</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_ERROR</span>( status )) &#123;</span><br><span class="line"></span><br><span class="line">            leave;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        length = <span class="built_in">max</span>( SCANNER_READ_BUFFER_SIZE, volumeProps.SectorSize );<span class="comment">//如果扫描缓冲区的大小 SCANNER_READ_BUFFER_SIZE 小于扇区大小，你就需要使用扇区大小来进行读取；如果缓冲区较大，就使用缓冲区的大小</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        buffer = <span class="built_in">FltAllocatePoolAlignedWithTag</span>( Instance,</span><br><span class="line">                                                NonPagedPool,</span><br><span class="line">                                                length,</span><br><span class="line">                                                <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == buffer) &#123;</span><br><span class="line"></span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            leave;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        notification = <span class="built_in">ExAllocatePoolZero</span>( NonPagedPool,</span><br><span class="line">                                           <span class="built_in">sizeof</span>( SCANNER_NOTIFICATION ),</span><br><span class="line">                                           <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == notification) &#123;</span><br><span class="line"></span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            leave;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//读取文件的开头，并传递给三环</span></span><br><span class="line">        offset.QuadPart = bytesRead = <span class="number">0</span>;</span><br><span class="line">        status = <span class="built_in">FltReadFile</span>( Instance,</span><br><span class="line">                              FileObject,</span><br><span class="line">                              &amp;offset,</span><br><span class="line">                              length,</span><br><span class="line">                              buffer,</span><br><span class="line">                              FLTFL_IO_OPERATION_NON_CACHED |</span><br><span class="line">                              FLTFL_IO_OPERATION_DO_NOT_UPDATE_BYTE_OFFSET,</span><br><span class="line">                              &amp;bytesRead,</span><br><span class="line">                              <span class="literal">NULL</span>,</span><br><span class="line">                              <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>( status ) &amp;&amp; (<span class="number">0</span> != bytesRead)) &#123;</span><br><span class="line"></span><br><span class="line">            notification-&gt;BytesToScan = (ULONG) bytesRead;</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">			<span class="comment">//这里只拷贝min( notification-&gt;BytesToScan, SCANNER_READ_BUFFER_SIZE )</span></span><br><span class="line">            <span class="built_in">RtlCopyMemory</span>( &amp;notification-&gt;Contents,</span><br><span class="line">                           buffer,</span><br><span class="line">                           <span class="built_in">min</span>( notification-&gt;BytesToScan, SCANNER_READ_BUFFER_SIZE ) );</span><br><span class="line"></span><br><span class="line">            replyLength = <span class="built_in">sizeof</span>( SCANNER_REPLY );</span><br><span class="line">			</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            status = <span class="built_in">FltSendMessage</span>( ScannerData.Filter,</span><br><span class="line">                                     &amp;ScannerData.ClientPort,</span><br><span class="line">                                     notification,</span><br><span class="line">                                     <span class="built_in">sizeof</span>(SCANNER_NOTIFICATION),</span><br><span class="line">                                     notification,</span><br><span class="line">                                     &amp;replyLength,</span><br><span class="line">                                     <span class="literal">NULL</span> );<span class="comment">//如果填写了期望收到恢复（reply），最后一个参数NULL代表无限等待</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (STATUS_SUCCESS == status) &#123;</span><br><span class="line"></span><br><span class="line">                *SafeToOpen = ((PSCANNER_REPLY) notification)-&gt;SafeToOpen;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发送不了信息</span></span><br><span class="line">                <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys --- couldn&#x27;t send message to user-mode to scan file, status 0x%X\n&quot;</span>, status );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; finally &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != buffer) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">FltFreePoolAlignedWithTag</span>( Instance, buffer, <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != notification) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>( notification, <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != volume) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">FltObjectDereference</span>( volume );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>接下来是关于<code>IRP_MJ_WRITE</code>的pre，这将会是进行第二次安全扫描</p>
<p>之所以是Pre而不是Post，是因为如果是Post就代表已经写入了，所以我们需要在Pre，也就是写之前进行对写入数据检测</p>
<p>写拦截，假如我们去拦截可疑特征码：“foul”，但是有个局限性，如果攻击者分开写，依次写入’f’,’o’,’u’,’l’，这下去拦截写就不太好</p>
<p>所以我们要去拦截写关闭，在cleanup的时候进行拦截，对文件进行扫描，具体来说，在Create的时候，可以知道是读还是写，如果是写，那么在Cleanup就会去扫描</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLT_PREOP_CALLBACK_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPreWrite</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Flt_CompletionContext_Outptr_ PVOID *CompletionContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FLT_PREOP_CALLBACK_STATUS returnStatus = FLT_PREOP_SUCCESS_NO_CALLBACK;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PSCANNER_NOTIFICATION notification = <span class="literal">NULL</span>;</span><br><span class="line">    PSCANNER_STREAM_HANDLE_CONTEXT context = <span class="literal">NULL</span>;</span><br><span class="line">    ULONG replyLength;</span><br><span class="line">    BOOLEAN safe = TRUE;</span><br><span class="line">    PUCHAR buffer;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( CompletionContext );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ScannerData.ClientPort == <span class="literal">NULL</span>) &#123; <span class="comment">//如果 ScannerData.ClientPort 为空，表示当前没有有效的客户端端口用于与用户模式进行通信。</span></span><br><span class="line">		</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> FLT_PREOP_SUCCESS_NO_CALLBACK;<span class="comment">//表示预操作处理成功，但不需要调用 `PostOperation` 回调。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用 FltGetStreamHandleContext 获取与文件相关的上下文。如果获取失败，则不再关注该文件，返回 FLT_PREOP_SUCCESS_NO_CALLBACK。为什么拿不到上下文就返回呢？因为在CreatePost我们为我们感兴趣的设置了上下文（特定后缀）</span></span><br><span class="line">    status = <span class="built_in">FltGetStreamHandleContext</span>( FltObjects-&gt;Instance,</span><br><span class="line">                                        FltObjects-&gt;FileObject,</span><br><span class="line">                                        &amp;context );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line">        <span class="keyword">return</span> FLT_PREOP_SUCCESS_NO_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//如果写操作的长度不为 0，函数会进一步处理写入的数据。</span></span><br><span class="line">        <span class="keyword">if</span> (Data-&gt;Iopb-&gt;Parameters.Write.Length != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//以下是区别各种IO的</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//如果写操作使用了 MDL（Memory Descriptor List），则通MmGetSystemAddressForMdlSafe 获取 MDL 映射的系统地址，读取写入的内容。</span></span><br><span class="line">            <span class="comment">//如果没有 MDL，则直接使用用户提供的缓冲区 WriteBuffer。</span></span><br><span class="line">            <span class="keyword">if</span> (Data-&gt;Iopb-&gt;Parameters.Write.MdlAddress != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">//这里是DirectIO</span></span><br><span class="line">                buffer = <span class="built_in">MmGetSystemAddressForMdlSafe</span>( </span><br><span class="line">                    Data-&gt;Iopb-&gt;Parameters.Write.MdlAddress,</span><br><span class="line">                    NormalPagePriority | MdlMappingNoExecute </span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    Data-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                    Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">                    returnStatus = FLT_PREOP_COMPLETE;</span><br><span class="line">                    leave;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                buffer  = Data-&gt;Iopb-&gt;Parameters.Write.WriteBuffer;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//分配一个 SCANNER_NOTIFICATION 结构来存储待扫描的数据。然后通过 RtlCopyMemory 将缓冲区中的数据复制到通知结构中。</span></span><br><span class="line">            notification = <span class="built_in">ExAllocatePoolZero</span>( NonPagedPool,</span><br><span class="line">                                               <span class="built_in">sizeof</span>( SCANNER_NOTIFICATION ),</span><br><span class="line">                                               <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line">            <span class="keyword">if</span> (notification == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                Data-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">                returnStatus = FLT_PREOP_COMPLETE;</span><br><span class="line">                leave;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//min 这里的作用是确保 扫描的字节数 (BytesToScan) 不会超过 扫描缓冲区的大小 (SCANNER_READ_BUFFER_SIZE)，也不会超过 写入数据的实际长度 (Data-&gt;Iopb-&gt;Parameters.Write.Length)。</span></span><br><span class="line">            notification-&gt;BytesToScan = <span class="built_in">min</span>( Data-&gt;Iopb-&gt;Parameters.Write.Length, SCANNER_READ_BUFFER_SIZE );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>  &#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">RtlCopyMemory</span>( &amp;notification-&gt;Contents,</span><br><span class="line">                               buffer,</span><br><span class="line">                               notification-&gt;BytesToScan );</span><br><span class="line"></span><br><span class="line">            &#125; <span class="built_in">except</span>( EXCEPTION_EXECUTE_HANDLER ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//  Error accessing buffer. Complete i/o with failure</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                Data-&gt;IoStatus.Status = <span class="built_in">GetExceptionCode</span>() ;</span><br><span class="line">                Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">                returnStatus = FLT_PREOP_COMPLETE;</span><br><span class="line">                leave;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Send message to user mode to indicate it should scan the buffer.</span></span><br><span class="line">            <span class="comment">//  We don&#x27;t have to synchronize between the send and close of the handle</span></span><br><span class="line">            <span class="comment">//  as FltSendMessage takes care of that.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            replyLength = <span class="built_in">sizeof</span>( SCANNER_REPLY );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用 FltSendMessage 将 notification 发送到用户模式（通过 ClientPort）。用户模式应用程序负责扫描缓冲区中的内容，返回一个 SCANNER_REPLY。</span></span><br><span class="line">            status = <span class="built_in">FltSendMessage</span>( ScannerData.Filter,</span><br><span class="line">                                     &amp;ScannerData.ClientPort,</span><br><span class="line">                                     notification,</span><br><span class="line">                                     <span class="built_in">sizeof</span>( SCANNER_NOTIFICATION ),</span><br><span class="line">                                     notification,</span><br><span class="line">                                     &amp;replyLength,</span><br><span class="line">                                     <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (STATUS_SUCCESS == status) &#123;</span><br><span class="line"></span><br><span class="line">               safe = ((PSCANNER_REPLY) notification)-&gt;SafeToOpen;</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//</span></span><br><span class="line">               <span class="comment">//  Couldn&#x27;t send message. This sample will let the i/o through.</span></span><br><span class="line">               <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">               <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys --- couldn&#x27;t send message to user-mode to scan file, status 0x%X\n&quot;</span>, status );</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!safe) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Block this write if not paging i/o (as a result of course, this scanner will not prevent memory mapped writes of contaminated</span></span><br><span class="line">            <span class="comment">//  strings to the file, but only regular writes). The effect of getting ERROR_ACCESS_DENIED for many apps to delete the file they</span></span><br><span class="line">            <span class="comment">//  are trying to write usually.</span></span><br><span class="line">            <span class="comment">//  To handle memory mapped writes - we should be scanning at close time (which is when we can really establish that the file object</span></span><br><span class="line">            <span class="comment">//  is not going to be used for any more writes)</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- foul language detected in write !!!\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">FlagOn</span>( Data-&gt;Iopb-&gt;IrpFlags, IRP_PAGING_IO )) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- blocking the write !!!\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">                Data-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;</span><br><span class="line">                Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">                returnStatus = FLT_PREOP_COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; finally &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (notification != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>( notification, <span class="string">&#x27;nacS&#x27;</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">FltReleaseContext</span>( context );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后，还有一次检查，就是在<code>IRP_MJ_CLEANUP</code>这个IRP请求</p>
<p>关于什么时候会发送<code>IRP_MJ_CLEANUP</code>:</p>
<ol>
<li>文件句柄关闭: 用户程序调用 <code>CloseHandle</code> 或在文件描述符生命周期结束时，Windows 内核会生成一个 <code>IRP_MJ_CLEANUP</code> 请求。这通常发生在文件对象不再需要时，句柄关闭或文件流结束时。 </li>
<li>关闭文件对象时的清理 , 当文件系统或文件对象的句柄引用计数降到零时，操作系统会调用驱动程序的 <code>Cleanup</code> 例程来清理资源。 </li>
<li>关闭时的流清理:在文件 I&#x2F;O 操作（如 <code>Read</code>、<code>Write</code>）完成后，文件句柄被关闭时，<code>IRP_MJ_CLEANUP</code> 用于指示文件的清理。</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLT_PREOP_CALLBACK_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ScannerPreCleanup</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Flt_CompletionContext_Outptr_ PVOID *CompletionContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">程序描述:</span></span></span><br><span class="line"><span class="comment"><span class="function">预清理回调。如果这个文件是为了写访问而打开的，我们想要现在重新扫描。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">参数:</span></span></span><br><span class="line"><span class="comment"><span class="function">Data-描述操作参数的结构。</span></span></span><br><span class="line"><span class="comment"><span class="function">FltObject -描述受此影响的对象的结构操作。</span></span></span><br><span class="line"><span class="comment"><span class="function">CompletionContext -输出参数，可以用来传递一个上下文从这个清理前回调到清理后回调。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">返回值:</span></span></span><br><span class="line"><span class="comment"><span class="function">总是FLT_PREOP_SUCCESS_NO_CALLBACK。</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PSCANNER_STREAM_HANDLE_CONTEXT context;</span><br><span class="line">    BOOLEAN safe;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( Data );</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>( CompletionContext );</span><br><span class="line"></span><br><span class="line">    status = <span class="built_in">FltGetStreamHandleContext</span>( FltObjects-&gt;Instance,</span><br><span class="line">                                        FltObjects-&gt;FileObject,</span><br><span class="line">                                        &amp;context );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>( status )) &#123;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//如果标记过RescanRequired(ScannerPostCreate中标记)</span></span><br><span class="line">        <span class="keyword">if</span> (context-&gt;RescanRequired) &#123;</span><br><span class="line"></span><br><span class="line">            (VOID) <span class="built_in">ScannerpScanFileInUserMode</span>( FltObjects-&gt;Instance,</span><br><span class="line">                                               FltObjects-&gt;FileObject,</span><br><span class="line">                                               &amp;safe ); <span class="comment">//把内容读出来，发给R3扫描</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!safe) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">DbgPrint</span>( <span class="string">&quot;!!! scanner.sys -- foul language detected in precleanup !!!\n&quot;</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">FltReleaseContext</span>( context );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FLT_PREOP_SUCCESS_NO_CALLBACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













<h3 id="用户层代码分析"><a href="#用户层代码分析" class="headerlink" title="用户层代码分析"></a>用户层代码分析</h3><p><code>scanuser.c</code> 代码实现了一个用户模式程序，用于与过滤驱动进行通信并扫描文件内容。它通过与内核模式的过滤器进行交互来扫描数据，并将扫描结果返回给过滤器。 </p>
<p>完整代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;crtdbg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fltuser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;scanuk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;scanuser.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dontuse.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义了默认的请求数、线程数和最大线程数。程序将根据命令行参数或默认值来确定线程数和每个线程处理的请求数。</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCANNER_DEFAULT_REQUEST_COUNT       5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCANNER_DEFAULT_THREAD_COUNT        2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCANNER_MAX_THREAD_COUNT            64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//这是扫描程序要查找的目标字符串（不合适的内容）。程序将在扫描的缓冲区中搜索这个字符串。</span></span><br><span class="line">UCHAR FoulString[] = <span class="string">&quot;foul&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SCANNER_THREAD_CONTEXT 结构体存储了与扫描工作线程相关的两个重要句柄：</span></span><br><span class="line"><span class="comment">Port：与过滤驱动的通信端口句柄。</span></span><br><span class="line"><span class="comment">Completion：I/O 完成端口句柄，用于多线程 I/O 操作。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SCANNER_THREAD_CONTEXT</span> &#123;</span><br><span class="line"></span><br><span class="line">    HANDLE Port;</span><br><span class="line">    HANDLE Completion;</span><br><span class="line"></span><br><span class="line">&#125; SCANNER_THREAD_CONTEXT, *PSCANNER_THREAD_CONTEXT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//打印程序的使用说明，包括如何传递参数以指定每个线程处理的请求数量以及线程数。</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">Usage</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Connects to the scanner filter and scans buffers \n&quot;</span> );</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Usage: scanuser [requests per thread] [number of threads(1-64)]\n&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ScanBuffer 函数接收一个缓冲区并扫描其中是否包含 FoulString。</span></span><br><span class="line"><span class="function">BOOL</span></span><br><span class="line"><span class="function"><span class="title">ScanBuffer</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_bytes_(BufferSize) PUCHAR Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG BufferSize</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PUCHAR p;</span><br><span class="line">    ULONG searchStringLength = <span class="built_in">sizeof</span>(FoulString) - <span class="built_in">sizeof</span>(UCHAR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p = Buffer;p &lt;= (Buffer + BufferSize - searchStringLength);p++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">RtlEqualMemory</span>( p, FoulString, searchStringLength )) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;Found a string\n&quot;</span> );</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ScannerWorker 是工作线程的主函数：</span></span><br><span class="line"><span class="comment">它从完成端口获取消息，表示需要扫描的缓冲区数据。</span></span><br><span class="line"><span class="comment">使用 ScanBuffer 函数扫描缓冲区，检查是否包含目标字符串 FoulString。</span></span><br><span class="line"><span class="comment">如果发现目标字符串，则设置 SafeToOpen 为 FALSE，表示文件不安全；否则为 TRUE。</span></span><br><span class="line"><span class="comment">然后，通过 FilterReplyMessage 将结果回复给过滤驱动。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">DWORD</span></span><br><span class="line"><span class="function"><span class="title">ScannerWorker</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PSCANNER_THREAD_CONTEXT Context</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PSCANNER_NOTIFICATION notification;</span><br><span class="line">    SCANNER_REPLY_MESSAGE replyMessage;</span><br><span class="line">    PSCANNER_MESSAGE message;</span><br><span class="line">    LPOVERLAPPED pOvlp;</span><br><span class="line">    BOOL result;</span><br><span class="line">    DWORD outSize;</span><br><span class="line">    HRESULT hr;</span><br><span class="line">    ULONG_PTR key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(push)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4127) <span class="comment">// conditional expression is constant</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(pop)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        result = <span class="built_in">GetQueuedCompletionStatus</span>( Context-&gt;Completion, &amp;outSize, &amp;key, &amp;pOvlp, INFINITE );<span class="comment">//GetQueuedCompletionStatus等待从完成端口中获取一个异步I/O操作的结果（这里是消息）。&amp;pOvlp：指向消息的OVERLAPPED结构体。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//message指向实际的消息内容,minifliter把SCANNER_NOTIFICATION封装在SCANNER_MESSAGE里面了，需要提取出来</span></span><br><span class="line">        message = <span class="built_in">CONTAINING_RECORD</span>( pOvlp, SCANNER_MESSAGE, Ovlp );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  An error occured.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            hr = <span class="built_in">HRESULT_FROM_WIN32</span>( <span class="built_in">GetLastError</span>() );</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;Received message, size %Id\n&quot;</span>, pOvlp-&gt;InternalHigh );</span><br><span class="line"></span><br><span class="line">        notification = &amp;message-&gt;Notification;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert</span>(notification-&gt;BytesToScan &lt;= SCANNER_READ_BUFFER_SIZE);</span><br><span class="line">        _Analysis_assume_(notification-&gt;BytesToScan &lt;= SCANNER_READ_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">        result = <span class="built_in">ScanBuffer</span>( notification-&gt;Contents, notification-&gt;BytesToScan );</span><br><span class="line"></span><br><span class="line">        replyMessage.ReplyHeader.Status = <span class="number">0</span>;</span><br><span class="line">        replyMessage.ReplyHeader.MessageId = message-&gt;MessageHeader.MessageId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Need to invert the boolean -- result is true if found</span></span><br><span class="line">        <span class="comment">//  foul language, in which case SafeToOpen should be set to false.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        replyMessage.Reply.SafeToOpen = !result;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;Replying message, SafeToOpen: %d\n&quot;</span>, replyMessage.Reply.SafeToOpen );</span><br><span class="line"></span><br><span class="line">        hr = <span class="built_in">FilterReplyMessage</span>(   <span class="comment">//用法：将响应发送到驱动程序，表示对收到的消息的处理结果。</span></span><br><span class="line">            Context-&gt;Port,          </span><br><span class="line">            (PFILTER_REPLY_HEADER) &amp;replyMessage,</span><br><span class="line">            <span class="built_in">sizeof</span>( replyMessage )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">SUCCEEDED</span>( hr )) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;Replied message\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;Scanner: Error replying message. Error = 0x%X\n&quot;</span>, hr );</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>( &amp;message-&gt;Ovlp, <span class="number">0</span>, <span class="built_in">sizeof</span>( OVERLAPPED ) );</span><br><span class="line"></span><br><span class="line">        hr = <span class="built_in">FilterGetMessage</span>( Context-&gt;Port,</span><br><span class="line">                               &amp;message-&gt;MessageHeader,</span><br><span class="line">                               <span class="built_in">FIELD_OFFSET</span>( SCANNER_MESSAGE, Ovlp ),</span><br><span class="line">                               &amp;message-&gt;Ovlp );  <span class="comment">//从驱动程序中接收消息。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hr != <span class="built_in">HRESULT_FROM_WIN32</span>( ERROR_IO_PENDING )) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">SUCCEEDED</span>( hr )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hr == <span class="built_in">HRESULT_FROM_WIN32</span>( ERROR_INVALID_HANDLE )) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Scanner port disconncted.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;Scanner: Port is disconnected, probably due to scanner filter unloading.\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;Scanner: Unknown error occured. Error = 0x%X\n&quot;</span>, hr );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> _cdecl</span></span><br><span class="line"><span class="function"><span class="title">main</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ <span class="type">int</span> argc,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_reads_(argc) <span class="type">char</span> *argv[]</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD requestCount = SCANNER_DEFAULT_REQUEST_COUNT;</span><br><span class="line">    DWORD threadCount = SCANNER_DEFAULT_THREAD_COUNT;</span><br><span class="line">    HANDLE threads[SCANNER_MAX_THREAD_COUNT] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">    SCANNER_THREAD_CONTEXT context;</span><br><span class="line">    HANDLE port, completion;</span><br><span class="line">    PSCANNER_MESSAGE messages;</span><br><span class="line">    DWORD threadId;</span><br><span class="line">    HRESULT hr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Check how many threads and per thread requests are desired.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        requestCount = <span class="built_in">atoi</span>( argv[<span class="number">1</span>] );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Usage</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argc &gt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">            threadCount = <span class="built_in">atoi</span>( argv[<span class="number">2</span>] );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (threadCount &lt;= <span class="number">0</span> || threadCount &gt; <span class="number">64</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Usage</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Open a commuication channel to the filter</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Scanner: Connecting to the filter ...\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开与过滤器驱动程序的通信端口，用于发送和接收消息。</span></span><br><span class="line">    hr = <span class="built_in">FilterConnectCommunicationPort</span>( ScannerPortName,</span><br><span class="line">                                         <span class="number">0</span>,</span><br><span class="line">                                         <span class="literal">NULL</span>,</span><br><span class="line">                                         <span class="number">0</span>,</span><br><span class="line">                                         <span class="literal">NULL</span>,</span><br><span class="line">                                         &amp;port );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IS_ERROR</span>( hr )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;ERROR: Connecting to filter port: 0x%08x\n&quot;</span>, hr );</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Create a completion port to associate with this handle.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">	<span class="comment">//创建一个 I/O 完成端口，用于管理 I/O 操作的完成通知。</span></span><br><span class="line">    completion = <span class="built_in">CreateIoCompletionPort</span>( port,</span><br><span class="line">                                         <span class="literal">NULL</span>,</span><br><span class="line">                                         <span class="number">0</span>,</span><br><span class="line">                                         threadCount );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completion == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;ERROR: Creating completion port: %d\n&quot;</span>, <span class="built_in">GetLastError</span>() );</span><br><span class="line">        <span class="built_in">CloseHandle</span>( port );</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Scanner: Port = 0x%p Completion = 0x%p\n&quot;</span>, port, completion );</span><br><span class="line"></span><br><span class="line">    context.Port = port;</span><br><span class="line">    context.Completion = completion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Allocate messages.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    messages = <span class="built_in">calloc</span>(((<span class="type">size_t</span>) threadCount) * requestCount, <span class="built_in">sizeof</span>(SCANNER_MESSAGE));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (messages == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        hr = ERROR_NOT_ENOUGH_MEMORY;</span><br><span class="line">        <span class="keyword">goto</span> main_cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Create specified number of threads.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">        </span><br><span class="line">        threads[i] = <span class="built_in">CreateThread</span>( <span class="literal">NULL</span>,</span><br><span class="line">                                   <span class="number">0</span>,</span><br><span class="line">                                   (LPTHREAD_START_ROUTINE) ScannerWorker,</span><br><span class="line">                                   &amp;context,</span><br><span class="line">                                   <span class="number">0</span>,</span><br><span class="line">                                   &amp;threadId );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (threads[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Couldn&#x27;t create thread.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            hr = <span class="built_in">GetLastError</span>();</span><br><span class="line">            <span class="built_in">printf</span>( <span class="string">&quot;ERROR: Couldn&#x27;t create thread: %d\n&quot;</span>, hr );</span><br><span class="line">            <span class="keyword">goto</span> main_cleanup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (DWORD j = <span class="number">0</span>; j &lt; requestCount; j++) &#123;</span><br><span class="line">        </span><br><span class="line">            PSCANNER_MESSAGE msg = &amp;(messages[i * requestCount + j]);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>( &amp;msg-&gt;Ovlp, <span class="number">0</span>, <span class="built_in">sizeof</span>( OVERLAPPED ) );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Request messages from the filter driver.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            hr = <span class="built_in">FilterGetMessage</span>( port,</span><br><span class="line">                                   &amp;msg-&gt;MessageHeader,</span><br><span class="line">                                   <span class="built_in">FIELD_OFFSET</span>( SCANNER_MESSAGE, Ovlp ),</span><br><span class="line">                                   &amp;msg-&gt;Ovlp );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hr != <span class="built_in">HRESULT_FROM_WIN32</span>( ERROR_IO_PENDING )) &#123;</span><br><span class="line">                <span class="keyword">goto</span> main_cleanup;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hr = S_OK;</span><br><span class="line">    </span><br><span class="line">main_cleanup:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (INT i = <span class="number">0</span>; threads[i] != <span class="literal">NULL</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">WaitForSingleObjectEx</span>(threads[i], INFINITE, FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;Scanner:  All done. Result = 0x%08x\n&quot;</span>, hr );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CloseHandle</span>( port );</span><br><span class="line">    <span class="built_in">CloseHandle</span>( completion );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(messages);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里注意一下就是说：</p>
<p>驱动发送的数据是<code>SCANNER_NOTIFICATION</code>结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用 FltSendMessage 将 notification 发送到用户模式（通过 ClientPort）。用户模式应用程序负责扫描缓冲区中的内容，返回一个 SCANNER_REPLY。</span></span><br><span class="line">status = <span class="built_in">FltSendMessage</span>( </span><br><span class="line">    ScannerData.Filter,</span><br><span class="line">    &amp;ScannerData.ClientPort,</span><br><span class="line">    notification,</span><br><span class="line">    <span class="built_in">sizeof</span>( SCANNER_NOTIFICATION ),</span><br><span class="line">    notification,</span><br><span class="line">    &amp;replyLength,</span><br><span class="line">    <span class="literal">NULL</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>但是在三环是这样提取的 , message指向实际的消息内容,minifliter把SCANNER_NOTIFICATION封装在SCANNER_MESSAGE里面了，需要提取出来。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">result = <span class="built_in">GetQueuedCompletionStatus</span>(</span><br><span class="line">    Context-&gt;Completion, </span><br><span class="line">    &amp;outSize, </span><br><span class="line">    &amp;key, </span><br><span class="line">    &amp;pOvlp,</span><br><span class="line">    INFINITE </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">message = <span class="built_in">CONTAINING_RECORD</span>( pOvlp, SCANNER_MESSAGE, Ovlp );</span><br></pre></td></tr></table></figure>









<h2 id="注册表回调整体框架"><a href="#注册表回调整体框架" class="headerlink" title="注册表回调整体框架"></a>注册表回调整体框架</h2><p>在64位系统下，我们不用Hook去监控注册表了，我们选择用回调</p>
<p>利用<code>CmRegisterCallbackEx</code>我们可以注册监控注册表的回调例程，实现一系列Pre Post操作</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(IN PDRIVER_OBJECT DriverObject, IN PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">CmRegisterCallbackEx</span>(</span><br><span class="line">        MyRegCallback,</span><br><span class="line">        &amp;uAltitude,</span><br><span class="line">        DriverObject,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;g_RegCookie,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyRegCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PVOID CallbackContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt PVOID Argument1, <span class="comment">// REG_NOTIFY_CLASS</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt PVOID Argument2  <span class="comment">// KEY_INFORMATION</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> ((REG_NOTIFY_CLASS)Argument1) &#123;</span><br><span class="line">        <span class="keyword">case</span> RegNtPreDeleteKey:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">HOOK_PreNtDeleteKey</span>((PREG_DELETE_KEY_INFORMATION)Argument2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RegNtPreRenameKey:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">HOOK_PreNtRenameKey</span>((PREG_RENAME_KEY_INFORMATION)Argument2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RegNtPreCreateKeyEx: <span class="comment">// pre 操作</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">HOOK_PreNtCreateKeyEx</span>((PREG_CREATE_KEY_INFORMATION)Argument2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RegNtPostCreateKeyEx: <span class="comment">// post 操作</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">HOOK_PostNtCreateKeyEx</span>((PREG_POST_OPERATION_INFORMATION)Argument2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">HOOK_PreNtDeleteKey</span><span class="params">(PREG_DELETE_KEY_INFORMATION Data)</span> </span>&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    UNICODE_STRING keyName;</span><br><span class="line">    UNICODE_STRING uTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Custom logic here...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h2 id="SandBox工作原理"><a href="#SandBox工作原理" class="headerlink" title="SandBox工作原理"></a>SandBox工作原理</h2><h3 id="路径的概念"><a href="#路径的概念" class="headerlink" title="路径的概念"></a>路径的概念</h3><p>沙盒根目录：<code>\device\harddiskvolume1\sandbox</code><br>想操作路径：<code>\device\harddiskvolume2\doc\hi.txt</code></p>
<p>当我们想要把一个应用程序放入沙盒中以后，如果我们想要操作<code>\device\harddiskvolume2\doc\hi.txt</code>，沙盒会自动将这个重定向，转变为操作<code>\device\harddiskvolume1\sandbox\device\harddiskvolume2\doc\hi.txt</code>，这样恶意程序就无法改动原来想要改动的目标，进而攻击失败</p>
<p>而且一旦中毒，我们也只需要删除掉 sandbox 这个文件夹即可，如果写得好，病毒是不会突破沙盒的</p>
<h3 id="文件重定向"><a href="#文件重定向" class="headerlink" title="文件重定向"></a>文件重定向</h3><p>Windows的I&#x2F;O管理器提供了一个方便的方法来重定向一个文件对象，通常会使用文件过滤驱动（在文件打开和文件创建的操作中）实现该方法，操作方法如下：</p>
<p>1.在<code>IRP_MJ_CREATE</code>的分发函数中，获得<code>FILE_OBJECT</code>的<code>FileName</code>属性</p>
<p>2.用目标文件的完整路径替换掉原有的文件名字</p>
<p>3.设置IoStatus的status字段为<code>STATUS_REPARSE</code>，然后设置<code>Information</code>字段为<code>IO_REPARSE</code></p>
<p>4.完成该IRP请求</p>
<p>5.返回STATUS_REPARSE</p>
<p>I&#x2F;O管理器在接收到该返回以后，便会触发另一个文件打开操作，并发送一个<code>IRP_MJ_CREATE</code>的请 求</p>
<p>拦截<code>IRP_MJ_CREATE</code>示例代码，注意这是Minifilter</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">SbRedirectFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PCFLT_RELATED_OBJECTS FltObjects,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUNICODE_STRING pUstrDstFileName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PFILE_OBJECT pFileObject;</span><br><span class="line"></span><br><span class="line">    pFileObject = Data-&gt;Iopb-&gt;TargetFileObject;</span><br><span class="line">    <span class="keyword">if</span> (pFileObject == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pFileObject-&gt;FileName.Length &gt; <span class="number">0</span> &amp;&amp; pFileObject-&gt;FileName.Buffer != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ExFreePool</span>(pFileObject-&gt;FileName.Buffer);</span><br><span class="line">        pFileObject-&gt;FileName.Buffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pFileObject-&gt;FileName = *pUstrDstFileName;</span><br><span class="line">    pFileObject-&gt;RelatedFileObject = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    Data-&gt;IoStatus.Status = STATUS_REPARSE;</span><br><span class="line">    Data-&gt;IoStatus.Information = IO_REPARSE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">FltSetCallbackDataDirty</span>(Data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_REPARSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>主要逻辑</strong>：</p>
<ol>
<li><p><strong>检查目标文件对象是否为空</strong>：</p>
<ul>
<li>从 <code>Data-&gt;Iopb-&gt;TargetFileObject</code> 获取目标文件对象。</li>
<li>如果为空，则直接返回 <code>STATUS_INVALID_PARAMETER</code>。</li>
</ul>
</li>
<li><p><strong>释放旧的文件名内存</strong>：</p>
<ul>
<li>如果目标文件对象的 <code>FileName</code> 字段存在有效的内存缓冲区，则释放该内存并清空指针。</li>
</ul>
</li>
<li><p><strong>设置新的文件名</strong>：</p>
<ul>
<li>将目标文件对象的 <code>FileName</code> 字段设置为新的文件名（<code>pUstrDstFileName</code>）。</li>
<li>将 <code>RelatedFileObject</code> 字段清空。</li>
</ul>
</li>
<li><p><strong>标记为重解析操作</strong>：</p>
<ul>
<li>修改 <code>IoStatus.Status</code> 为 <code>STATUS_REPARSE</code>，表示当前请求需要重新解析。</li>
<li>设置 <code>IoStatus.Information</code> 为 <code>IO_REPARSE</code>，进一步说明是重解析请求。</li>
</ul>
</li>
<li><p><strong>通知 MiniFilter 处理的数据已被修改</strong>：</p>
<ul>
<li><p>调用 <code>FltSetCallbackDataDirty</code>，告诉过滤管理器 <code>Data</code> 数据结构已经被修改，需要重新处理。否则修改是无效的</p>
<p>来自微软官方文档：( 微筛选器驱动程序的预操作或操作后 回调例程可以修改回调数据的内容结构。 如果已更改，则它必须调用 <strong>FltSetCallbackDataDirty</strong> ，除非它已更改回调数据结构的 <strong>IoStatus</strong> 字段的内容。 )</p>
</li>
</ul>
</li>
<li><p><strong>返回重解析状态</strong>：</p>
<ul>
<li>返回 <code>STATUS_REPARSE</code>，让系统重新解析文件路径。</li>
</ul>
</li>
</ol>
<h3 id="CreatePre需要做的事"><a href="#CreatePre需要做的事" class="headerlink" title="CreatePre需要做的事"></a>CreatePre需要做的事</h3><p>一.首先判断该进程是否需要SANDBOX</p>
<p>二.获取被沙盒的文件操作的文件名（通过PID,文件名等判断是否该进程需要在沙盒运行）在这里需要获取两个文件名，一个是沙盒内部的，一个是沙盒外部的</p>
<p>三.判断沙盒里是否含有该文件的.del文件，如果有，则按照是否来自沙盒内的请求和是否改变文件进行处理</p>
<p>分以下情形：</p>
<p>1.如果说是要在沙箱外面操作创建或改变文件，那么就重定向到内部</p>
<p>2.如果说是要在沙箱里面操作创建或改变文件，那么就删除该标志文件，交给文件系统去创建</p>
<p>3.只读操作该文件，含有删除标志，访问失败</p>
<p>四：如果沙盒里面存在该文件，且请求来自沙盒，就交给文件系统进行处理。请求来自外面，重解析到里面</p>
<p>五：如果操作不改变文件，但是沙盒里面没有这个文件，并且请求来自沙盒，则重定向到外面，让它访问也无妨；如果沙盒有这个文件，那就交给文件系统去处理，我们不必处理</p>
<p>六：如果操作改变文件，且沙盒里面没有这个文件，那么就准备路径，如果沙盒外面有这个文件，就拷贝进来</p>
<h3 id="DeleteFile需要做的事"><a href="#DeleteFile需要做的事" class="headerlink" title="DeleteFile需要做的事"></a>DeleteFile需要做的事</h3><p>删除文件时会发送 <code>IRP_MJ_SET_INFORMATION</code> 这个 IRP。 </p>
<p>所以我们要监控这个IRP</p>
<p>一：首先要获取一下文件的路径</p>
<p>二：判断是来自沙盒的外面还是里面</p>
<p>三：如果是外面的路径，就转为里面的路径，也就是不删除外面的文件，而是在里面设置一个删除的标志</p>
<p>四：如果是里面的路径，就先获取外面的路径，<br>        如果外面这个路径不存在，就直接删除里面的文件，<br>        如果外面存在，就在里面建立一个删除的标志，并删除。</p>
<h3 id="QueryDir需要做的事"><a href="#QueryDir需要做的事" class="headerlink" title="QueryDir需要做的事"></a>QueryDir需要做的事</h3><p>查询文件夹发起的IRP请求是：<code>IRP_MJ_DIRECTORY_CONTROL</code></p>
<p>为了确保删除掉的文件不会再被恶意程序检测到，我们要做的是</p>
<p>一：首先确定是否需要沙盒</p>
<p>二：获取文件名（沙盒内和沙盒外都要）</p>
<p>三：在沙箱中去掉含删除标志的文件，在外面的路径去掉含删除文件的标志，然后合并这两个部分</p>
<h3 id="关于IRP-MJ-WRITE是否要重定向"><a href="#关于IRP-MJ-WRITE是否要重定向" class="headerlink" title="关于IRP_MJ_WRITE是否要重定向"></a>关于IRP_MJ_WRITE是否要重定向</h3><p>其实是不需要重定向的，因为前面在CreatePre的时候已经重定向过了</p>
<h2 id="对示例SandBox分析"><a href="#对示例SandBox分析" class="headerlink" title="对示例SandBox分析"></a>对示例SandBox分析</h2><p>分析项目： <a target="_blank" rel="noopener" href="https://github.com/haidragon/minifilter/tree/master/Sandbox">minifilter&#x2F;Sandbox at master · haidragon&#x2F;minifilter</a> </p>
<p>分析写在注释上</p>
<p>首先是入口函数<code>DriverEntry</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//驱动程序入口，完成各种初始化工作，创建设备对象</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDRIVER_OBJECT pDriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUNICODE_STRING pRegistryPath)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS 		ntStatus;</span><br><span class="line">	PDEVICE_OBJECT 	pDevObj;</span><br><span class="line">	UNICODE_STRING 	uDevName;</span><br><span class="line">	UNICODE_STRING 	uLinkName;</span><br><span class="line">	PROCESS_LIST_ENTRY *pPROCESS_LIST_ENTRYEntry;</span><br><span class="line">	<span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Load begin!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ExInitializeFastMutex</span>(&amp;g_PROCESS_LIST_ENTRYListLock);</span><br><span class="line">	<span class="built_in">InitializeListHead</span>(&amp;g_PROCESS_LIST_ENTRYList);</span><br><span class="line"></span><br><span class="line">	pPROCESS_LIST_ENTRYEntry = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="built_in">sizeof</span>(PROCESS_LIST_ENTRY), <span class="string">&#x27;XBBS&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pPROCESS_LIST_ENTRYEntry == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlZeroMemory</span>(pPROCESS_LIST_ENTRYEntry, <span class="built_in">sizeof</span>(PROCESS_LIST_ENTRY));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">wcscpy</span>(pPROCESS_LIST_ENTRYEntry-&gt;NameBuffer, <span class="string">L&quot;notepad.exe&quot;</span>);</span><br><span class="line">	<span class="built_in">InsertHeadList</span>(&amp;g_PROCESS_LIST_ENTRYList, &amp;pPROCESS_LIST_ENTRYEntry-&gt;Entry);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	pPROCESS_LIST_ENTRYEntry = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="built_in">sizeof</span>(PROCESS_LIST_ENTRY), <span class="string">&#x27;XBBS&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pPROCESS_LIST_ENTRYEntry == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlZeroMemory</span>(pPROCESS_LIST_ENTRYEntry, <span class="built_in">sizeof</span>(PROCESS_LIST_ENTRY));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">wcscpy</span>(pPROCESS_LIST_ENTRYEntry-&gt;NameBuffer, <span class="string">L&quot;iexplore.exe&quot;</span>);</span><br><span class="line">	<span class="built_in">InsertHeadList</span>(&amp;g_PROCESS_LIST_ENTRYList, &amp;pPROCESS_LIST_ENTRYEntry-&gt;Entry);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	ntStatus = <span class="built_in">initFileMonitor</span>(pDriverObject);<span class="comment">//注册过滤器</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(! <span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">		<span class="keyword">return</span> ntStatus;</span><br><span class="line">	</span><br><span class="line">	ntStatus = <span class="built_in">initIPC</span>( );<span class="comment">//建立minifilter内核和用户通讯</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(! <span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">stopMiniMonitor</span>( );</span><br><span class="line">		<span class="keyword">return</span> ntStatus;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sandbox一些赋值操作</span></span><br><span class="line">	<span class="built_in">InitSb</span>();</span><br><span class="line"></span><br><span class="line">	ntStatus = <span class="built_in">startMiniMonitor</span>( );<span class="comment">////启动过滤器</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(! <span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">stopMiniMonitor</span>( );</span><br><span class="line">		<span class="built_in">closeIPC</span>( );</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化各个例程</span></span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_CREATE] =</span><br><span class="line">				DispatchCreate;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] =</span><br><span class="line">				DispatchClose;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_WRITE] =</span><br><span class="line">				DispatchWrite;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_READ] =</span><br><span class="line">				DispatchRead;</span><br><span class="line">	pDriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]  = </span><br><span class="line">				DispatchControl;</span><br><span class="line">	pDriverObject-&gt;DriverUnload	= </span><br><span class="line">				DriverUnload;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uDevName, DEVICE_NAME);</span><br><span class="line">	<span class="comment">//创建驱动设备</span></span><br><span class="line">	ntStatus = <span class="built_in">IoCreateDevice</span>( pDriverObject,</span><br><span class="line">			<span class="number">0</span>,<span class="comment">//sizeof(DEVICE_EXTENSION)</span></span><br><span class="line">			&amp;uDevName,</span><br><span class="line">			FILE_DEVICE_SANDBOX,</span><br><span class="line">			<span class="number">0</span>, TRUE,</span><br><span class="line">			&amp;pDevObj );</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">DbgPrint</span>(<span class="string">&quot;IoCreateDevice Failed:%x\n&quot;</span>, ntStatus);</span><br><span class="line">		<span class="keyword">return</span> ntStatus;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pDevObj-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uLinkName, LINK_NAME);</span><br><span class="line">	<span class="comment">//创建符号链接</span></span><br><span class="line">	ntStatus = <span class="built_in">IoCreateSymbolicLink</span>( &amp;uLinkName,</span><br><span class="line">		    &amp;uDevName );</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(ntStatus)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//STATUS_INSUFFICIENT_RESOURCES 	资源不足</span></span><br><span class="line">		<span class="comment">//STATUS_OBJECT_NAME_EXISTS 		指定对象名存在</span></span><br><span class="line">		<span class="comment">//STATUS_OBJECT_NAME_COLLISION 	对象名有冲突</span></span><br><span class="line">		<span class="built_in">DbgPrint</span>(<span class="string">&quot;IoCreateSymbolicLink Failed:%x\n&quot;</span>, ntStatus);</span><br><span class="line">		<span class="built_in">IoDeleteDevice</span>( pDevObj );</span><br><span class="line">		<span class="keyword">return</span> ntStatus;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">DbgPrint</span>(<span class="string">&quot;Driver Load success!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> ntStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DriverEntry</code>主要就是注册了Minifilter</p>
<p>然后是minifilter的连接，断连，通讯三个回调，但是由于过于简单，这里就不分析了</p>
<h3 id="CreatePre"><a href="#CreatePre" class="headerlink" title="CreatePre"></a>CreatePre</h3><p>接下来就是重头戏，也就是CreatePre的分析，写在注释上了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//功能: 根据沙箱名称和注册表标志，获取沙箱路径。</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">sbPreCreateFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	IN OUT PFLT_CALLBACK_DATA Data,</span></span></span><br><span class="line"><span class="params"><span class="function">	IN PCFLT_RELATED_OBJECTS FltObjects</span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	NTSTATUS		ntStatus = STATUS_SUCCESS;</span><br><span class="line">	ULONG			ulDisposition = <span class="number">0</span>;</span><br><span class="line">	BOOLEAN 		bNeedFree		= FALSE;</span><br><span class="line">	BOOLEAN			bDir  = FALSE;</span><br><span class="line">	BOOLEAN			bIsRename		= FALSE;</span><br><span class="line">	BOOLEAN			bIsHardLink   = TRUE;</span><br><span class="line">	BOOLEAN			bCreateFile	= FALSE;</span><br><span class="line">	PWCHAR			pFileName = <span class="literal">NULL</span>;</span><br><span class="line">	PEPROCESS		pEprocess = <span class="built_in">PsGetCurrentProcess</span>();</span><br><span class="line">	PACCESS_STATE	accessState;</span><br><span class="line">	PFILE_OBJECT	OutFileObject = <span class="literal">NULL</span>;</span><br><span class="line">	PFLT_INSTANCE	pOutVolumeInstance = <span class="literal">NULL</span>;</span><br><span class="line">	UNICODE_STRING	ustrDstFile = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	UNICODE_STRING  ustrSrcFile = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	UNICODE_STRING	ustrDeledName = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	PUNICODE_STRING pInName = <span class="literal">NULL</span>;</span><br><span class="line">	PUNICODE_STRING pOutName = <span class="literal">NULL</span>;</span><br><span class="line">	BOOLEAN			bReparsed = FALSE;</span><br><span class="line">	BOOLEAN			bReqInSandbox = FALSE; </span><br><span class="line">	ACCESS_MASK		AccessMask = <span class="number">0</span>;</span><br><span class="line">	PFLT_FILE_NAME_INFORMATION		pNameInfo = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	Data-&gt;IoStatus.Status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	accessState = Data-&gt;Iopb-&gt;Parameters.Create.SecurityContext-&gt;AccessState;</span><br><span class="line">	</span><br><span class="line">	__try</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>((<span class="built_in">ExGetPreviousMode</span>() == KernelMode) ||</span><br><span class="line">		   (<span class="built_in">KeGetCurrentIrql</span>() &gt; APC_LEVEL) ||</span><br><span class="line">		   (pEprocess == <span class="literal">NULL</span>) ||</span><br><span class="line">		   (pEprocess == g_pProcessObject))</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">SbShouldBeSandBoxed</span>(<span class="built_in">PsGetProcessId</span>(pEprocess)))<span class="comment">//看是否应该在沙盒里面进行处理，如果不需要，直接返回，不需要下面的步骤，我们只关心特定进程</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(g_SbVolInstance == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			g_SbVolInstance = <span class="built_in">SbGetVolumeInstance</span>(gp_Filter, &amp;g_ustrVolumeDeviceName);	<span class="comment">//获取卷设备对象</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(g_SbVolInstance == <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line"></span><br><span class="line">				ntStatus = STATUS_SUCCESS;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(FltObjects-&gt;FileObject-&gt;Flags &amp; FO_VOLUME_OPEN)</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = STATUS_SUCCESS;</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//AccessMask 是一个权限掩码，用于表示对文件或对象的访问权限需求。</span></span><br><span class="line">		AccessMask = Data-&gt;Iopb-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess;</span><br><span class="line"></span><br><span class="line">		bIsRename = (AccessMask == (SYNCHRONIZE | FILE_READ_ATTRIBUTES | DELETE));</span><br><span class="line">		bIsHardLink = (AccessMask == (SYNCHRONIZE | FILE_WRITE_DATA));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取操作文件的具体信息</span></span><br><span class="line">		<span class="keyword">if</span>(!bIsRename &amp;&amp; !bIsHardLink)</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = <span class="built_in">FltGetFileNameInformation</span>(Data,</span><br><span class="line">											FLT_FILE_NAME_NORMALIZED | FLT_FILE_NAME_QUERY_DEFAULT,</span><br><span class="line">											&amp;pNameInfo);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">FltParseFileNameInformation</span>(pNameInfo);</span><br><span class="line">		    &#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> ( bIsRename || bIsHardLink || !<span class="built_in">NT_SUCCESS</span>(ntStatus ))</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = <span class="built_in">SbGetFileNameInformation</span>(FltObjects-&gt;Volume,</span><br><span class="line">												FltObjects-&gt;Instance,</span><br><span class="line">												FltObjects-&gt;FileObject,</span><br><span class="line">												FALSE,</span><br><span class="line">												&amp;pNameInfo);</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				bNeedFree = TRUE;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//----------------------------------------------------------------------------------------------------------</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">/*pNameInfo-&gt;Name 是文件对象的完整路径名，例如 \Device\HarddiskVolume1\test.txt。</span></span><br><span class="line"><span class="comment">			pNameInfo-&gt;Volume 是文件所在卷的设备路径，例如 \Device\HarddiskVolume1</span></span><br><span class="line"><span class="comment">			如果请求目标是整个卷，意味着这是一个对卷级别的操作（例如挂载、卸载、卷属性查询等）。</span></span><br><span class="line"><span class="comment">		对于这种请求，文件过滤器通常不需要干预，因为它们不涉及具体的文件操作。*/</span></span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">RtlCompareUnicodeString</span>(&amp;pNameInfo-&gt;Name, &amp;pNameInfo-&gt;Volume, TRUE))</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = STATUS_SUCCESS;</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		<span class="comment">//提取后缀，如果后缀是.rem，说明是想创建或者操作这个已经被删除的文件，就返回找不到句柄，直接退出try块</span></span><br><span class="line">		<span class="keyword">if</span>(pNameInfo-&gt;Name.Length &gt;= <span class="built_in">sizeof</span>(WCHAR)*DEL_LENGTH &amp;&amp;</span><br><span class="line">			!_wcsnicmp(pNameInfo-&gt;Name.Buffer+pNameInfo-&gt;Name.Length/<span class="built_in">sizeof</span>(WCHAR)-DEL_LENGTH, </span><br><span class="line">			DEL_MARK, DEL_LENGTH))</span><br><span class="line">		&#123;</span><br><span class="line">			Data-&gt;IoStatus.Status = STATUS_OBJECT_NAME_NOT_FOUND;</span><br><span class="line">			Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">			ntStatus = STATUS_OBJECT_NAME_NOT_FOUND;</span><br><span class="line">			__leave; </span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">		<span class="comment">//获取沙盒内，沙盒外各自的路径</span></span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">RtlPrefixUnicodeString</span>(&amp;g_SandboxPath, &amp;pNameInfo-&gt;Name, TRUE)) <span class="comment">//RtlPrefixUnicodeString比较两个 Unicode 字符串，以确定一个字符串是否为另一个字符串的前缀。</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//进入if代表是来自外面的请求</span></span><br><span class="line">			ntStatus = <span class="built_in">SbConvertToSbName</span>(&amp;g_SandboxPath, &amp;pNameInfo-&gt;Name, &amp;ustrDstFile, <span class="literal">NULL</span>);<span class="comment">//转换为内部请求</span></span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;	</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			pInName  = &amp;ustrDstFile;</span><br><span class="line">			pOutName = &amp;pNameInfo-&gt;Name;</span><br><span class="line">			pOutVolumeInstance = FltObjects-&gt;Instance;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//来自内部请求，转化一下，获得外部路径</span></span><br><span class="line">			UNICODE_STRING ustrVolName = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">			ustrVolName.Buffer = (PWCHAR)<span class="built_in">MyNew</span>(BYTE, <span class="built_in">sizeof</span>(WCHAR)*MAX_PATH);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(ustrVolName.Buffer == <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ustrVolName.MaximumLength = <span class="built_in">sizeof</span>(WCHAR)*MAX_PATH;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//将沙盒的内部路径转为外部路径</span></span><br><span class="line">			ntStatus = <span class="built_in">SbConvertInSbNameToOutName</span>(gp_Filter,</span><br><span class="line">				&amp;pNameInfo-&gt;Name, </span><br><span class="line">				&amp;g_SandboxPath, </span><br><span class="line">				&amp;ustrSrcFile, </span><br><span class="line">				&amp;ustrVolName);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">MyDelete</span>(ustrVolName.Buffer);</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ustrDstFile.Buffer = <span class="built_in">MyNew</span>(WCHAR, pNameInfo-&gt;Name.Length/<span class="built_in">sizeof</span>(WCHAR)); </span><br><span class="line">			<span class="keyword">if</span>(ustrDstFile.Buffer == <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">MyDelete</span>(ustrVolName.Buffer);</span><br><span class="line">				ntStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ustrDstFile.Length = <span class="number">0</span>;</span><br><span class="line">			ustrDstFile.MaximumLength = pNameInfo-&gt;Name.Length;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">RtlCopyUnicodeString</span>(&amp;ustrDstFile, &amp;pNameInfo-&gt;Name); </span><br><span class="line">			pInName = &amp;ustrDstFile;<span class="comment">//存沙箱内路径</span></span><br><span class="line">			pOutName = &amp;ustrSrcFile;<span class="comment">//存沙箱外路径</span></span><br><span class="line">			pOutVolumeInstance = <span class="built_in">SbGetVolumeInstance</span>(gp_Filter, &amp;ustrVolName);<span class="comment">//获取卷实例</span></span><br><span class="line">			<span class="built_in">MyDelete</span>(ustrVolName.Buffer);</span><br><span class="line">			<span class="keyword">if</span> (pOutVolumeInstance == <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">			bReqInSandbox = TRUE;</span><br><span class="line">		&#125;		</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">		<span class="comment">//这里是判断这个IRP_MJ_CREATE想要干啥，是创建还是删除等等，顺便把如果删除的话，文件名后缀加一个.rem</span></span><br><span class="line">		ustrDeledName.MaximumLength = pInName-&gt;Length + DEL_LENGTH*<span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">		ustrDeledName.Buffer = <span class="built_in">MyNew</span>(WCHAR, ustrDeledName.MaximumLength/<span class="built_in">sizeof</span>(WCHAR));</span><br><span class="line">		<span class="keyword">if</span>(ustrDeledName.Buffer == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">			Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">			Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ulDisposition = (Data-&gt;Iopb-&gt;Parameters.Create.Options &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x000000ff</span>;</span><br><span class="line">		bCreateFile = (BOOLEAN)((ulDisposition == FILE_CREATE) ||</span><br><span class="line">	                                 (ulDisposition == FILE_OPEN_IF) ||</span><br><span class="line">	                                 (ulDisposition == FILE_OVERWRITE_IF) ||</span><br><span class="line">	                                 (ulDisposition == FILE_SUPERSEDE));</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">RtlCopyUnicodeString</span>(&amp;ustrDeledName, pInName);</span><br><span class="line">		<span class="built_in">RtlAppendUnicodeToString</span>(&amp;ustrDeledName, DEL_MARK);</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------------------------------------</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">SbFileExist</span>(gp_Filter, g_SbVolInstance, &amp;ustrDeledName))<span class="comment">//判断后缀是.rem的文件是否存在</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(bCreateFile ||<span class="built_in">SbOperWillModifyFile</span>(AccessMask)) <span class="comment">//如果是创建或者要改变该文件</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="built_in">SbFileExist</span>(gp_Filter,g_SbVolInstance, pInName)) <span class="comment">//内部不存在该文件</span></span><br><span class="line">				&#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//如果内部没有这个文件，那么造出一个路径出来</span></span><br><span class="line">					ntStatus = <span class="built_in">SbPrepareSandboxPath</span>(</span><br><span class="line">								gp_Filter,</span><br><span class="line">								g_SbVolInstance,</span><br><span class="line">								&amp;g_SandboxPath,</span><br><span class="line">								pInName,</span><br><span class="line">								AccessMask);</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>(! <span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">					&#123;</span><br><span class="line">						Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">						Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">						</span><br><span class="line">						__leave;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (! bReqInSandbox)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//来自外面请求，重定向创建该文件</span></span><br><span class="line">						ntStatus = <span class="built_in">SbRedirectFile</span>(Data,</span><br><span class="line">											FltObjects,</span><br><span class="line">											pInName);</span><br><span class="line">						<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">						&#123;</span><br><span class="line">							ntStatus = STATUS_SB_TRY_REPARSE;</span><br><span class="line">							__leave;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span>(!<span class="built_in">SBDeleteOneFile</span>(g_SbVolInstance, gp_Filter, <span class="literal">NULL</span>, &amp;ustrDeledName)) <span class="comment">//来自内部，删除.rem的标志，相当于创建了</span></span><br><span class="line">						&#123;</span><br><span class="line">							ntStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">							Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">							Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">							__leave;</span><br><span class="line">						&#125;</span><br><span class="line">						</span><br><span class="line">						ntStatus = STATUS_SUCCESS; <span class="comment">//让文件系统执行</span></span><br><span class="line">						__leave;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="comment">//表明访问了一个打了删除标志的文件，而且不是创建或者修改，可能是只读取 或 查询文件属性 的操作</span></span><br><span class="line">			&#123;</span><br><span class="line"></span><br><span class="line">				Data-&gt;IoStatus.Status = STATUS_OBJECT_NAME_NOT_FOUND;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				ntStatus = STATUS_OBJECT_NAME_NOT_FOUND;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="comment">//如果文件不存在</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(bReqInSandbox) <span class="comment">//来自于内部请求</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(!<span class="built_in">SbFileExist</span>(FltObjects-&gt;Filter, pOutVolumeInstance, pOutName) )<span class="comment">//外面不存在，直接交给文件系统创建</span></span><br><span class="line">				&#123;</span><br><span class="line">					ntStatus = STATUS_SUCCESS;</span><br><span class="line">					__leave;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//如果来自外部请求，这里啥也没做，看来是默认交给I/O管理器了？</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//里面文件存在，记住这回不是.rem文件了，是真正的文件</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">SbFileExist</span>(gp_Filter, g_SbVolInstance, pInName) )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bReqInSandbox)<span class="comment">//来自里面的请求，直接交给文件系统</span></span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = STATUS_SUCCESS;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//如果是来自外部请求，那么重定向文件</span></span><br><span class="line">			ntStatus = <span class="built_in">SbRedirectFile</span>(Data,</span><br><span class="line">								FltObjects,</span><br><span class="line">								pInName);</span><br><span class="line">		</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = STATUS_SB_TRY_REPARSE;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//沙盒里面文件不存在情况的处理</span></span><br><span class="line">		<span class="keyword">if</span>(!bCreateFile &amp;&amp; !<span class="built_in">SbOperWillModifyFile</span>(AccessMask))<span class="comment">//如何理解“不创建文件且不修改文件”的情况？一种 只读取 或 查询文件属性 的操作。这类操作通常需要打开文件，但是不涉及对文件内容的修改。IRP_MJ_CREATE 请求在这种情况下是必要的，因为文件需要被打开（即使不进行修改）。</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bReqInSandbox)<span class="comment">//来自里面的请求，就重定向到外面，反正也不影响</span></span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = <span class="built_in">SbRedirectFile</span>(Data,</span><br><span class="line">									FltObjects,</span><br><span class="line">									pOutName);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">				&#123;</span><br><span class="line">					ntStatus = STATUS_SB_TRY_REPARSE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">					Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//这里不用多写，直接交给I/O管理器即可</span></span><br><span class="line">			&#125;</span><br><span class="line">			ntStatus = STATUS_SUCCESS;</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//里面文件不存在，需要修改和创建该文件</span></span><br><span class="line">		ntStatus = <span class="built_in">SbPrepareSandboxPath</span>(</span><br><span class="line">								gp_Filter,</span><br><span class="line">								g_SbVolInstance,</span><br><span class="line">								&amp;g_SandboxPath,</span><br><span class="line">								pInName,</span><br><span class="line">								Data-&gt;Iopb-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess);</span><br><span class="line">					</span><br><span class="line">		<span class="keyword">if</span>(! <span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">			Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">			Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">			__leave;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(bReqInSandbox || <span class="built_in">SbFileExist</span>( FltObjects-&gt;Filter, pOutVolumeInstance, pOutName) )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//如果是来自内部请求，并且外部文件存在，则拷贝进来</span></span><br><span class="line">			ntStatus = <span class="built_in">SbIsDirectory</span>(<span class="literal">NULL</span>, pOutName, FltObjects-&gt;Filter, pOutVolumeInstance, &amp;bDir);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">				Data-&gt;IoStatus.Information = <span class="number">0</span>; </span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			ntStatus = <span class="built_in">SbCopyFile</span>(gp_Filter,</span><br><span class="line">								pOutVolumeInstance,</span><br><span class="line">								<span class="literal">NULL</span>,</span><br><span class="line">								pOutName,</span><br><span class="line">								g_SbVolInstance,</span><br><span class="line">								pInName,</span><br><span class="line">								bDir);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(ntStatus != STATUS_SB_DIR_CREATED)</span><br><span class="line">				&#123;</span><br><span class="line">					Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">					Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">					__leave;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(bReqInSandbox)</span><br><span class="line">			&#123;</span><br><span class="line">				ntStatus = STATUS_SUCCESS;</span><br><span class="line">				__leave;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//重定向到里面</span></span><br><span class="line">		ntStatus = <span class="built_in">SbRedirectFile</span>(Data,</span><br><span class="line">								FltObjects,</span><br><span class="line">								pInName);</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">		&#123;</span><br><span class="line">			ntStatus = STATUS_SB_TRY_REPARSE;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Data-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">			Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">			</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	__except(EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//释放资源</span></span><br><span class="line">	<span class="keyword">if</span>(pNameInfo != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(bNeedFree)</span><br><span class="line">			<span class="built_in">MyDelete</span>(pNameInfo);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">FltReleaseFileNameInformation</span>(pNameInfo);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(ustrDeledName.Buffer != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">MyDelete</span>(ustrDeledName.Buffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(ntStatus == STATUS_SB_TRY_REPARSE)</span><br><span class="line">	&#123;</span><br><span class="line">		Data-&gt;IoStatus.Status = STATUS_REPARSE;</span><br><span class="line">		Data-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(ustrDstFile.Buffer != <span class="literal">NULL</span> &amp;&amp; ntStatus != STATUS_SB_TRY_REPARSE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ExFreePool</span>(ustrDstFile.Buffer);</span><br><span class="line">		ustrDstFile.Buffer = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(OutFileObject)</span><br><span class="line">		<span class="built_in">ObDereferenceObject</span>(OutFileObject);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ntStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="WritePre"><a href="#WritePre" class="headerlink" title="WritePre"></a>WritePre</h3><p>注释被我手贱删了….</p>
<p>下次有分析再说吧</p>
<p>无非就是分那几种情况</p>
<h2 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h2><p>好像卸载再安装容易蓝屏…..</p>
<p>另外每个电脑的的盘符信息不一样，例如我的C盘是HardDiskVolume3，全局变量记得改一下</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Ccai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/Minifilter/">http://example.com/Minifilter/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Cc12138's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Minifilter/">Minifilter</a></div><div class="post_share"><div class="social-share" data-image="/img/WangFei2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/windows%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" title="Windows应急响应(持续更新)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows应急响应(持续更新)</div></div></a></div><div class="next-post pull-right"><a href="/Qt%E6%A1%86%E6%9E%B6/" title="QT开发框架(持续更新)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">QT开发框架(持续更新)</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/WangFei2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ccai</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">72</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/0xcc12138" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">ROIS Team Member</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Minifilter"><span class="toc-number">1.</span> <span class="toc-text">Minifilter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Minifilter%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Minifilter简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="toc-number">1.2.</span> <span class="toc-text">总体框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Altitude%E5%80%BC%EF%BC%9A20000%E2%80%93429999"><span class="toc-number">1.3.</span> <span class="toc-text">Altitude值：20000–429999</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Minifilter%E6%9E%B6%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">Minifilter架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pre%E5%9B%9E%E8%B0%83%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">Pre回调：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%EF%BC%9A"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">返回值：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Post%E5%9B%9E%E8%B0%83%EF%BC%9A"><span class="toc-number">1.4.2.</span> <span class="toc-text">Post回调：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%ADData%E6%98%AF%E4%BB%80%E4%B9%88%E6%93%8D%E4%BD%9C%E7%9A%84%E5%AE%8F%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">判断Data是什么操作的宏：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Minifilter%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="toc-number">1.6.</span> <span class="toc-text">Minifilter的启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nullfilter%E5%AE%89%E8%A3%85"><span class="toc-number">1.7.</span> <span class="toc-text">Nullfilter安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inf%E6%96%87%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.7.1.</span> <span class="toc-text">inf文件安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%AE%89%E8%A3%85"><span class="toc-number">1.7.2.</span> <span class="toc-text">可执行程序安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-number">1.8.</span> <span class="toc-text">参数数据的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8EPFLT-CALLBACK-DATA%E8%8E%B7%E5%8F%96"><span class="toc-number">1.8.1.</span> <span class="toc-text">从PFLT_CALLBACK_DATA获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%93%8D%E4%BD%9C%E7%9A%84%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="toc-number">1.8.2.</span> <span class="toc-text">获取操作的文件路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Minifilter%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.9.</span> <span class="toc-text">Minifilter上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%88%86%E7%B1%BB"><span class="toc-number">1.9.1.</span> <span class="toc-text">上下文的介绍和分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">1.9.2.</span> <span class="toc-text">注册上下文的过程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Context%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.9.3.</span> <span class="toc-text">Context的使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#R3%E5%92%8CR0%E7%9A%84%E9%80%9A%E8%AE%AF"><span class="toc-number">1.10.</span> <span class="toc-text">R3和R0的通讯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#R3%E7%BB%99R0%E5%8F%91%E4%BF%A1%E6%81%AF"><span class="toc-number">1.10.1.</span> <span class="toc-text">R3给R0发信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#R0%E7%BB%99R3%E5%8F%91%E4%BF%A1%E6%81%AF"><span class="toc-number">1.10.2.</span> <span class="toc-text">R0给R3发信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#scanner%E5%88%86%E6%9E%90"><span class="toc-number">1.11.</span> <span class="toc-text">scanner分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.11.1.</span> <span class="toc-text">驱动代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E9%A2%84%E8%A7%88"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">函数作用预览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">具体分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%B1%82%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.11.2.</span> <span class="toc-text">用户层代码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%9B%9E%E8%B0%83%E6%95%B4%E4%BD%93%E6%A1%86%E6%9E%B6"><span class="toc-number">1.12.</span> <span class="toc-text">注册表回调整体框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SandBox%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.13.</span> <span class="toc-text">SandBox工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.13.1.</span> <span class="toc-text">路径的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.13.2.</span> <span class="toc-text">文件重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CreatePre%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%BA%8B"><span class="toc-number">1.13.3.</span> <span class="toc-text">CreatePre需要做的事</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DeleteFile%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%BA%8B"><span class="toc-number">1.13.4.</span> <span class="toc-text">DeleteFile需要做的事</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QueryDir%E9%9C%80%E8%A6%81%E5%81%9A%E7%9A%84%E4%BA%8B"><span class="toc-number">1.13.5.</span> <span class="toc-text">QueryDir需要做的事</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EIRP-MJ-WRITE%E6%98%AF%E5%90%A6%E8%A6%81%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.13.6.</span> <span class="toc-text">关于IRP_MJ_WRITE是否要重定向</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E7%A4%BA%E4%BE%8BSandBox%E5%88%86%E6%9E%90"><span class="toc-number">1.14.</span> <span class="toc-text">对示例SandBox分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CreatePre"><span class="toc-number">1.14.1.</span> <span class="toc-text">CreatePre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WritePre"><span class="toc-number">1.14.2.</span> <span class="toc-text">WritePre</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="toc-number">1.15.</span> <span class="toc-text">注意事项：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%8F%90%E5%8D%87%E8%BF%9B%E7%A8%8B%E8%87%B3PPL%E6%9D%83%E9%99%90/" title="将进程提升至PPL权限">将进程提升至PPL权限</a><time datetime="2025-02-05T07:44:00.000Z" title="发表于 2025-02-05 15:44:00">2025-02-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/WDF%E5%AD%A6%E4%B9%A0/" title="WDF框架学习">WDF框架学习</a><time datetime="2025-01-12T15:00:00.000Z" title="发表于 2025-01-12 23:00:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/NDIS,WFP%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4/" title="NDIS/WFP网络过滤">NDIS/WFP网络过滤</a><time datetime="2025-01-12T02:32:00.000Z" title="发表于 2025-01-12 10:32:00">2025-01-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" title="病毒分析">病毒分析</a><time datetime="2025-01-06T14:11:00.000Z" title="发表于 2025-01-06 22:11:00">2025-01-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E7%BD%91%E7%BB%9C%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AFTDI/" title="TDI网络防火墙技术">TDI网络防火墙技术</a><time datetime="2025-01-06T03:28:00.000Z" title="发表于 2025-01-06 11:28:00">2025-01-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Ccai</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>